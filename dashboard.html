<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>êµ¬ëª¬ìˆ˜í•™ êµì‚¬ ëŒ€ì‹œë³´ë“œ</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0908; --surface:#111009; --card:#171512; --border:#222018;
  --text:#d8d0c0; --muted:#6a6258; --accent:#f5a623;
  --green:#1aad6e; --red:#e8401c; --blue:#1a7fd4; --purple:#9b59b6;
  --font:'Noto Sans KR',sans-serif; --mono:'DM Mono',monospace;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column;}

/* â”€â”€ í—¤ë” â”€â”€ */
.header{height:56px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;gap:16px;flex-shrink:0;position:sticky;top:0;z-index:100;}
.header-logo{width:36px;height:36px;border-radius:10px;background:var(--red);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:13px;color:white;}
.header-title{font-size:16px;font-weight:700;color:var(--text);}
.header-sub{font-size:11px;color:var(--muted);font-family:var(--mono);}
.header-spacer{flex:1;}
.header-tabs{display:flex;gap:4px;}
.htab{padding:6px 14px;border-radius:8px;border:none;background:transparent;font-family:var(--font);font-size:12px;font-weight:500;color:var(--muted);cursor:pointer;transition:all 0.15s;}
.htab:hover{background:rgba(255,255,255,0.05);color:var(--text);}
.htab.on{background:rgba(245,166,35,0.12);color:var(--accent);}
.back-btn{padding:6px 14px;border-radius:8px;border:1px solid var(--border);background:none;color:var(--muted);font-size:12px;font-family:var(--font);cursor:pointer;transition:all 0.15s;}
.back-btn:hover{background:var(--card);color:var(--text);}

/* â”€â”€ ë ˆì´ì•„ì›ƒ â”€â”€ */
.main{flex:1;display:flex;overflow:hidden;}
.sidebar{width:220px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:16px 12px;gap:4px;overflow-y:auto;flex-shrink:0;}
.content{flex:1;overflow-y:auto;padding:24px;}

/* â”€â”€ ì‚¬ì´ë“œë°” â”€â”€ */
.sb-section{font-size:10px;font-weight:700;letter-spacing:0.1em;color:var(--muted);padding:8px 10px 4px;text-transform:uppercase;}
.sb-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;cursor:pointer;font-size:13px;color:var(--muted);transition:all 0.15s;border:none;background:none;width:100%;text-align:left;font-family:var(--font);}
.sb-item:hover{background:rgba(255,255,255,0.04);color:var(--text);}
.sb-item.on{background:rgba(245,166,35,0.1);color:var(--accent);}
.sb-item-icon{font-size:15px;width:20px;text-align:center;}
.sb-badge{margin-left:auto;background:var(--red);color:white;border-radius:10px;padding:1px 6px;font-size:10px;font-family:var(--mono);}

/* â”€â”€ ì¹´ë“œ â”€â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:16px;}
.card-title{font-size:12px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--muted);margin-bottom:16px;}
.stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px;}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;transition:all 0.2s;}
.stat-card:hover{border-color:var(--accent);transform:translateY(-2px);}
.stat-val{font-size:28px;font-weight:900;font-family:var(--mono);margin-bottom:4px;}
.stat-lbl{font-size:11px;color:var(--muted);}
.stat-change{font-size:10px;font-family:var(--mono);margin-top:6px;}
.stat-change.up{color:var(--green);}
.stat-change.down{color:var(--red);}

/* â”€â”€ í•™ìƒ í…Œì´ë¸” â”€â”€ */
.student-table{width:100%;border-collapse:collapse;}
.student-table th{font-size:10px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--muted);padding:8px 12px;text-align:left;border-bottom:1px solid var(--border);}
.student-table td{padding:12px 12px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px;vertical-align:middle;}
.student-table tr:hover td{background:rgba(255,255,255,0.02);}
.s-avatar{width:32px;height:32px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:14px;font-weight:900;color:white;margin-right:8px;vertical-align:middle;}
.s-name{font-weight:700;color:var(--text);}
.s-sub{font-size:11px;color:var(--muted);font-family:var(--mono);}
.prog-bar-wrap{width:100px;}
.prog-bar{height:6px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;}
.prog-bar-fill{height:100%;border-radius:3px;transition:width 0.5s;}
.prog-pct{font-size:10px;font-family:var(--mono);color:var(--muted);margin-top:3px;}
.badge-pill{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:20px;font-size:10px;font-family:var(--mono);font-weight:700;}
.badge-pill.green{background:rgba(26,173,110,0.12);color:var(--green);}
.badge-pill.red{background:rgba(232,64,28,0.12);color:var(--red);}
.badge-pill.blue{background:rgba(26,127,212,0.12);color:var(--blue);}
.badge-pill.yellow{background:rgba(245,166,35,0.12);color:var(--accent);}
.action-btn{padding:4px 10px;border-radius:6px;border:1px solid var(--border);background:none;font-size:11px;color:var(--muted);cursor:pointer;font-family:var(--font);transition:all 0.15s;}
.action-btn:hover{background:var(--surface);color:var(--text);}

/* â”€â”€ í™œë™ í”¼ë“œ â”€â”€ */
.feed-item{display:flex;align-items:flex-start;gap:12px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.03);}
.feed-avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;}
.feed-content{flex:1;}
.feed-text{font-size:12px;color:var(--text);}
.feed-time{font-size:10px;color:var(--muted);font-family:var(--mono);margin-top:2px;}
.feed-badge{font-size:11px;padding:2px 8px;border-radius:20px;margin-left:6px;}

/* â”€â”€ ì°¨íŠ¸ ì˜ì—­ â”€â”€ */
.chart-wrap{background:rgba(255,255,255,0.02);border-radius:10px;padding:16px;margin-bottom:12px;}
.chart-title{font-size:11px;color:var(--muted);margin-bottom:12px;font-family:var(--mono);}
.bar-chart{display:flex;align-items:flex-end;gap:8px;height:80px;}
.bar-col{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1;}
.bar{width:100%;border-radius:4px 4px 0 0;transition:height 0.5s;min-height:2px;}
.bar-lbl{font-size:9px;color:var(--muted);font-family:var(--mono);}
.bar-val{font-size:9px;color:var(--text);font-family:var(--mono);}

/* â”€â”€ ë·° íŒ¨ë„ â”€â”€ */
.view-panel{display:none;}
.view-panel.active{display:block;}

/* â”€â”€ í•™ë¶€ëª¨ ë¦¬í¬íŠ¸ â”€â”€ */
.report-card{background:linear-gradient(135deg,var(--card),rgba(26,127,212,0.05));border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:16px;}
.report-header{display:flex;align-items:center;gap:16px;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--border);}
.report-avatar-big{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;}
.report-student-name{font-size:20px;font-weight:900;}
.report-period{font-size:12px;color:var(--muted);font-family:var(--mono);margin-top:4px;}
.report-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;}
.r-stat{background:rgba(255,255,255,0.03);border-radius:10px;padding:14px;text-align:center;}
.r-stat-val{font-size:22px;font-weight:900;font-family:var(--mono);}
.r-stat-lbl{font-size:10px;color:var(--muted);margin-top:4px;}
.report-comment{background:rgba(26,127,212,0.06);border:1px solid rgba(26,127,212,0.15);border-radius:10px;padding:14px;font-size:13px;line-height:1.8;color:var(--text);}
.report-comment .teacher-name{font-weight:700;color:var(--blue);font-size:12px;margin-bottom:6px;}
.send-report-btn{width:100%;padding:12px;background:var(--blue);color:white;border:none;border-radius:10px;font-size:14px;font-weight:700;font-family:var(--font);cursor:pointer;transition:opacity 0.15s;margin-top:12px;}
.send-report-btn:hover{opacity:0.85;}

/* â”€â”€ AI ë¶„ì„ â”€â”€ */
.ai-panel{background:linear-gradient(135deg,rgba(155,89,182,0.08),rgba(26,127,212,0.05));border:1px solid rgba(155,89,182,0.2);border-radius:14px;padding:20px;margin-bottom:16px;}
.ai-panel-header{display:flex;align-items:center;gap:10px;margin-bottom:16px;}
.ai-icon{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--purple),var(--blue));display:flex;align-items:center;justify-content:center;font-size:18px;}
.ai-title{font-size:14px;font-weight:700;color:var(--text);}
.ai-sub{font-size:11px;color:var(--muted);font-family:var(--mono);}
.ai-result{background:rgba(0,0,0,0.3);border-radius:10px;padding:16px;font-size:13px;line-height:1.9;color:var(--text);min-height:80px;position:relative;}
.ai-result.loading::after{content:'ë¶„ì„ ì¤‘...';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:var(--purple);font-family:var(--mono);font-size:12px;background:rgba(0,0,0,0.5);border-radius:10px;}
.ai-tag{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-family:var(--mono);margin:2px;background:rgba(155,89,182,0.12);color:var(--purple);}
.ai-analyze-btn{padding:10px 20px;background:linear-gradient(135deg,var(--purple),var(--blue));color:white;border:none;border-radius:8px;font-size:13px;font-weight:700;font-family:var(--font);cursor:pointer;transition:opacity 0.2s;margin-top:12px;}
.ai-analyze-btn:hover{opacity:0.85;}
.ai-analyze-btn:disabled{opacity:0.4;cursor:not-allowed;}
.wrong-analysis-list{display:flex;flex-direction:column;gap:8px;margin-top:12px;}
.wa-item{background:rgba(232,64,28,0.05);border:1px solid rgba(232,64,28,0.12);border-radius:8px;padding:10px 12px;display:flex;align-items:center;gap:12px;}
.wa-q{font-family:var(--mono);font-size:14px;font-weight:700;color:var(--text);flex:1;}
.wa-info{font-size:11px;color:var(--muted);}
.wa-count{font-family:var(--mono);font-size:12px;color:var(--red);font-weight:700;}

/* â”€â”€ ì„¹ì…˜ í† ê¸€ â”€â”€ */
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.section-title{font-size:16px;font-weight:700;}
.section-sub{font-size:12px;color:var(--muted);font-family:var(--mono);margin-top:2px;}

/* â”€â”€ ë°˜ì‘í˜• â”€â”€ */
@media(max-width:768px){
  .sidebar{display:none;}
  .stat-grid{grid-template-columns:repeat(2,1fr);}
  .report-stats{grid-template-columns:repeat(2,1fr);}
}

/* â”€â”€ ì• ë‹ˆë©”ì´ì…˜ â”€â”€ */
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.view-panel.active{animation:fadeIn 0.2s ease;}
</style>
</head>
<body>

<!-- í—¤ë” -->
<div class="header">
  <div class="header-logo">ìˆ˜í•™</div>
  <div>
    <div class="header-title">êµ¬ëª¬ìˆ˜í•™ êµì‚¬ ëŒ€ì‹œë³´ë“œ</div>
  </div>
  <div class="header-spacer"></div>
  <div class="header-tabs">
    <button class="htab on" onclick="showView('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
    <button class="htab" onclick="showView('report')">ğŸ“± í•™ë¶€ëª¨ ë¦¬í¬íŠ¸</button>
    <button class="htab" onclick="showView('ai')">ğŸ¤– AI ë¶„ì„</button>
  </div>
  <button class="back-btn" onclick="window.close()">â† ë·°ì–´ë¡œ ëŒì•„ê°€ê¸°</button>
</div>

<div class="main">
  <!-- ì‚¬ì´ë“œë°” -->
  <div class="sidebar">
    <div class="sb-section">í•™ìƒ ëª©ë¡</div>
    <div id="sb-student-list"></div>
    <div class="sb-section" style="margin-top:16px;">ë¹ ë¥¸ ì´ë™</div>
    <button class="sb-item on" onclick="showView('dashboard')"><span class="sb-item-icon">ğŸ“Š</span>ì „ì²´ í˜„í™©</button>
    <button class="sb-item" onclick="showView('report')"><span class="sb-item-icon">ğŸ“±</span>í•™ë¶€ëª¨ ë¦¬í¬íŠ¸</button>
    <button class="sb-item" onclick="showView('ai')"><span class="sb-item-icon">ğŸ¤–</span>AI ì˜¤ë‹µ ë¶„ì„</button>
  </div>

  <!-- ì½˜í…ì¸  -->
  <div class="content">

    <!-- â‘  ëŒ€ì‹œë³´ë“œ ë·° -->
    <div class="view-panel active" id="view-dashboard">
      <div class="section-header">
        <div>
          <div class="section-title">í•™ìƒ í˜„í™© ëŒ€ì‹œë³´ë“œ</div>
          <div class="section-sub" id="dash-date"></div>
        </div>
      </div>

      <!-- í†µê³„ ì¹´ë“œ -->
      <div class="stat-grid" id="stat-grid">
        <div class="stat-card">
          <div class="stat-val" id="stat-total" style="color:var(--accent);">-</div>
          <div class="stat-lbl">ë“±ë¡ í•™ìƒ ìˆ˜</div>
          <div class="stat-change up" id="stat-today-active">ì˜¤ëŠ˜ í•™ìŠµ: -ëª…</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="stat-avg-progress" style="color:var(--green);">-</div>
          <div class="stat-lbl">í‰ê·  ì§„ë„ìœ¨</div>
          <div class="stat-change up">ì „ì²´ ê¸°ì¤€</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="stat-total-done" style="color:var(--blue);">-</div>
          <div class="stat-lbl">ì´ ì™„ë£Œ í˜ì´ì§€</div>
          <div class="stat-change up">ëˆ„ì  í•©ê³„</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="stat-wrong-total" style="color:var(--red);">-</div>
          <div class="stat-lbl">ëˆ„ì  ì˜¤ë‹µ ìˆ˜</div>
          <div class="stat-change down">ì˜¤ë‹µë…¸íŠ¸ ê¸°ì¤€</div>
        </div>
      </div>

      <!-- ë‹¨ê³„ë³„ ì§„ë„ ì°¨íŠ¸ -->
      <div class="card">
        <div class="card-title">ë‹¨ê³„ë³„ í‰ê·  ì§„ë„</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;">
          <div class="chart-wrap">
            <div class="chart-title">Aë‹¨ê³„</div>
            <div class="bar-chart" id="chart-a"></div>
          </div>
          <div class="chart-wrap">
            <div class="chart-title">Bë‹¨ê³„</div>
            <div class="bar-chart" id="chart-b"></div>
          </div>
          <div class="chart-wrap">
            <div class="chart-title">Cë‹¨ê³„</div>
            <div class="bar-chart" id="chart-c"></div>
          </div>
        </div>
      </div>

      <!-- í•™ìƒ ëª©ë¡ í…Œì´ë¸” -->
      <div class="card">
        <div class="card-title">í•™ìƒë³„ ìƒì„¸ í˜„í™©</div>
        <table class="student-table" id="student-table">
          <thead>
            <tr>
              <th>í•™ìƒ</th>
              <th>ë‹¨ê³„</th>
              <th>ì§„ë„</th>
              <th>ì™„ë£Œ í˜ì´ì§€</th>
              <th>ì˜¤ë‹µ ìˆ˜</th>
              <th>ë ˆë²¨</th>
              <th>streak</th>
              <th>ìƒíƒœ</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="student-tbody"></tbody>
        </table>
      </div>

      <!-- ìµœê·¼ í™œë™ í”¼ë“œ -->
      <div class="card">
        <div class="card-title">ìµœê·¼ í•™ìŠµ í™œë™</div>
        <div id="activity-feed"></div>
      </div>
    </div>

    <!-- â‘¡ í•™ë¶€ëª¨ ë¦¬í¬íŠ¸ ë·° -->
    <div class="view-panel" id="view-report">
      <div class="section-header">
        <div>
          <div class="section-title">í•™ë¶€ëª¨ ë¦¬í¬íŠ¸</div>
          <div class="section-sub">í•™ìƒë³„ í•™ìŠµ í˜„í™©ì„ í•™ë¶€ëª¨ì—ê²Œ ë°œì†¡í•©ë‹ˆë‹¤</div>
        </div>
      </div>
      <div id="report-list"></div>
    </div>

    <!-- â‘¢ AI ì˜¤ë‹µ ë¶„ì„ ë·° -->
    <div class="view-panel" id="view-ai">
      <div class="section-header">
        <div>
          <div class="section-title">ğŸ¤– AI ì˜¤ë‹µ ë¶„ì„</div>
          <div class="section-sub">Claude AIê°€ ì˜¤ë‹µ íŒ¨í„´ì„ ë¶„ì„í•˜ê³  ë§ì¶¤ í•™ìŠµ ë°©í–¥ì„ ì œì‹œí•©ë‹ˆë‹¤</div>
        </div>
      </div>

      <!-- í•™ìƒ ì„ íƒ -->
      <div class="card">
        <div class="card-title">ë¶„ì„í•  í•™ìƒ ì„ íƒ</div>
        <div id="ai-student-selector" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;"></div>
        <button class="ai-analyze-btn" id="ai-btn" onclick="runAIAnalysis()">ğŸ¤– AI ë¶„ì„ ì‹œì‘</button>
      </div>

      <!-- ì˜¤ë‹µ ëª©ë¡ -->
      <div class="card" id="ai-wrong-section" style="display:none;">
        <div class="card-title">ì˜¤ë‹µ ëª©ë¡ <span id="ai-wrong-count" style="color:var(--red);"></span></div>
        <div class="wrong-analysis-list" id="ai-wrong-list"></div>
      </div>

      <!-- AI ë¶„ì„ ê²°ê³¼ -->
      <div class="ai-panel" id="ai-result-panel" style="display:none;">
        <div class="ai-panel-header">
          <div class="ai-icon">ğŸ¤–</div>
          <div>
            <div class="ai-title">AI í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸</div>
            <div class="ai-sub" id="ai-result-sub">Claude AI ë¶„ì„ ê²°ê³¼</div>
          </div>
        </div>
        <div class="ai-result" id="ai-result-text">ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
    </div>

  </div>
</div>

<script>
// â”€â”€ ë°ì´í„° ë¡œë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STAGE_TOTAL = {A:10, B:10, C:10};
const AVATAR_COLORS=['#e8401c','#1a7fd4','#1aad6e','#f5a623','#9b59b6','#e91e8c','#00bcd4','#ff5722','#4caf50','#3f51b5'];

function getStudents(){
  try{const r=localStorage.getItem('kumon-students');return r?JSON.parse(r):[];}catch(e){return[];}
}

function getStudentDone(sid, stage){
  let done=0;
  for(let p=1;p<=STAGE_TOTAL[stage];p++){
    if(localStorage.getItem(`kumon-done-${sid}-${stage}-${p}`)==='1') done++;
  }
  return done;
}

function getStudentWrong(sid){
  try{const r=localStorage.getItem(`kumon-wrong-${sid}`);return r?JSON.parse(r):[];}catch(e){return[];}
}

function getGameData(sid){
  try{const r=localStorage.getItem(`kumon-game-${sid}`);return r?JSON.parse(r):{points:0,xp:0,level:1,streak:0,badges:[],totalDone:0};}
  catch(e){return{points:0,xp:0,level:1,streak:0,badges:[],totalDone:0};}
}

// â”€â”€ ë·° ì „í™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentView = 'dashboard';
let selectedAiStudent = null;

function showView(v){
  currentView = v;
  document.querySelectorAll('.view-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('view-'+v).classList.add('active');
  document.querySelectorAll('.htab').forEach(t=>t.classList.remove('on'));
  document.querySelectorAll('.htab').forEach(t=>{if(t.textContent.includes({'dashboard':'ëŒ€ì‹œë³´ë“œ','report':'ë¦¬í¬íŠ¸','ai':'AI'}[v])) t.classList.add('on');});
  document.querySelectorAll('.sb-item').forEach(t=>t.classList.remove('on'));
  if(v==='dashboard') renderDashboard();
  if(v==='report') renderReports();
  if(v==='ai') renderAI();
}

// â”€â”€ â‘  ëŒ€ì‹œë³´ë“œ ë Œë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDashboard(){
  const students = getStudents();
  const now = new Date();
  document.getElementById('dash-date').textContent = now.toLocaleDateString('ko-KR',{year:'numeric',month:'long',day:'numeric',weekday:'long'});

  // í†µê³„
  let totalDone=0, totalWrong=0, progressSum=0;
  students.forEach(s=>{
    let done=0;
    ['A','B','C'].forEach(st=>{ done+=getStudentDone(s.id,st); });
    totalDone+=done;
    totalWrong+=getStudentWrong(s.id).length;
    const stageDone=getStudentDone(s.id,s.stage);
    progressSum+=stageDone/STAGE_TOTAL[s.stage]*100;
  });
  const avgProgress = students.length ? Math.round(progressSum/students.length) : 0;
  document.getElementById('stat-total').textContent = students.length;
  document.getElementById('stat-avg-progress').textContent = avgProgress+'%';
  document.getElementById('stat-total-done').textContent = totalDone;
  document.getElementById('stat-wrong-total').textContent = totalWrong;

  // ì‚¬ì´ë“œë°” í•™ìƒ ëª©ë¡
  const sbList = document.getElementById('sb-student-list');
  sbList.innerHTML = students.map(s=>`
    <button class="sb-item" onclick="scrollToStudent('${s.id}')">
      <span class="sb-item-icon">${s.emoji}</span>
      <span>${s.name}</span>
      <span class="sb-badge" style="background:${s.color};">${s.stage}</span>
    </button>
  `).join('') || '<div style="font-size:12px;color:var(--muted);padding:8px 10px;">í•™ìƒ ì—†ìŒ</div>';

  // ë‹¨ê³„ë³„ ì°¨íŠ¸
  ['A','B','C'].forEach(stage=>{
    const chart=document.getElementById('chart-'+stage.toLowerCase());
    const stageStudents=students.filter(s=>s.stage===stage);
    if(!stageStudents.length){chart.innerHTML='<div style="font-size:11px;color:var(--muted);text-align:center;width:100%;">í•´ë‹¹ í•™ìƒ ì—†ìŒ</div>';return;}
    const maxH=70;
    chart.innerHTML=stageStudents.map(s=>{
      const done=getStudentDone(s.id,stage);
      const pct=done/STAGE_TOTAL[stage]*100;
      const h=Math.max(4,pct/100*maxH);
      return `<div class="bar-col">
        <div class="bar-val">${Math.round(pct)}%</div>
        <div class="bar" style="height:${h}px;background:${s.color};"></div>
        <div class="bar-lbl">${s.name}</div>
      </div>`;
    }).join('');
  });

  // í•™ìƒ í…Œì´ë¸”
  const tbody = document.getElementById('student-tbody');
  if(!students.length){tbody.innerHTML='<tr><td colspan="9" style="text-align:center;color:var(--muted);padding:32px;">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';return;}
  tbody.innerHTML = students.map(s=>{
    const done=getStudentDone(s.id,s.stage);
    const total=STAGE_TOTAL[s.stage];
    const pct=Math.round(done/total*100);
    const wrong=getStudentWrong(s.id).length;
    const game=getGameData(s.id);
    const streak=game.streak||0;
    let status='blue', statusTxt='í•™ìŠµì¤‘';
    if(pct>=80){status='green';statusTxt='ìš°ìˆ˜';}
    else if(wrong>=5){status='red';statusTxt='ì£¼ì˜';}
    return `<tr id="row-${s.id}">
      <td><span class="s-avatar" style="background:${s.color};">${s.emoji}</span><span class="s-name">${s.name}</span></td>
      <td><span class="badge-pill yellow">${s.stage}ë‹¨ê³„</span></td>
      <td><div class="prog-bar-wrap"><div class="prog-bar"><div class="prog-bar-fill" style="width:${pct}%;background:${s.color};"></div></div><div class="prog-pct">${done}/${total} Â· ${pct}%</div></div></td>
      <td style="font-family:var(--mono);font-size:13px;font-weight:700;color:var(--text);">${done}í˜ì´ì§€</td>
      <td style="font-family:var(--mono);color:${wrong>0?'var(--red)':'var(--green)'};">${wrong}ê°œ</td>
      <td style="font-family:var(--mono);color:var(--accent);">Lv.${game.level||1}</td>
      <td style="font-family:var(--mono);color:${streak>=3?'var(--accent)':'var(--muted)'};">${streak>=1?'ğŸ”¥':''} ${streak}ì¼</td>
      <td><span class="badge-pill ${status}">${statusTxt}</span></td>
      <td>
        <button class="action-btn" onclick="showView('report');setTimeout(()=>scrollToReport('${s.id}'),100)">ë¦¬í¬íŠ¸</button>
        <button class="action-btn" onclick="showView('ai');selectAiStudent('${s.id}')" style="margin-left:4px;">AIë¶„ì„</button>
      </td>
    </tr>`;
  }).join('');

  // í™œë™ í”¼ë“œ
  const feed = document.getElementById('activity-feed');
  const allActivities = [];
  students.forEach(s=>{
    const wrong=getStudentWrong(s.id);
    const game=getGameData(s.id);
    // ì˜¤ë‹µ ê¸°ë¡
    wrong.slice(0,3).forEach(w=>{
      allActivities.push({time:w.date,student:s,type:'wrong',text:`${w.stage}ë‹¨ê³„ ${w.page}p â€” "${w.q}" ì˜¤ë‹µ`,icon:'âŒ'});
    });
    // ë°°ì§€
    (game.badges||[]).slice(-2).forEach(bid=>{
      const BADGES_DEF={first_done:'ğŸŒŸ',streak3:'ğŸ”¥',streak7:'ğŸ’«',points100:'â­',points500:'ğŸ†',done10:'ğŸ“š',done30:'ğŸ“',all_a:'ğŸ…°ï¸'};
      allActivities.push({time:'ìµœê·¼',student:s,type:'badge',text:`ë°°ì§€ "${bid}" íšë“`,icon:BADGES_DEF[bid]||'ğŸ…'});
    });
  });
  if(!allActivities.length){
    feed.innerHTML='<div style="text-align:center;padding:24px;color:var(--muted);font-size:13px;">í•™ìŠµ í™œë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤<br>í•™ìƒë“¤ì´ í•™ìŠµì„ ì‹œì‘í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>';
    return;
  }
  feed.innerHTML=allActivities.slice(0,10).map(a=>`
    <div class="feed-item">
      <div class="feed-avatar" style="background:${a.student.color};">${a.student.emoji}</div>
      <div class="feed-content">
        <div class="feed-text"><strong>${a.student.name}</strong> ${a.text} <span class="feed-badge">${a.icon}</span></div>
        <div class="feed-time">${a.time}</div>
      </div>
    </div>
  `).join('');
}

function scrollToStudent(id){
  const row=document.getElementById('row-'+id);
  if(row) row.scrollIntoView({behavior:'smooth',block:'center'});
}

// â”€â”€ â‘¡ í•™ë¶€ëª¨ ë¦¬í¬íŠ¸ ë Œë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderReports(){
  const students=getStudents();
  const container=document.getElementById('report-list');
  if(!students.length){
    container.innerHTML='<div style="text-align:center;padding:48px;color:var(--muted);">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  const today=new Date().toLocaleDateString('ko-KR',{year:'numeric',month:'long',day:'numeric'});
  container.innerHTML=students.map(s=>{
    const done=getStudentDone(s.id,s.stage);
    const total=STAGE_TOTAL[s.stage];
    const pct=Math.round(done/total*100);
    const wrong=getStudentWrong(s.id).length;
    const game=getGameData(s.id);
    const streak=game.streak||0;
    let comment='';
    if(pct>=80) comment=`${s.name} í•™ìƒì€ ${s.stage}ë‹¨ê³„ë¥¼ ${pct}% ì™„ë£Œí•˜ì—¬ ë§¤ìš° ìš°ìˆ˜í•œ í•™ìŠµ ì§„ë„ë¥¼ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤. ê¾¸ì¤€í•œ í•™ìŠµ ìŠµê´€ì´ ì¢‹ì€ ê²°ê³¼ë¡œ ì´ì–´ì§€ê³  ìˆìœ¼ë‹ˆ ê³„ì†í•´ì„œ ê²©ë ¤í•´ ì£¼ì„¸ìš”!`;
    else if(pct>=50) comment=`${s.name} í•™ìƒì€ ${s.stage}ë‹¨ê³„ë¥¼ ${pct}% ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê¾¸ì¤€íˆ í•™ìŠµí•˜ê³  ìˆìœ¼ë©°, ì¡°ê¸ˆ ë” ì§‘ì¤‘í•˜ë©´ ë” ë¹ ë¥¸ ì§„ë„ë¥¼ ë³´ì¼ ìˆ˜ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.`;
    else comment=`${s.name} í•™ìƒì˜ ${s.stage}ë‹¨ê³„ ì§„ë„ëŠ” í˜„ì¬ ${pct}%ì…ë‹ˆë‹¤. ì§‘ì—ì„œë„ ë§¤ì¼ ì¡°ê¸ˆì”© ë³µìŠµì„ ê²©ë ¤í•´ ì£¼ì‹œë©´ ë¹ ë¥¸ í–¥ìƒì´ ê¸°ëŒ€ë©ë‹ˆë‹¤.`;
    if(wrong>0) comment+=` ì˜¤ë‹µì´ ${wrong}ê°œ ìˆìœ¼ë‹ˆ í•´ë‹¹ ë¬¸ì œë¥¼ í•¨ê»˜ ë‹¤ì‹œ í’€ì–´ë³´ì‹œê¸° ë°”ëë‹ˆë‹¤.`;
    if(streak>=3) comment+=` ìµœê·¼ ${streak}ì¼ ì—°ì†ìœ¼ë¡œ í•™ìŠµí•˜ëŠ” í›Œë¥­í•œ ìŠµê´€ì„ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤! ğŸ”¥`;
    return `
    <div class="report-card" id="report-${s.id}">
      <div class="report-header">
        <div class="report-avatar-big" style="background:${s.color};">${s.emoji}</div>
        <div>
          <div class="report-student-name">${s.name} í•™ìƒ</div>
          <div class="report-period">ğŸ“… ${today} ê¸°ì¤€ ì£¼ê°„ ë¦¬í¬íŠ¸</div>
        </div>
      </div>
      <div class="report-stats">
        <div class="r-stat">
          <div class="r-stat-val" style="color:${s.color};">${pct}%</div>
          <div class="r-stat-lbl">ë‹¨ê³„ ì§„ë„ìœ¨</div>
        </div>
        <div class="r-stat">
          <div class="r-stat-val" style="color:var(--green);">${done}ì¥</div>
          <div class="r-stat-lbl">ì™„ë£Œ í˜ì´ì§€</div>
        </div>
        <div class="r-stat">
          <div class="r-stat-val" style="color:var(--accent);">Lv.${game.level||1}</div>
          <div class="r-stat-lbl">í•™ìŠµ ë ˆë²¨</div>
        </div>
      </div>
      <div class="report-comment">
        <div class="teacher-name">ğŸ‘©â€ğŸ« ë‹´ë‹¹ êµì‚¬ ì½”ë©˜íŠ¸</div>
        ${comment}
      </div>
      <button class="send-report-btn" onclick="sendReport('${s.id}','${s.name}')">
        ğŸ“¤ ${s.name} í•™ë¶€ëª¨ì—ê²Œ ë¦¬í¬íŠ¸ ë°œì†¡ (ì¹´ì¹´ì˜¤í†¡/ë¬¸ì)
      </button>
    </div>`;
  }).join('');
}

function scrollToReport(id){
  const el=document.getElementById('report-'+id);
  if(el) el.scrollIntoView({behavior:'smooth',block:'center'});
}

function sendReport(sid, name){
  // ì‹¤ì œ êµ¬í˜„ ì‹œ ì¹´ì¹´ì˜¤ API ë˜ëŠ” ë¬¸ì API ì—°ë™
  const btn=event.target;
  btn.textContent='âœ… ë°œì†¡ ì™„ë£Œ!';
  btn.style.background='var(--green)';
  setTimeout(()=>{btn.textContent=`ğŸ“¤ ${name} í•™ë¶€ëª¨ì—ê²Œ ë¦¬í¬íŠ¸ ë°œì†¡ (ì¹´ì¹´ì˜¤í†¡/ë¬¸ì)`;btn.style.background='';},3000);
  alert(`ğŸ“± ${name} í•™ìƒì˜ í•™ë¶€ëª¨ ë¦¬í¬íŠ¸ ë°œì†¡!\n\nì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ ë˜ëŠ”\nSMSë¡œ ìë™ ë°œì†¡ë©ë‹ˆë‹¤.\n\n(í˜„ì¬ëŠ” ë°ëª¨ ë²„ì „ì…ë‹ˆë‹¤)`);
}

// â”€â”€ â‘¢ AI ë¶„ì„ ë Œë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAI(){
  const students=getStudents();
  const selector=document.getElementById('ai-student-selector');
  selector.innerHTML=students.map(s=>`
    <button class="action-btn" id="ai-sel-${s.id}" onclick="selectAiStudent('${s.id}')" style="padding:8px 14px;font-size:13px;">
      <span style="margin-right:6px;">${s.emoji}</span>${s.name}
    </button>
  `).join('') || '<div style="color:var(--muted);font-size:13px;">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</div>';

  if(selectedAiStudent) selectAiStudent(selectedAiStudent);
}

function selectAiStudent(sid){
  selectedAiStudent=sid;
  const students=getStudents();
  const s=students.find(x=>x.id===sid);
  if(!s) return;

  // ì„ íƒ ë²„íŠ¼ í•˜ì´ë¼ì´íŠ¸
  document.querySelectorAll('[id^="ai-sel-"]').forEach(b=>b.style.borderColor='');
  const selBtn=document.getElementById('ai-sel-'+sid);
  if(selBtn) selBtn.style.borderColor=s.color;

  // ì˜¤ë‹µ ëª©ë¡ í‘œì‹œ
  const wrong=getStudentWrong(sid);
  const ws=document.getElementById('ai-wrong-section');
  const wl=document.getElementById('ai-wrong-list');
  document.getElementById('ai-wrong-count').textContent=`(${wrong.length}ê°œ)`;
  if(wrong.length){
    ws.style.display='';
    wl.innerHTML=wrong.map(w=>`
      <div class="wa-item">
        <div class="wa-q">${w.q}</div>
        <div class="wa-info">${w.stage}ë‹¨ê³„ ${w.page}p Â· ${w.date}</div>
        <div class="wa-count">ë‚´ ë‹µ: ${w.mine||'?'}</div>
        <div style="font-size:12px;color:var(--green);font-family:var(--mono);font-weight:700;">ì •ë‹µ: ${w.correct}</div>
      </div>
    `).join('');
  } else {
    ws.style.display='';
    wl.innerHTML='<div style="text-align:center;padding:20px;color:var(--muted);font-size:13px;">ì˜¤ë‹µ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤ ğŸ‰</div>';
  }
}

async function runAIAnalysis(){
  if(!selectedAiStudent){alert('ë¶„ì„í•  í•™ìƒì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');return;}
  const students=getStudents();
  const s=students.find(x=>x.id===selectedAiStudent);
  if(!s) return;

  const wrong=getStudentWrong(selectedAiStudent);
  const done=getStudentDone(selectedAiStudent,s.stage);
  const game=getGameData(selectedAiStudent);
  const btn=document.getElementById('ai-btn');
  const resultPanel=document.getElementById('ai-result-panel');
  const resultText=document.getElementById('ai-result-text');

  btn.disabled=true;btn.textContent='ğŸ¤– ë¶„ì„ ì¤‘...';
  resultPanel.style.display='';
  resultText.className='ai-result loading';
  document.getElementById('ai-result-sub').textContent=`${s.name} í•™ìƒ ë¶„ì„ ì¤‘...`;

  const prompt = `ë‹¹ì‹ ì€ ì´ˆë“±í•™ìƒ ìˆ˜í•™ ì „ë¬¸ êµì‚¬ì…ë‹ˆë‹¤. ë‹¤ìŒ í•™ìƒì˜ í•™ìŠµ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ë§ì¶¤í˜• í•™ìŠµ ê°€ì´ë“œë¥¼ ì‘ì„±í•´ ì£¼ì„¸ìš”.

í•™ìƒ ì •ë³´:
- ì´ë¦„: ${s.name}
- í˜„ì¬ ë‹¨ê³„: ${s.stage}ë‹¨ê³„
- ì™„ë£Œ í˜ì´ì§€: ${done}/${10}í˜ì´ì§€ (${Math.round(done/10*100)}%)
- í•™ìŠµ ë ˆë²¨: Lv.${game.level||1}
- ì—°ì† í•™ìŠµì¼: ${game.streak||0}ì¼
- ì´ í¬ì¸íŠ¸: ${game.points||0}pt

ì˜¤ë‹µ ëª©ë¡ (${wrong.length}ê°œ):
${wrong.length ? wrong.map(w=>`- ë¬¸ì œ: "${w.q}" | ë‚´ ë‹µ: ${w.mine||'?'} | ì •ë‹µ: ${w.correct}`).join('\n') : 'ì˜¤ë‹µ ì—†ìŒ (ë§¤ìš° ìš°ìˆ˜!)'}

ë‹¤ìŒ ë‚´ìš©ì„ í¬í•¨í•´ì„œ ë¶„ì„í•´ ì£¼ì„¸ìš” (í•œêµ­ì–´ë¡œ, ì¹œê·¼í•˜ê³  ê²©ë ¤í•˜ëŠ” í†¤ìœ¼ë¡œ):
1. **í˜„ì¬ í•™ìŠµ ìˆ˜ì¤€ í‰ê°€** (2-3ì¤„)
2. **ì˜¤ë‹µ íŒ¨í„´ ë¶„ì„** (ì–´ë–¤ ìœ í˜•ì˜ ë¬¸ì œê°€ ì–´ë ¤ìš´ì§€)
3. **ë§ì¶¤ í•™ìŠµ ë°©í–¥** (êµ¬ì²´ì ì¸ 3ê°€ì§€ ì œì•ˆ)
4. **í•™ë¶€ëª¨ê»˜ ë“œë¦¬ëŠ” í•œë§ˆë””**

ê°„ê²°í•˜ê³  ì‹¤ìš©ì ìœ¼ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”.`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        messages: [{role: 'user', content: prompt}]
      })
    });
    const data = await response.json();
    const text = data.content?.[0]?.text || 'ë¶„ì„ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    resultText.className='ai-result';
    // ë§ˆí¬ë‹¤ìš´ ê°„ë‹¨ ë Œë”
    resultText.innerHTML = text
      .replace(/\*\*(.*?)\*\*/g,'<strong style="color:var(--accent);">$1</strong>')
      .replace(/\n\n/g,'<br><br>').replace(/\n/g,'<br>')
      .replace(/(\d+\. )/g,'<br><span style="color:var(--purple);font-weight:700;">$1</span>');
  } catch(e) {
    resultText.className='ai-result';
    resultText.innerHTML=`<span style="color:var(--red);">AI ì—°ê²° ì˜¤ë¥˜: API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</span><br><br>
    <strong style="color:var(--accent);">ğŸ“‹ ë°ëª¨ ë¶„ì„ ê²°ê³¼</strong><br><br>
    <strong>1. í˜„ì¬ í•™ìŠµ ìˆ˜ì¤€</strong><br>
    ${s.name} í•™ìƒì€ ${s.stage}ë‹¨ê³„ì—ì„œ ${Math.round(done/10*100)}%ì˜ ì§„ë„ë¥¼ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤. ${done>=7?'ë§¤ìš° ìš°ìˆ˜í•œ í•™ìŠµ ì†ë„ì…ë‹ˆë‹¤! ğŸŒŸ':'ê¾¸ì¤€íˆ í•™ìŠµí•˜ê³  ìˆìœ¼ë©° ë” ë°œì „ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.'}<br><br>
    <strong>2. ì˜¤ë‹µ íŒ¨í„´</strong><br>
    ${wrong.length>0?`${wrong.length}ê°œì˜ ì˜¤ë‹µì´ ê¸°ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì£¼ìš” ì˜¤ë‹µ ìœ í˜•: ${wrong.slice(0,3).map(w=>w.q).join(', ')} ë“±ì—ì„œ ì–´ë ¤ì›€ì„ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤.`:'ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤! ì™„ë²½í•œ ì´í•´ë„ë¥¼ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤. ğŸ‰'}<br><br>
    <strong>3. ë§ì¶¤ í•™ìŠµ ì œì•ˆ</strong><br>
    â‘  ë§¤ì¼ 10~15ë¶„ì”© ê¾¸ì¤€í•œ ë°˜ë³µ í•™ìŠµ<br>
    â‘¡ ì˜¤ë‹µ ë¬¸ì œ ìœ„ì£¼ë¡œ ì¬ë³µìŠµ<br>
    â‘¢ ë‹¤ìŒ ë‹¨ê³„ ì§„ì… ì „ í˜„ì¬ ë‹¨ê³„ ì™„ì „ ë§ˆìŠ¤í„°<br><br>
    <strong>4. í•™ë¶€ëª¨ê»˜</strong><br>
    ì•„ì´ê°€ í•™ìŠµí•˜ëŠ” ì‹œê°„ì„ ì¹­ì°¬í•´ ì£¼ì‹œê³ , ì‘ì€ ì„±ì·¨ë„ í¬ê²Œ ê²©ë ¤í•´ ì£¼ì„¸ìš”! ğŸ†`;
  }

  btn.disabled=false;btn.textContent='ğŸ¤– AI ë¶„ì„ ì‹œì‘';
}

// â”€â”€ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', ()=>{
  renderDashboard();
});
</script>
</body>
</html>
