<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>êµ¬ëª¬ìˆ˜í•™ ë‹¨ê³„ë³„ êµì¬ ë·°ì–´</title>

<!-- â”€â”€ PWA í•„ìˆ˜ ë©”íƒ€íƒœê·¸ â”€â”€ -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#e8401c">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ìˆ˜í•™ë·°ì–´">
<meta name="application-name" content="êµ¬ëª¬ìˆ˜í•™ êµì¬ ë·°ì–´">
<meta name="description" content="êµ¬ëª¬ìˆ˜í•™ AÂ·BÂ·C ë‹¨ê³„ë³„ êµì¬ ë·°ì–´ with Síœ í•„ê¸°">

<!-- â”€â”€ ì•„ì´ì½˜ â”€â”€ -->
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
<link rel="apple-touch-icon" href="icons/icon-152.png">
<link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152.png">
<link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png">

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
:root {
  --bg:#f0ede8; --stage-a:#e8401c; --stage-a-light:#fde8e3; --stage-a-mid:#f4a48e;
  --stage-b:#1a7fd4; --stage-b-light:#e0eefc; --stage-b-mid:#7ab8eb;
  --stage-c:#1aad6e; --stage-c-light:#dcf5eb; --stage-c-mid:#76d4a8;
  --ink:#1a1814; --ink-mid:#4a4540; --ink-light:#9a9088;
  --paper:#fffef9; --ui-bg:#ffffff; --ui-border:#e0dbd2;
  --shadow-sm:0 2px 8px rgba(0,0,0,0.08);
  --shadow-lg:0 12px 48px rgba(0,0,0,0.18);
  --stage-color:var(--stage-a); --stage-light:var(--stage-a-light); --stage-mid:var(--stage-a-mid);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);height:100vh;overflow:hidden;display:flex;flex-direction:column;}

/* â•â• QUICK MENU â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.quickmenu{
  height:60px;background:var(--ui-bg);border-bottom:1px solid var(--ui-border);
  box-shadow:var(--shadow-sm);display:flex;align-items:center;padding:0 20px;
  flex-shrink:0;
  position:sticky;top:0;           /* ìŠ¤í¬ë¡¤í•´ë„ í•­ìƒ ìƒë‹¨ ê³ ì • */
  z-index:9999;                    /* ìµœìƒìœ„ ë ˆì´ì–´ */
  min-height:60px;                 /* ë†’ì´ ì¶•ì†Œ ë°©ì§€ */
  overflow:visible;                /* ë‚´ìš© ì˜ë¦¼ ë°©ì§€ */
}
/* í€µë©”ë‰´ ìˆ¨ê¹€ ìƒíƒœ */
.quickmenu.qm-hidden{
  height:0;min-height:0;padding:0;overflow:hidden;border:none;box-shadow:none;
}
/* í€µë©”ë‰´ í† ê¸€ ë²„íŠ¼ (í•­ìƒ í™”ë©´ì— í‘œì‹œ) */
.qm-toggle-btn{
  position:fixed;top:8px;left:50%;transform:translateX(-50%);
  z-index:10000;
  background:var(--stage-color);color:white;
  border:none;border-radius:20px;
  padding:4px 16px;font-size:11px;font-family:'DM Mono',monospace;
  cursor:pointer;transition:all 0.25s;
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
  display:none;  /* ìˆ¨ê¹€ ìƒíƒœì¼ ë•Œë§Œ í‘œì‹œ */
  align-items:center;gap:5px;
  white-space:nowrap;
}
.qm-toggle-btn.show{display:flex;}
.qm-toggle-btn:hover{opacity:0.85;}
.qm-logo{display:flex;align-items:center;gap:10px;padding-right:20px;border-right:1px solid var(--ui-border);margin-right:12px;}
.qm-logo-icon{width:36px;height:36px;border-radius:9px;background:var(--stage-color);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:13px;transition:background 0.4s;font-family:'DM Mono',monospace;}
.qm-logo-name{font-size:14px;font-weight:700;color:var(--ink);line-height:1.2;}
.qm-logo-sub{font-size:10px;color:var(--ink-light);}
.stage-tabs{display:flex;align-items:center;gap:4px;}
.stage-tab{display:flex;align-items:center;gap:8px;padding:7px 16px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all 0.2s;user-select:none;}
.stage-tab-badge{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'DM Mono',monospace;font-size:13px;font-weight:600;transition:all 0.2s;}
.stage-tab-name{font-size:13px;font-weight:700;transition:color 0.2s;}
.stage-tab-sub{font-size:10px;color:var(--ink-light);}
.stage-tab[data-s="A"] .stage-tab-badge{background:var(--stage-a-light);color:var(--stage-a);}
.stage-tab[data-s="A"]:hover,.stage-tab[data-s="A"].on{background:var(--stage-a-light);}
.stage-tab[data-s="A"].on{border-color:var(--stage-a);}
.stage-tab[data-s="A"].on .stage-tab-badge{background:var(--stage-a);color:white;}
.stage-tab[data-s="A"].on .stage-tab-name{color:var(--stage-a);}
.stage-tab[data-s="B"] .stage-tab-badge{background:var(--stage-b-light);color:var(--stage-b);}
.stage-tab[data-s="B"]:hover,.stage-tab[data-s="B"].on{background:var(--stage-b-light);}
.stage-tab[data-s="B"].on{border-color:var(--stage-b);}
.stage-tab[data-s="B"].on .stage-tab-badge{background:var(--stage-b);color:white;}
.stage-tab[data-s="B"].on .stage-tab-name{color:var(--stage-b);}
.stage-tab[data-s="C"] .stage-tab-badge{background:var(--stage-c-light);color:var(--stage-c);}
.stage-tab[data-s="C"]:hover,.stage-tab[data-s="C"].on{background:var(--stage-c-light);}
.stage-tab[data-s="C"].on{border-color:var(--stage-c);}
.stage-tab[data-s="C"].on .stage-tab-badge{background:var(--stage-c);color:white;}
.stage-tab[data-s="C"].on .stage-tab-name{color:var(--stage-c);}
.qm-progress{display:flex;flex-direction:column;gap:5px;padding:0 16px;border-left:1px solid var(--ui-border);margin-left:8px;min-width:130px;}
.prog-row{display:flex;align-items:center;gap:6px;font-size:10px;color:var(--ink-light);font-family:'DM Mono',monospace;}
.prog-track{flex:1;height:4px;background:#e8e0d0;border-radius:2px;overflow:hidden;}
.prog-fill{height:100%;border-radius:2px;}
.prog-fill.a{background:var(--stage-a);width:65%;}
.prog-fill.b{background:var(--stage-b);width:30%;}
.prog-fill.c{background:var(--stage-c);width:10%;}
.qm-right{margin-left:auto;display:flex;align-items:center;gap:8px;}
.qm-btn{display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:6px;border:1px solid var(--ui-border);background:none;font-family:'Noto Sans KR',sans-serif;font-size:11px;color:var(--ink-mid);cursor:pointer;transition:all 0.15s;white-space:nowrap;}
.qm-btn:hover{background:var(--bg);}
.pj-wrap{position:relative;}
.pj-btn{display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:6px;border:2px solid var(--stage-color);background:none;font-family:'DM Mono',monospace;font-size:12px;color:var(--stage-color);cursor:pointer;transition:all 0.2s;min-width:88px;justify-content:center;}
.pj-btn:hover{background:var(--stage-light);}
.pj-dropdown{position:absolute;top:calc(100% + 8px);right:0;background:var(--ui-bg);border:1px solid var(--ui-border);border-radius:12px;box-shadow:var(--shadow-lg);padding:12px;display:none;grid-template-columns:repeat(5,1fr);gap:4px;width:220px;z-index:500;}
.pj-dropdown.open{display:grid;}
.pj-item{aspect-ratio:1;border-radius:6px;display:flex;align-items:center;justify-content:center;font-family:'DM Mono',monospace;font-size:11px;color:var(--ink-mid);cursor:pointer;transition:all 0.15s;border:1.5px solid transparent;}
.pj-item:hover{background:var(--stage-light);color:var(--stage-color);border-color:var(--stage-mid);}
.pj-item.on{background:var(--stage-color);color:white;}

/* â•â• TOOLBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toolbar{height:44px;flex-shrink:0;min-height:44px;background:var(--ui-bg);border-bottom:1px solid var(--ui-border);display:flex;align-items:center;padding:0 16px;gap:8px;z-index:9998;overflow-x:auto;}
.tb-badge{display:flex;align-items:center;gap:6px;padding:4px 12px;border-radius:6px;background:var(--stage-light);font-size:12px;font-weight:700;color:var(--stage-color);transition:all 0.4s;flex-shrink:0;}
.tb-dot{width:7px;height:7px;border-radius:50%;background:var(--stage-color);transition:background 0.4s;}
.tb-sep{width:1px;height:20px;background:var(--ui-border);flex-shrink:0;}
.tb-group{display:flex;align-items:center;gap:2px;flex-shrink:0;}
.tb-btn{padding:4px 10px;border-radius:5px;border:1px solid transparent;background:none;font-family:'Noto Sans KR',sans-serif;font-size:11px;color:var(--ink-mid);cursor:pointer;transition:all 0.15s;white-space:nowrap;}
.tb-btn:hover{background:var(--bg);border-color:var(--ui-border);}
.tb-btn.on{background:var(--stage-light);border-color:var(--stage-mid);color:var(--stage-color);}
.zoom-val{font-family:'DM Mono',monospace;font-size:11px;color:var(--stage-color);min-width:38px;text-align:center;}
.tb-right{margin-left:auto;display:flex;align-items:center;gap:8px;flex-shrink:0;}
.tb-info{font-family:'DM Mono',monospace;font-size:11px;color:var(--ink-light);}

/* â•â• í•„ê¸° íˆ´ë°” â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pen-toolbar{height:52px;flex-shrink:0;background:#1e1c18;border-bottom:2px solid var(--stage-color);display:flex;align-items:center;padding:0 16px;gap:10px;transition:border-color 0.4s;overflow-x:auto;}
.pen-toolbar.hidden{display:none;}
.pen-tool-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;width:40px;height:36px;border-radius:7px;border:1.5px solid transparent;background:none;cursor:pointer;transition:all 0.15s;flex-shrink:0;gap:2px;color:#9a9488;}
.pen-tool-btn svg{width:18px;height:18px;}
.pen-tool-btn .lbl{font-size:8px;font-family:'DM Mono',monospace;}
.pen-tool-btn:hover{background:rgba(255,255,255,0.07);color:#d0c8b8;}
.pen-tool-btn.on{background:rgba(255,255,255,0.12);border-color:var(--stage-color);color:var(--stage-color);}
.pen-sep{width:1px;height:28px;background:rgba(255,255,255,0.1);flex-shrink:0;}
.color-palette{display:flex;align-items:center;gap:5px;flex-shrink:0;}
.color-dot{width:22px;height:22px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all 0.15s;flex-shrink:0;}
.color-dot:hover{transform:scale(1.15);}
.color-dot.on{border-color:white;transform:scale(1.2);box-shadow:0 0 0 2px rgba(255,255,255,0.3);}
.pen-size-wrap{display:flex;align-items:center;gap:8px;flex-shrink:0;}
.pen-lbl{font-size:10px;color:#9a9488;font-family:'DM Mono',monospace;white-space:nowrap;}
.pen-slider{-webkit-appearance:none;width:80px;height:4px;border-radius:2px;background:#3a3830;outline:none;cursor:pointer;}
.pen-slider::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--stage-color);cursor:pointer;}
.pen-preview{width:28px;height:28px;border-radius:50%;background:#2a2822;border:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.pen-action-btn{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.15);background:none;font-family:'Noto Sans KR',sans-serif;font-size:11px;color:#9a9488;cursor:pointer;transition:all 0.15s;white-space:nowrap;flex-shrink:0;}
.pen-action-btn:hover{background:rgba(255,255,255,0.07);color:#d0c8b8;}
.pen-action-btn.danger:hover{background:rgba(232,64,28,0.15);color:#e8401c;border-color:rgba(232,64,28,0.3);}
.pen-action-btn svg{width:13px;height:13px;}
.pen-status{margin-left:auto;font-size:10px;color:#5a5850;font-family:'DM Mono',monospace;white-space:nowrap;flex-shrink:0;}
.pen-status.has-ink{color:#9a9488;}

/* â•â• BODY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app-body{display:flex;flex:1;overflow:hidden;}

/* â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sidebar{width:200px;flex-shrink:0;background:var(--ui-bg);border-right:1px solid var(--ui-border);display:flex;flex-direction:column;overflow:hidden;transition:width 0.3s,opacity 0.3s;}
.sidebar.hidden{width:0;opacity:0;pointer-events:none;}
.sb-head{padding:12px 14px 10px;border-bottom:1px solid var(--ui-border);display:flex;align-items:center;gap:7px;flex-shrink:0;}
.sb-dot{width:8px;height:8px;border-radius:50%;background:var(--stage-color);transition:background 0.4s;flex-shrink:0;}
.sb-head-txt{font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--ink-light);white-space:nowrap;}
.sb-scroll{flex:1;overflow-y:auto;padding:10px 8px;display:flex;flex-direction:column;gap:5px;scrollbar-width:thin;scrollbar-color:var(--ui-border) transparent;}
.thumb{display:flex;align-items:flex-start;gap:6px;cursor:pointer;padding:3px;border-radius:6px;transition:all 0.15s;}
.thumb:hover{background:var(--bg);}
.thumb.on{background:var(--stage-light);}
.thumb-num{font-family:'DM Mono',monospace;font-size:10px;color:var(--ink-light);min-width:18px;text-align:right;padding-top:3px;flex-shrink:0;}
.thumb.on .thumb-num{color:var(--stage-color);font-weight:600;}
.thumb-canvas-wrap{flex:1;aspect-ratio:176/250;background:var(--paper);border-radius:2px;border:1.5px solid var(--ui-border);overflow:hidden;position:relative;}
.thumb.on .thumb-canvas-wrap{border-color:var(--stage-color);}
.thumb-canvas-wrap canvas{width:100%!important;height:100%!important;display:block;}
.thumb-ink-dot{position:absolute;top:3px;right:3px;width:6px;height:6px;border-radius:50%;background:var(--stage-color);display:none;}
.thumb-ink-dot.show{display:block;}

/* â•â• VIEWER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.viewer{flex:1;overflow:auto;position:relative;scrollbar-width:thin;scrollbar-color:var(--ui-border) transparent;background:radial-gradient(ellipse at 20% 10%,rgba(200,169,110,0.04) 0%,transparent 55%),var(--bg);}
.pages-wrap{display:flex;flex-direction:column;align-items:center;padding:40px 60px 80px;gap:32px;transform-origin:top center;}
.pages-wrap.double{flex-direction:row;flex-wrap:wrap;justify-content:center;align-items:flex-start;}

/* â•â• B5 PAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.b5-page{width:176mm;flex-shrink:0;position:relative;background:var(--paper);border-radius:2px;box-shadow:0 2px 6px rgba(0,0,0,0.08),0 8px 24px rgba(0,0,0,0.12),0 20px 56px rgba(0,0,0,0.1);overflow:hidden;transition:box-shadow 0.3s;animation:pageIn 0.4s ease both;}
@keyframes pageIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.page-top-bar{height:5px;background:var(--stage-color);transition:background 0.4s;}

/* PDF + í•„ê¸° ë ˆì´ì–´ */
.pdf-canvas-wrap{width:176mm;position:relative;background:var(--paper);}
.pdf-canvas-wrap canvas.pdf-layer{display:block;width:100%!important;}
.ink-canvas{position:absolute;top:0;left:0;width:100%!important;height:100%!important;pointer-events:none;z-index:10;touch-action:none;}
.ink-canvas.active{pointer-events:all;cursor:crosshair;}
.ink-canvas.eraser-mode{cursor:cell;}

/* ë¡œë”©Â·ì—ëŸ¬ */
.page-loading{width:176mm;height:250mm;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;background:var(--paper);}
.spinner{width:36px;height:36px;border-radius:50%;border:3px solid var(--stage-light);border-top-color:var(--stage-color);animation:spin 0.8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-txt{font-size:11px;color:var(--ink-light);font-family:'DM Mono',monospace;}
.page-error{width:176mm;height:250mm;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;background:var(--paper);}
.error-icon{font-size:32px;opacity:0.4;}
.error-txt{font-size:11px;color:var(--ink-light);text-align:center;line-height:1.6;}

/* â•â• STATUS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.statusbar{height:26px;flex-shrink:0;background:var(--ui-bg);border-top:1px solid var(--ui-border);display:flex;align-items:center;padding:0 20px;gap:20px;font-size:10px;font-family:'DM Mono',monospace;z-index:100;}
.st-k{color:var(--ink-light);}
.st-v{color:var(--stage-color);transition:color 0.4s;}
.st-item{display:flex;gap:5px;}

/* ë‹¨ê³„ ì „í™˜ ì˜¤ë²„ë ˆì´ */
.stage-overlay{position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0;transition:opacity 0.25s;background:rgba(0,0,0,0.35);}
.stage-overlay.show{opacity:1;}
.stage-overlay-box{padding:20px 48px;border-radius:16px;font-size:44px;font-weight:900;color:white;background:var(--stage-color);box-shadow:var(--shadow-lg);transition:background 0.4s;letter-spacing:0.08em;}

/* í† ìŠ¤íŠ¸ */
.toast{position:fixed;bottom:40px;left:50%;transform:translateX(-50%) translateY(10px);background:#1e1c18;color:#d0c8b8;padding:10px 20px;border-radius:8px;font-size:12px;font-family:'DM Mono',monospace;opacity:0;transition:all 0.3s;z-index:2000;white-space:nowrap;border:1px solid rgba(255,255,255,0.1);}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

@media(max-width:900px){
  .sidebar{display:none;} .qm-progress{display:none;}
  .b5-page,.pdf-canvas-wrap,.page-loading,.page-error{width:90vw;}
  .pages-wrap{padding:20px 10px 60px;}
}
@media(max-width:600px){
  .stage-tab-sub{display:none;} .qm-logo-name{display:none;}
  .pen-size-wrap{display:none;}
}
</style>
</head>
<body>

<div class="stage-overlay" id="overlay"><div class="stage-overlay-box" id="overlay-txt">Aë‹¨ê³„</div></div>
<div class="toast" id="toast"></div>

<!-- í€µë©”ë‰´ ìˆ¨ê¹€ ì‹œ ë³µì› ë²„íŠ¼ (í•­ìƒ ìµœìƒë‹¨ fixed) -->
<button class="qm-toggle-btn" id="qm-show-btn" onclick="showQuickmenu()">
  <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M2 5l6 6 6-6"/></svg>
  ë©”ë‰´ ë³´ê¸°
</button>

<!-- QUICK MENU -->
<nav class="quickmenu" id="quickmenu">
  <div class="qm-logo">
    <div class="qm-logo-icon" id="logo-icon">ìˆ˜í•™</div>
    <div><div class="qm-logo-name">êµ¬ëª¬ìˆ˜í•™</div><div class="qm-logo-sub">ë‹¨ê³„ë³„ êµì¬ ë·°ì–´</div></div>
  </div>
  <div class="stage-tabs">
    <div class="stage-tab on" data-s="A" onclick="switchStage('A')"><div class="stage-tab-badge">A</div><div><div class="stage-tab-name">Aë‹¨ê³„</div><div class="stage-tab-sub">ê¸°ì´ˆ ì—°ì‚°</div></div></div>
    <div class="stage-tab" data-s="B" onclick="switchStage('B')"><div class="stage-tab-badge">B</div><div><div class="stage-tab-name">Bë‹¨ê³„</div><div class="stage-tab-sub">ì‚¬ì¹™ì—°ì‚°</div></div></div>
    <div class="stage-tab" data-s="C" onclick="switchStage('C')"><div class="stage-tab-badge">C</div><div><div class="stage-tab-name">Cë‹¨ê³„</div><div class="stage-tab-sub">ë¶„ìˆ˜Â·ì†Œìˆ˜</div></div></div>
  </div>
  <div class="qm-progress">
    <div class="prog-row"><span style="color:var(--stage-a);font-weight:700;min-width:14px">A</span><div class="prog-track"><div class="prog-fill a"></div></div><span>65%</span></div>
    <div class="prog-row"><span style="color:var(--stage-b);font-weight:700;min-width:14px">B</span><div class="prog-track"><div class="prog-fill b"></div></div><span>30%</span></div>
    <div class="prog-row"><span style="color:var(--stage-c);font-weight:700;min-width:14px">C</span><div class="prog-track"><div class="prog-fill c"></div></div><span>10%</span></div>
  </div>
  <div class="qm-right">
    <button class="qm-btn" onclick="toggleSidebar()"><svg width="13" height="13" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="1" y="1" width="14" height="14" rx="2"/><line x1="5" y1="1" x2="5" y2="15"/></svg>ëª©ë¡</button>
    <div class="pj-wrap">
      <button class="pj-btn" onclick="togglePJ()"><svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="2" y="2" width="5" height="5" rx="1"/><rect x="9" y="2" width="5" height="5" rx="1"/><rect x="2" y="9" width="5" height="5" rx="1"/><rect x="9" y="9" width="5" height="5" rx="1"/></svg><span id="pj-label">1 / 10</span></button>
      <div class="pj-dropdown" id="pj-dd"></div>
    </div>
    <!-- í€µë©”ë‰´ ìˆ¨ê¸°ê¸° ë²„íŠ¼ -->
    <button class="qm-btn" onclick="hideQuickmenu()" title="í€µë©”ë‰´ ìˆ¨ê¸°ê¸°" style="padding:6px 10px;opacity:0.6;">
      <svg width="13" height="13" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M14 11L8 5l-6 6"/></svg>
    </button>
  </div>
</nav>

<!-- TOOLBAR -->
<div class="toolbar">
  <div class="tb-badge"><div class="tb-dot"></div><span id="tb-label">Aë‹¨ê³„ Â· ê¸°ì´ˆ ì—°ì‚°</span></div>
  <div class="tb-sep"></div>
  <div class="tb-group">
    <button class="tb-btn" onclick="chZoom(-10)">âˆ’</button>
    <span class="zoom-val" id="zoom-val">100%</span>
    <button class="tb-btn" onclick="chZoom(10)">+</button>
    <button class="tb-btn" onclick="resetZoom()">ë§ì¶¤</button>
  </div>
  <div class="tb-sep"></div>
  <div class="tb-group">
    <button class="tb-btn on" id="btn-single" onclick="setLayout('single')">ë‹¨ë©´</button>
    <button class="tb-btn" id="btn-double" onclick="setLayout('double')">ì–‘ë©´</button>
  </div>
  <div class="tb-sep"></div>
  <button class="tb-btn" id="btn-pen-mode" onclick="togglePenMode()" style="display:flex;align-items:center;gap:5px;">
    <svg width="13" height="13" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M11 2l3 3-8 8H3v-3L11 2z"/></svg>í•„ê¸° ëª¨ë“œ
  </button>
  <div class="tb-right"><span class="tb-info" id="tb-info">1 / 10 Â· B5 176Ã—250mm</span></div>
</div>

<!-- í•„ê¸° íˆ´ë°” -->
<div class="pen-toolbar hidden" id="pen-toolbar">
  <div class="tb-group" style="gap:3px;">
    <button class="pen-tool-btn on" id="tool-pen" onclick="setTool('pen')">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M11 2l3 3-8 8H3v-3L11 2z"/></svg><span class="lbl">íœ</span>
    </button>
    <button class="pen-tool-btn" id="tool-highlighter" onclick="setTool('highlighter')">
      <svg viewBox="0 0 16 16" fill="currentColor"><rect x="4" y="7" width="8" height="5" rx="1" opacity="0.6"/><path d="M5 7V4h6v3" fill="none" stroke="currentColor" stroke-width="1.4"/></svg><span class="lbl">í˜•ê´‘</span>
    </button>
    <button class="pen-tool-btn" id="tool-eraser" onclick="setTool('eraser')">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M3 13h10M9 3l4 4-6 6H3l4-4"/></svg><span class="lbl">ì§€ìš°ê°œ</span>
    </button>
  </div>
  <div class="pen-sep"></div>
  <div class="color-palette" id="color-palette">
    <div class="color-dot on"  data-c="#1a1814" style="background:#1a1814" onclick="setColor('#1a1814')"></div>
    <div class="color-dot"     data-c="#e8401c" style="background:#e8401c" onclick="setColor('#e8401c')"></div>
    <div class="color-dot"     data-c="#1a7fd4" style="background:#1a7fd4" onclick="setColor('#1a7fd4')"></div>
    <div class="color-dot"     data-c="#1aad6e" style="background:#1aad6e" onclick="setColor('#1aad6e')"></div>
    <div class="color-dot"     data-c="#f5a623" style="background:#f5a623" onclick="setColor('#f5a623')"></div>
    <div class="color-dot"     data-c="#9b59b6" style="background:#9b59b6" onclick="setColor('#9b59b6')"></div>
  </div>
  <div class="pen-sep"></div>
  <div class="pen-size-wrap">
    <span class="pen-lbl">êµµê¸°</span>
    <input type="range" class="pen-slider" id="pen-size" min="1" max="20" value="3" oninput="updateSize()">
    <div class="pen-preview"><div id="pen-dot" style="border-radius:50%;background:#1a1814;width:3px;height:3px;"></div></div>
  </div>
  <div class="pen-sep"></div>
  <div class="pen-size-wrap">
    <span class="pen-lbl">íˆ¬ëª…ë„</span>
    <input type="range" class="pen-slider" id="pen-opacity" min="10" max="100" value="100" oninput="updateOpacity()">
    <span class="pen-lbl" id="opacity-val">100%</span>
  </div>
  <div class="pen-sep"></div>
  <button class="pen-action-btn" onclick="undoStroke()">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 7H10a3 3 0 010 6H7"/><path d="M6 4L3 7l3 3"/></svg>ë˜ëŒë¦¬ê¸°
  </button>
  <button class="pen-action-btn" onclick="saveAsImage()">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2v8M5 7l3 3 3-3"/><rect x="2" y="11" width="12" height="3" rx="1"/></svg>ì €ì¥
  </button>
  <button class="pen-action-btn danger" onclick="clearPage()">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 13h10M9 3l4 4-6 6H3l4-4"/></svg>í˜ì´ì§€ ì´ˆê¸°í™”
  </button>
  <span class="pen-status" id="pen-status">âœï¸ í•„ê¸° ëª¨ë“œ ì¼œì§</span>
</div>

<!-- BODY -->
<div class="app-body">
  <aside class="sidebar" id="sidebar">
    <div class="sb-head"><div class="sb-dot"></div><span class="sb-head-txt" id="sb-title">Aë‹¨ê³„ í˜ì´ì§€</span></div>
    <div class="sb-scroll" id="thumb-list"></div>
  </aside>
  <div class="viewer" id="viewer">
    <div class="pages-wrap" id="pages-wrap"></div>
  </div>
</div>

<!-- STATUS BAR -->
<div class="statusbar">
  <div class="st-item"><span class="st-k">ë‹¨ê³„</span><span class="st-v" id="st-stage">Aë‹¨ê³„</span></div>
  <div class="st-item"><span class="st-k">í˜ì´ì§€</span><span class="st-v" id="st-page">1/10</span></div>
  <div class="st-item"><span class="st-k">í™•ëŒ€</span><span class="st-v" id="st-zoom">100%</span></div>
  <div class="st-item"><span class="st-k">ë ˆì´ì•„ì›ƒ</span><span class="st-v" id="st-layout">ë‹¨ë©´</span></div>
  <div class="st-item"><span class="st-k">PDF</span><span class="st-v" id="st-pdf">ë¡œë”©ì¤‘...</span></div>
  <div class="st-item"><span class="st-k">í•„ê¸°</span><span class="st-v" id="st-ink">OFF</span></div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// â”€â”€â”€ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STAGE_CFG={
  A:{label:'Aë‹¨ê³„',sub:'ê¸°ì´ˆ ì—°ì‚°',color:'#e8401c',light:'#fde8e3',mid:'#f4a48e',pdf:'êµ¬ëª¬ìˆ˜í•™Aë‹¨ê³„í…ŒìŠ¤íŠ¸10ì¥.pdf'},
  B:{label:'Bë‹¨ê³„',sub:'ì‚¬ì¹™ì—°ì‚°', color:'#1a7fd4',light:'#e0eefc',mid:'#7ab8eb',pdf:'êµ¬ëª¬ìˆ˜í•™Bë‹¨ê³„í…ŒìŠ¤íŠ¸10ì¥.pdf'},
  C:{label:'Cë‹¨ê³„',sub:'ë¶„ìˆ˜Â·ì†Œìˆ˜',color:'#1aad6e',light:'#dcf5eb',mid:'#76d4a8',pdf:'êµ¬ëª¬ìˆ˜í•™Cë‹¨ê³„í…ŒìŠ¤íŠ¸10ì¥.pdf'},
};

// â”€â”€â”€ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let curStage='A', curPage=1, zoom=100, layout='single', sidebarOn=true;
let penMode=false, curTool='pen', penColor='#1a1814', penSize=3, penOpacity=1.0;
let isDrawing=false, curStroke=null;

// inkData[stage][pageNum] = [{tool,color,size,opacity,points:[{x,y,p}]}, ...]
const inkData={A:{},B:{},C:{}};
const pdfCache={};
const totalPages={A:10,B:10,C:10};

// â”€â”€â”€ CSS ë³€ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyColors(s){
  const c=STAGE_CFG[s],r=document.documentElement;
  r.style.setProperty('--stage-color',c.color);
  r.style.setProperty('--stage-light',c.light);
  r.style.setProperty('--stage-mid',c.mid);
}

// â”€â”€â”€ PDF ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPDF(stage){
  if(pdfCache[stage]) return pdfCache[stage];
  try{
    const doc=await pdfjsLib.getDocument(STAGE_CFG[stage].pdf).promise;
    pdfCache[stage]=doc; totalPages[stage]=doc.numPages; return doc;
  }catch(e){console.error('PDF err',stage,e);return null;}
}

async function renderPDFPage(doc,num,canvas){
  try{
    const page=await doc.getPage(num);
    const vp0=page.getViewport({scale:1});
    const scale=665/vp0.width;
    const vp=page.getViewport({scale});
    canvas.width=vp.width; canvas.height=vp.height;
    await page.render({canvasContext:canvas.getContext('2d'),viewport:vp}).promise;
    return {w:vp.width,h:vp.height};
  }catch(e){return null;}
}

async function renderThumb(doc,num,container){
  container.innerHTML='';
  if(!doc) return;
  try{
    const page=await doc.getPage(num);
    const scale=160/page.getViewport({scale:1}).width;
    const vp=page.getViewport({scale});
    const c=document.createElement('canvas');
    c.width=vp.width; c.height=vp.height;
    await page.render({canvasContext:c.getContext('2d'),viewport:vp}).promise;
    container.appendChild(c);
  }catch(e){}
}

// â”€â”€â”€ ë©”ì¸ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderAll(){
  const wrap=document.getElementById('pages-wrap');
  wrap.innerHTML='';
  wrap.className='pages-wrap'+(layout==='double'?' double':'');
  const total=totalPages[curStage];

  for(let i=1;i<=total;i++){
    const pd=document.createElement('div');
    pd.className='b5-page'; pd.dataset.page=i;
    pd.style.animationDelay=(i*0.04)+'s';
    pd.innerHTML=`<div class="page-top-bar"></div><div class="page-loading" id="ld-${i}"><div class="spinner"></div><div class="loading-txt">${i}í˜ì´ì§€ ë¡œë”©ì¤‘...</div></div>`;
    wrap.appendChild(pd);
  }
  applyZoom();

  document.getElementById('st-pdf').textContent='ë¡œë”©ì¤‘...';
  const pdfDoc=await loadPDF(curStage);

  if(!pdfDoc){
    for(let i=1;i<=total;i++){
      const el=document.getElementById(`ld-${i}`);
      if(el){el.className='page-error';el.innerHTML=`<div class="error-icon">ğŸ“„</div><div class="error-txt">PDF ë¡œë“œ ì‹¤íŒ¨<br>${STAGE_CFG[curStage].pdf}</div>`;}
    }
    document.getElementById('st-pdf').textContent='ì˜¤ë¥˜'; return;
  }
  document.getElementById('st-pdf').textContent=`${pdfDoc.numPages}p ë¡œë“œë¨`;
  totalPages[curStage]=pdfDoc.numPages;

  await Promise.all(Array.from({length:pdfDoc.numPages},(_,i)=>i+1).map(async num=>{
    const loading=document.getElementById(`ld-${num}`);
    if(!loading) return;
    const parent=loading.parentElement;

    const pdfCanvas=document.createElement('canvas');
    pdfCanvas.className='pdf-layer';
    const wrap2=document.createElement('div');
    wrap2.className='pdf-canvas-wrap';
    wrap2.appendChild(pdfCanvas);

    const dim=await renderPDFPage(pdfDoc,num,pdfCanvas);

    // í•„ê¸° ì˜¤ë²„ë ˆì´
    const ic=document.createElement('canvas');
    ic.className='ink-canvas'+(penMode?' active':'');
    ic.dataset.stage=curStage; ic.dataset.page=num;
    if(dim){ic.width=dim.w; ic.height=dim.h;}
    wrap2.appendChild(ic);

    restoreInk(ic,curStage,num);
    bindInkEvents(ic);

    parent.removeChild(loading);
    parent.appendChild(wrap2);
  }));

  renderThumbs(pdfDoc);
  buildPJ(); updateUI();
  refreshCanvasModes();
}

// â”€â”€â”€ ì¸ë„¤ì¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderThumbs(pdfDoc){
  const list=document.getElementById('thumb-list');
  list.innerHTML='';
  const total=pdfDoc?pdfDoc.numPages:totalPages[curStage];
  for(let i=1;i<=total;i++){
    const div=document.createElement('div');
    div.className='thumb'+(i===curPage?' on':'');
    div.dataset.page=i; div.onclick=()=>goToPage(i);
    const cw=document.createElement('div');
    cw.className='thumb-canvas-wrap';
    const dot=document.createElement('div');
    dot.className='thumb-ink-dot'; dot.id=`idot-${curStage}-${i}`;
    cw.appendChild(dot);
    div.innerHTML=`<span class="thumb-num">${i}</span>`;
    div.appendChild(cw); list.appendChild(div);
    if(pdfDoc) renderThumb(pdfDoc,i,cw);
    refreshInkDot(curStage,i);
  }
}

function refreshInkDot(stage,p){
  const d=document.getElementById(`idot-${stage}-${p}`);
  if(d) d.classList.toggle('show',!!(inkData[stage][p]&&inkData[stage][p].length));
}

// â”€â”€â”€ í•„ê¸° ì´ë²¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bindInkEvents(canvas){
  canvas.addEventListener('pointerdown', e=>onDown(e,canvas),{passive:false});
  canvas.addEventListener('pointermove', e=>onMove(e,canvas),{passive:false});
  canvas.addEventListener('pointerup',   e=>onUp(e,canvas),  {passive:false});
  canvas.addEventListener('pointerleave',e=>onUp(e,canvas),  {passive:false});
  canvas.addEventListener('contextmenu', e=>e.preventDefault());
}

function pos(e,canvas){
  const r=canvas.getBoundingClientRect();
  return{x:(e.clientX-r.left)*(canvas.width/r.width),y:(e.clientY-r.top)*(canvas.height/r.height),p:e.pressure||1};
}

function onDown(e,canvas){
  if(!penMode) return;
  e.preventDefault(); canvas.setPointerCapture(e.pointerId);
  isDrawing=true;
  const {x,y,p}=pos(e,canvas);
  curStroke={tool:curTool,color:curTool==='eraser'?null:penColor,size:curTool==='eraser'?penSize*4:penSize,opacity:curTool==='highlighter'?Math.min(penOpacity,0.45):penOpacity,points:[{x,y,p}]};
  drawSeg(canvas,curStroke,x,y,x,y,p);
}

function onMove(e,canvas){
  if(!penMode||!isDrawing||!curStroke) return;
  e.preventDefault();
  const {x,y,p}=pos(e,canvas);
  const pts=curStroke.points, prev=pts[pts.length-1];
  pts.push({x,y,p});
  drawSeg(canvas,curStroke,prev.x,prev.y,x,y,p);
}

function onUp(e,canvas){
  if(!penMode||!isDrawing||!curStroke) return;
  isDrawing=false;
  const stage=canvas.dataset.stage, num=parseInt(canvas.dataset.page);
  if(!inkData[stage][num]) inkData[stage][num]=[];
  inkData[stage][num].push({...curStroke});
  saveLS(stage,num); refreshInkDot(stage,num); updatePenStatus();
  curStroke=null;
}

// â”€â”€â”€ íš ê·¸ë¦¬ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawSeg(canvas,stroke,x1,y1,x2,y2,p){
  const ctx=canvas.getContext('2d');
  ctx.save();
  if(stroke.tool==='eraser'){
    ctx.globalCompositeOperation='destination-out';
    ctx.strokeStyle='rgba(0,0,0,1)';
    ctx.lineWidth=stroke.size*(0.5+p*0.5);
  } else {
    ctx.globalCompositeOperation=stroke.tool==='highlighter'?'multiply':'source-over';
    ctx.globalAlpha=stroke.opacity;
    ctx.strokeStyle=stroke.color;
    ctx.lineWidth=stroke.size*(0.4+p*0.6); // Síœ ì••ë ¥ ë°˜ì˜
  }
  ctx.lineCap='round'; ctx.lineJoin='round';
  ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
  ctx.restore();
}

// â”€â”€â”€ í•„ê¸° ë³µì› â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function restoreInk(canvas,stage,num){
  const strokes=inkData[stage][num];
  if(!strokes||!strokes.length) return;
  const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  strokes.forEach(s=>{
    const pts=s.points;
    if(pts.length===1){drawSeg(canvas,s,pts[0].x,pts[0].y,pts[0].x+0.1,pts[0].y+0.1,pts[0].p||1);return;}
    for(let i=1;i<pts.length;i++) drawSeg(canvas,s,pts[i-1].x,pts[i-1].y,pts[i].x,pts[i].y,pts[i].p||1);
  });
}

// â”€â”€â”€ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveLS(stage,num){
  try{localStorage.setItem(`kumon-${stage}-${num}`,JSON.stringify(inkData[stage][num]||[]));}catch(e){}
}
function loadLS(){
  try{
    ['A','B','C'].forEach(s=>{
      for(let p=1;p<=20;p++){
        const raw=localStorage.getItem(`kumon-${s}-${p}`);
        if(raw) inkData[s][p]=JSON.parse(raw);
      }
    });
  }catch(e){}
}

// â”€â”€â”€ ë˜ëŒë¦¬ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function undoStroke(){
  const s=inkData[curStage][curPage];
  if(!s||!s.length){showToast('ë˜ëŒë¦´ í•„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤');return;}
  s.pop(); saveLS(curStage,curPage);
  const c=getIC(curStage,curPage);
  if(c){c.getContext('2d').clearRect(0,0,c.width,c.height);restoreInk(c,curStage,curPage);}
  refreshInkDot(curStage,curPage); updatePenStatus();
  showToast('ë˜ëŒë¦¬ê¸° ì™„ë£Œ');
}

// â”€â”€â”€ í˜ì´ì§€ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clearPage(){
  if(!confirm(`${curPage}í˜ì´ì§€ì˜ ëª¨ë“  í•„ê¸°ë¥¼ ì§€ìš¸ê¹Œìš”?`)) return;
  inkData[curStage][curPage]=[];
  saveLS(curStage,curPage);
  const c=getIC(curStage,curPage);
  if(c) c.getContext('2d').clearRect(0,0,c.width,c.height);
  refreshInkDot(curStage,curPage); updatePenStatus();
  showToast('í•„ê¸° ì´ˆê¸°í™” ì™„ë£Œ');
}

// â”€â”€â”€ ì´ë¯¸ì§€ ì €ì¥ (PDF + í•„ê¸° í•©ì„±) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveAsImage(){
  const pd=document.querySelector(`.b5-page[data-page="${curPage}"]`);
  if(!pd){showToast('í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');return;}
  const pdfC=pd.querySelector('canvas.pdf-layer');
  const inkC=pd.querySelector('canvas.ink-canvas');
  if(!pdfC){showToast('PDFê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');return;}
  const merged=document.createElement('canvas');
  merged.width=pdfC.width; merged.height=pdfC.height;
  const ctx=merged.getContext('2d');
  ctx.drawImage(pdfC,0,0);
  if(inkC) ctx.drawImage(inkC,0,0);
  const a=document.createElement('a');
  a.download=`êµ¬ëª¬ìˆ˜í•™_${curStage}ë‹¨ê³„_${curPage}í˜ì´ì§€.png`;
  a.href=merged.toDataURL('image/png'); a.click();
  showToast(`${curPage}í˜ì´ì§€ ì €ì¥ ì™„ë£Œ ğŸ‰`);
}

// â”€â”€â”€ ë„ìš°ë¯¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getIC(stage,num){return document.querySelector(`.ink-canvas[data-stage="${stage}"][data-page="${num}"]`);}

function refreshCanvasModes(){
  document.querySelectorAll('.ink-canvas').forEach(c=>{
    c.classList.toggle('active',penMode);
    c.classList.toggle('eraser-mode',penMode&&curTool==='eraser');
  });
}

function updatePenStatus(){
  const total=Object.values(inkData[curStage]).reduce((s,a)=>s+(a?a.length:0),0);
  const el=document.getElementById('pen-status');
  el.className='pen-status'+(total?' has-ink':'');
  el.textContent=total?`âœï¸ í•„ê¸° ëª¨ë“œ (${total}íš)`:'âœï¸ í•„ê¸° ëª¨ë“œ ì¼œì§';
}

// â”€â”€â”€ í•„ê¸° ëª¨ë“œ í† ê¸€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function togglePenMode(){
  penMode=!penMode;
  document.getElementById('btn-pen-mode').classList.toggle('on',penMode);
  document.getElementById('pen-toolbar').classList.toggle('hidden',!penMode);
  document.getElementById('st-ink').textContent=penMode?'ON âœï¸':'OFF';
  // í•„ê¸° ì¤‘ ë·°ì–´ ìŠ¤í¬ë¡¤ ì ê¸ˆ
  document.getElementById('viewer').style.overflowY=penMode?'hidden':'auto';
  refreshCanvasModes();
  showToast(penMode?'í•„ê¸° ëª¨ë“œ ì¼œì§ âœï¸  (Pí‚¤ë¡œ í† ê¸€)':'í•„ê¸° ëª¨ë“œ êº¼ì§');
}

// â”€â”€â”€ ë„êµ¬Â·ìƒ‰ìƒÂ·êµµê¸°Â·íˆ¬ëª…ë„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setTool(t){
  curTool=t;
  ['pen','highlighter','eraser'].forEach(x=>document.getElementById(`tool-${x}`).classList.toggle('on',x===t));
  document.getElementById('color-palette').style.opacity=t==='eraser'?'0.3':'1';
  refreshCanvasModes();
}

function setColor(c){
  penColor=c;
  document.querySelectorAll('.color-dot').forEach(d=>d.classList.toggle('on',d.dataset.c===c));
  if(curTool==='eraser') setTool('pen');
}

function updateSize(){
  penSize=parseInt(document.getElementById('pen-size').value);
  const d=document.getElementById('pen-dot');
  d.style.width=d.style.height=penSize+'px';
  d.style.background=penColor;
}

function updateOpacity(){
  const v=parseInt(document.getElementById('pen-opacity').value);
  penOpacity=v/100;
  document.getElementById('opacity-val').textContent=v+'%';
}

// â”€â”€â”€ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown',e=>{
  if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();undoStroke();}
  if(!e.ctrlKey&&!e.metaKey){
    if(e.key==='p'||e.key==='P') togglePenMode();
    if(penMode&&(e.key==='e'||e.key==='E')) setTool('eraser');
    if(penMode&&(e.key==='h'||e.key==='H')) setTool('highlighter');
    if(penMode&&(e.key==='1')) setTool('pen');
    if(e.key==='Escape'&&penMode) togglePenMode();
  }
});

// â”€â”€â”€ í† ìŠ¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  clearTimeout(t._t); t._t=setTimeout(()=>t.classList.remove('show'),2200);
}

// â”€â”€â”€ í˜ì´ì§€ ì´ë™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goToPage(num){
  curPage=num;
  document.querySelector(`.b5-page[data-page="${num}"]`)?.scrollIntoView({behavior:'smooth',block:'start'});
  updateUI(); closePJ();
}

document.getElementById('viewer').addEventListener('scroll',()=>{
  const pages=document.querySelectorAll('.b5-page');
  let cur=1,st=document.getElementById('viewer').scrollTop+120;
  pages.forEach(p=>{if(p.offsetTop<=st) cur=parseInt(p.dataset.page);});
  if(cur!==curPage){curPage=cur;updateUI();}
});

// â”€â”€â”€ UI ì—…ë°ì´íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateUI(){
  const total=totalPages[curStage];
  document.getElementById('pj-label').textContent=`${curPage} / ${total}`;
  document.getElementById('tb-info').textContent=`${curPage} / ${total} Â· B5 176Ã—250mm`;
  document.getElementById('st-page').textContent=`${curPage}/${total}`;
  document.getElementById('st-stage').textContent=STAGE_CFG[curStage].label;
  document.querySelectorAll('.thumb').forEach(t=>t.classList.toggle('on',parseInt(t.dataset.page)===curPage));
  document.querySelectorAll('.pj-item').forEach(d=>d.classList.toggle('on',parseInt(d.textContent)===curPage));
}

// â”€â”€â”€ ë‹¨ê³„ ì „í™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchStage(s){
  if(s===curStage) return;
  curStage=s; curPage=1;
  const c=STAGE_CFG[s];
  const ov=document.getElementById('overlay');
  document.getElementById('overlay-txt').textContent=c.label;
  document.getElementById('overlay-txt').style.background=c.color;
  ov.classList.add('show'); setTimeout(()=>ov.classList.remove('show'),650);
  applyColors(s);
  document.querySelectorAll('.stage-tab').forEach(t=>t.classList.toggle('on',t.dataset.s===s));
  document.getElementById('logo-icon').textContent=c.label.slice(0,2);
  document.getElementById('tb-label').textContent=`${c.label} Â· ${c.sub}`;
  document.getElementById('sb-title').textContent=`${c.label} í˜ì´ì§€`;
  renderAll();
}

// â”€â”€â”€ ì¤Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function chZoom(d){zoom=Math.max(50,Math.min(200,zoom+d));applyZoom();}
function resetZoom(){zoom=100;applyZoom();}
function applyZoom(){
  const w=document.getElementById('pages-wrap');
  w.style.transform=`scale(${zoom/100})`;
  w.style.marginBottom=`${w.scrollHeight*(zoom/100-1)}px`;
  document.getElementById('zoom-val').textContent=zoom+'%';
  document.getElementById('st-zoom').textContent=zoom+'%';
}

// â”€â”€â”€ ë ˆì´ì•„ì›ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setLayout(v){
  layout=v;
  document.getElementById('btn-single').classList.toggle('on',v==='single');
  document.getElementById('btn-double').classList.toggle('on',v==='double');
  document.getElementById('st-layout').textContent=v==='single'?'ë‹¨ë©´':'ì–‘ë©´';
  document.getElementById('pages-wrap').className='pages-wrap'+(v==='double'?' double':'');
}

// â”€â”€â”€ ì‚¬ì´ë“œë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSidebar(){
  sidebarOn=!sidebarOn;
  document.getElementById('sidebar').classList.toggle('hidden',!sidebarOn);
}

// â”€â”€â”€ í˜ì´ì§€ ì í”„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPJ(){
  const dd=document.getElementById('pj-dd'); dd.innerHTML='';
  for(let i=1;i<=totalPages[curStage];i++){
    const d=document.createElement('div');
    d.className='pj-item'+(i===curPage?' on':'');
    d.textContent=i; d.onclick=()=>goToPage(i);
    dd.appendChild(d);
  }
}
function togglePJ(){document.getElementById('pj-dd').classList.toggle('open');}
function closePJ(){document.getElementById('pj-dd').classList.remove('open');}
document.addEventListener('click',e=>{if(!e.target.closest('.pj-wrap')) closePJ();});

// â”€â”€â”€ í€µë©”ë‰´ ìˆ¨ê¸°ê¸° / ë³´ì´ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hideQuickmenu(){
  document.getElementById('quickmenu').classList.add('qm-hidden');
  document.getElementById('qm-show-btn').classList.add('show');
  showToast('í€µë©”ë‰´ ìˆ¨ê¹€ â€” ìƒë‹¨ ë²„íŠ¼ìœ¼ë¡œ ë‹¤ì‹œ ì—´ ìˆ˜ ìˆìŠµë‹ˆë‹¤');
}
function showQuickmenu(){
  document.getElementById('quickmenu').classList.remove('qm-hidden');
  document.getElementById('qm-show-btn').classList.remove('show');
}

// â”€â”€â”€ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadLS();
applyColors('A');
buildPJ();
renderAll();

// URL íŒŒë¼ë¯¸í„°ë¡œ ë‹¨ê³„ ì§ì ‘ ì§„ì… (?stage=B)
const urlStage = new URLSearchParams(location.search).get('stage');
if(urlStage && ['A','B','C'].includes(urlStage)) switchStage(urlStage);

// â”€â”€â”€ PWA Service Worker ë“±ë¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if('serviceWorker' in navigator){
  window.addEventListener('load', async ()=>{
    try{
      const reg = await navigator.serviceWorker.register('sw.js');
      console.log('[PWA] Service Worker ë“±ë¡ ì„±ê³µ:', reg.scope);

      // ìƒˆ ë²„ì „ ê°ì§€ ì‹œ í† ìŠ¤íŠ¸ ì•Œë¦¼
      reg.addEventListener('updatefound', ()=>{
        const newWorker = reg.installing;
        newWorker.addEventListener('statechange', ()=>{
          if(newWorker.state === 'installed' && navigator.serviceWorker.controller){
            showToast('ìƒˆ ë²„ì „ì´ ìˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤! ğŸ”„');
          }
        });
      });
    }catch(e){
      console.log('[PWA] Service Worker ë“±ë¡ ì‹¤íŒ¨:', e);
    }
  });
}

// â”€â”€â”€ PWA ì„¤ì¹˜ ë°°ë„ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let deferredInstallPrompt = null;

window.addEventListener('beforeinstallprompt', e=>{
  e.preventDefault();
  deferredInstallPrompt = e;
  showInstallBanner();
});

function showInstallBanner(){
  // ì´ë¯¸ ì„¤ì¹˜ëìœ¼ë©´ í‘œì‹œ ì•ˆ í•¨
  if(window.matchMedia('(display-mode: standalone)').matches) return;
  if(localStorage.getItem('pwa-install-dismissed')) return;

  const banner = document.createElement('div');
  banner.id = 'install-banner';
  banner.style.cssText = `
    position:fixed;bottom:40px;left:50%;transform:translateX(-50%);
    background:#1e1c18;color:#d0c8b8;
    padding:14px 20px;border-radius:12px;
    font-family:'Noto Sans KR',sans-serif;font-size:13px;
    box-shadow:0 8px 32px rgba(0,0,0,0.4);
    border:1px solid rgba(255,255,255,0.12);
    display:flex;align-items:center;gap:14px;
    z-index:9999;white-space:nowrap;
    animation:slideUp 0.3s ease;
  `;
  banner.innerHTML = `
    <span>ğŸ“± ì´ ì•±ì„ í™ˆí™”ë©´ì— ì„¤ì¹˜í•  ìˆ˜ ìˆì–´ìš”!</span>
    <button onclick="installPWA()" style="
      background:var(--stage-color);color:white;border:none;
      padding:7px 16px;border-radius:7px;font-family:'Noto Sans KR',sans-serif;
      font-size:12px;font-weight:700;cursor:pointer;">ì„¤ì¹˜í•˜ê¸°</button>
    <button onclick="dismissInstall()" style="
      background:none;border:none;color:#9a9488;
      font-size:16px;cursor:pointer;padding:0 4px;">âœ•</button>
  `;

  // slideUp ì• ë‹ˆë©”ì´ì…˜
  const style = document.createElement('style');
  style.textContent = '@keyframes slideUp{from{opacity:0;transform:translateX(-50%) translateY(16px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}';
  document.head.appendChild(style);
  document.body.appendChild(banner);
}

async function installPWA(){
  if(!deferredInstallPrompt) return;
  deferredInstallPrompt.prompt();
  const {outcome} = await deferredInstallPrompt.userChoice;
  if(outcome === 'accepted'){
    showToast('ì•± ì„¤ì¹˜ ì™„ë£Œ! ğŸ‰ í™ˆí™”ë©´ì—ì„œ ë°”ë¡œ ì—´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
  }
  deferredInstallPrompt = null;
  const banner = document.getElementById('install-banner');
  if(banner) banner.remove();
}

function dismissInstall(){
  const banner = document.getElementById('install-banner');
  if(banner) banner.remove();
  localStorage.setItem('pwa-install-dismissed', '1');
}

// ì´ë¯¸ ì„¤ì¹˜ëœ ê²½ìš° (standalone ëª¨ë“œ) ìƒíƒœë°”ì— í‘œì‹œ
if(window.matchMedia('(display-mode: standalone)').matches){
  document.title = 'êµ¬ëª¬ìˆ˜í•™ êµì¬ ë·°ì–´';
  // ìƒíƒœë°”ì— ì•± ëª¨ë“œ í‘œì‹œ
  setTimeout(()=>showToast('ì•± ëª¨ë“œë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤ ğŸ“±'), 1000);
}
</script>
</body>
</html>
