<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>êµ¬ëª¬ìˆ˜í•™ ë‹¨ê³„ë³„ êµì¬ ë·°ì–´</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#e8401c">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ìˆ˜í•™ë·°ì–´">
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
<link rel="apple-touch-icon" href="icons/icon-152.png">

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
/* â•â• CSS ë³€ìˆ˜ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:#f0ede8; --stage-a:#e8401c; --stage-a-light:#fde8e3; --stage-a-mid:#f4a48e;
  --stage-b:#1a7fd4; --stage-b-light:#e0eefc; --stage-b-mid:#7ab8eb;
  --stage-c:#1aad6e; --stage-c-light:#dcf5eb; --stage-c-mid:#76d4a8;
  --ink:#1a1814; --ink-mid:#4a4540; --ink-light:#9a9088;
  --paper:#fffef9; --ui-bg:#ffffff; --ui-border:#e0dbd2;
  --shadow-sm:0 2px 8px rgba(0,0,0,0.08); --shadow-lg:0 12px 48px rgba(0,0,0,0.18);
  --stage-color:var(--stage-a); --stage-light:var(--stage-a-light); --stage-mid:var(--stage-a-mid);
}
body.dark {
  --bg:#1a1814; --ui-bg:#1e1c18; --ui-border:#2a2822; --paper:#22201a;
  --ink:#d0c8b8; --ink-mid:#9a9488; --ink-light:#5a5850;
}
body.dark { background:#12100c; }
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);height:100vh;overflow:hidden;display:flex;flex-direction:column;transition:background 0.3s;}

/* â•â• ì ê¸ˆ / í”„ë¡œí•„ ì„ íƒ í™”ë©´ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#lock-screen{
  position:fixed;inset:0;z-index:9999;
  background:#0e0c0a;
  display:flex;align-items:center;justify-content:center;flex-direction:column;
  overflow:hidden;
}
#lock-screen.hidden{display:none;}

/* ë°°ê²½ ê·¸ë¼ë””ì–¸íŠ¸ orbs */
#lock-screen::before{
  content:'';position:absolute;width:600px;height:600px;border-radius:50%;
  background:radial-gradient(circle,rgba(232,64,28,0.12) 0%,transparent 70%);
  top:-100px;left:-100px;pointer-events:none;
}
#lock-screen::after{
  content:'';position:absolute;width:500px;height:500px;border-radius:50%;
  background:radial-gradient(circle,rgba(26,127,212,0.1) 0%,transparent 70%);
  bottom:-100px;right:-100px;pointer-events:none;
}

/* â”€â”€ í”„ë¡œí•„ ì„ íƒ í™”ë©´ â”€â”€ */
#profile-select{display:flex;flex-direction:column;align-items:center;gap:0;width:100%;max-width:900px;padding:20px;}
#profile-select.hidden{display:none;}

.ls-header{text-align:center;margin-bottom:40px;}
.ls-logo-row{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:12px;}
.ls-logo-icon{width:44px;height:44px;border-radius:12px;background:var(--stage-a);display:flex;align-items:center;justify-content:center;color:white;font-weight:900;font-size:16px;box-shadow:0 4px 20px rgba(232,64,28,0.4);}
.ls-app-name{font-size:22px;font-weight:900;color:#d0c8b8;letter-spacing:-0.02em;}
.ls-subtitle{font-size:13px;color:#4a4840;letter-spacing:0.05em;font-family:'DM Mono',monospace;}

.profiles-grid{
  display:flex;flex-wrap:wrap;gap:20px;justify-content:center;
  max-width:860px;margin-bottom:32px;
}

.profile-card{
  display:flex;flex-direction:column;align-items:center;gap:10px;
  cursor:pointer;padding:16px 12px;border-radius:16px;
  border:2px solid transparent;background:transparent;
  transition:all 0.2s;width:120px;
  animation:cardIn 0.4s ease both;
}
.profile-card:hover{background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.1);transform:translateY(-4px);}
.profile-card:hover .profile-avatar{box-shadow:0 8px 32px rgba(0,0,0,0.5),0 0 0 3px var(--avatar-color,#e8401c);}
@keyframes cardIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

.profile-avatar{
  width:80px;height:80px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:32px;font-weight:900;color:white;
  box-shadow:0 4px 16px rgba(0,0,0,0.4);
  transition:all 0.2s;
  border:3px solid rgba(255,255,255,0.15);
  flex-shrink:0;
}
.profile-name{font-size:13px;font-weight:700;color:#c0b8a8;text-align:center;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.profile-stage-badge{font-size:10px;font-family:'DM Mono',monospace;padding:2px 8px;border-radius:20px;background:rgba(255,255,255,0.07);color:#6a6860;}
.profile-progress-mini{width:60px;height:3px;background:#2a2820;border-radius:2px;overflow:hidden;}
.profile-progress-mini-fill{height:100%;border-radius:2px;transition:width 0.4s;}

/* ê´€ë¦¬ì ì¹´ë“œ */
.profile-card.admin .profile-avatar{background:linear-gradient(135deg,#2a2822,#3a3830);font-size:26px;}
.profile-card.admin .profile-name{color:#5a5850;}

/* í•™ìƒ ì¶”ê°€ ì¹´ë“œ */
.profile-card.add-btn .profile-avatar{background:rgba(255,255,255,0.05);border:2px dashed #3a3830;font-size:28px;color:#4a4840;}
.profile-card.add-btn:hover .profile-avatar{border-color:#6a6860;color:#8a8880;}

.ls-admin-hint{font-size:10px;color:#2a2820;font-family:'DM Mono',monospace;cursor:pointer;transition:color 0.15s;}
.ls-admin-hint:hover{color:#4a4840;}

/* â”€â”€ PIN ì…ë ¥ í™”ë©´ â”€â”€ */
#pin-screen{display:none;flex-direction:column;align-items:center;gap:0;}
#pin-screen.show{display:flex;}

.pin-back-btn{
  display:flex;align-items:center;gap:8px;
  color:#5a5850;font-size:12px;cursor:pointer;
  margin-bottom:28px;align-self:flex-start;
  font-family:'DM Mono',monospace;transition:color 0.15s;
  padding:6px 12px;border-radius:8px;border:1px solid #2a2820;background:transparent;
}
.pin-back-btn:hover{color:#9a9488;border-color:#3a3830;}

.pin-user-avatar{
  width:88px;height:88px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:36px;font-weight:900;color:white;
  margin-bottom:16px;
  box-shadow:0 8px 32px rgba(0,0,0,0.5);
}
.pin-user-name{font-size:18px;font-weight:700;color:#d0c8b8;margin-bottom:6px;}
.pin-user-sub{font-size:11px;color:#4a4840;font-family:'DM Mono',monospace;margin-bottom:28px;}

.pin-dots{display:flex;gap:12px;margin-bottom:28px;}
.pin-dot{width:14px;height:14px;border-radius:50%;border:2px solid #3a3830;background:transparent;transition:all 0.15s;}
.pin-dot.filled{background:var(--avatar-color,#e8401c);border-color:var(--avatar-color,#e8401c);}
.pin-dot.error{background:#ff6b6b;border-color:#ff6b6b;animation:shake 0.3s;}
.pin-dot.success{background:#1aad6e;border-color:#1aad6e;}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
.pin-hint-txt{font-size:11px;color:#2a2820;margin-bottom:16px;font-family:'DM Mono',monospace;}
.pin-hint-txt span{color:#f5a623;}

.pin-keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;width:220px;}
.kp{height:56px;border-radius:12px;background:#1a1814;border:1px solid #2a2820;color:#c0b8a8;font-size:20px;font-weight:500;font-family:'DM Mono',monospace;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.12s;user-select:none;}
.kp:hover{background:#242018;border-color:#3a3830;}
.kp:active{transform:scale(0.94);background:#2a2420;}
.kp.wide{grid-column:span 2;}
.kp.del{font-size:16px;color:#6a6860;}

/* â•â• ê´€ë¦¬ì / í•™ìƒ ê´€ë¦¬ ëª¨ë‹¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#admin-modal{position:fixed;inset:0;z-index:9998;background:rgba(0,0,0,0.75);display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
#admin-modal.open{display:flex;}
.am-box{background:#1a1814;border:1px solid #2a2820;border-radius:20px;padding:0;width:min(500px,95vw);max-height:88vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 24px 80px rgba(0,0,0,0.7);}
.am-header{padding:18px 22px 14px;border-bottom:1px solid #2a2820;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.am-title{font-size:15px;font-weight:700;color:#d0c8b8;}
.am-close-x{width:28px;height:28px;border-radius:50%;border:1px solid #2a2820;background:none;color:#6a6860;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;}
.am-close-x:hover{background:#2a2820;color:#d0c8b8;}
.am-body{padding:16px 22px 22px;overflow-y:auto;display:flex;flex-direction:column;gap:18px;}
.am-section-title{font-size:10px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:#4a4840;margin-bottom:10px;}
.am-lbl{font-size:11px;color:#6a6860;margin-bottom:4px;}
.am-inp{padding:8px 12px;border-radius:8px;border:1.5px solid #2a2820;background:#141210;font-family:'DM Mono',monospace;font-size:14px;color:#d0c8b8;outline:none;width:100%;}
.am-inp:focus{border-color:var(--stage-color);}
.am-row{display:flex;flex-direction:column;gap:6px;}
.am-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:4px;}
.am-cancel{padding:8px 16px;border-radius:8px;border:1px solid #2a2820;background:none;font-family:'Noto Sans KR',sans-serif;font-size:12px;color:#6a6860;cursor:pointer;transition:all 0.15s;}
.am-cancel:hover{background:#2a2820;color:#d0c8b8;}
.am-save{padding:8px 16px;border-radius:8px;border:none;background:var(--stage-color);color:white;font-family:'Noto Sans KR',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:opacity 0.15s;}
.am-save:hover{opacity:0.85;}
.am-divider{height:1px;background:#2a2820;}
/* í•™ìƒ ëª©ë¡ */
.student-list{display:flex;flex-direction:column;gap:8px;}
.student-item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;background:#141210;border:1px solid #2a2820;}
.student-item-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:900;color:white;flex-shrink:0;}
.student-item-info{flex:1;}
.student-item-name{font-size:13px;font-weight:700;color:#d0c8b8;}
.student-item-sub{font-size:10px;color:#4a4840;font-family:'DM Mono',monospace;}
.student-item-btns{display:flex;gap:6px;}
.student-edit-btn,.student-del-btn{padding:4px 10px;border-radius:6px;border:1px solid #2a2820;background:none;font-size:11px;cursor:pointer;font-family:'Noto Sans KR',sans-serif;transition:all 0.15s;}
.student-edit-btn{color:#6a6860;}.student-edit-btn:hover{background:#2a2820;color:#d0c8b8;}
.student-del-btn{color:#e8401c;border-color:rgba(232,64,28,0.2);opacity:0.6;}.student-del-btn:hover{background:rgba(232,64,28,0.1);opacity:1;}
.add-student-form{background:#141210;border:1px solid #2a2820;border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:10px;}
.add-student-form.hidden{display:none;}
.avatar-picker{display:flex;gap:6px;flex-wrap:wrap;}
.avatar-opt{width:32px;height:32px;border-radius:50%;cursor:pointer;border:2px solid transparent;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all 0.15s;}
.avatar-opt:hover{transform:scale(1.1);}
.avatar-opt.on{border-color:white;transform:scale(1.15);}

/* â•â• QUICK MENU â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.quickmenu{height:60px;background:var(--ui-bg);border-bottom:1px solid var(--ui-border);box-shadow:var(--shadow-sm);display:flex;align-items:center;padding:0 20px;flex-shrink:0;position:sticky;top:0;z-index:9999;min-height:60px;overflow:visible;}
.quickmenu.qm-hidden{height:0;min-height:0;padding:0;overflow:hidden;border:none;box-shadow:none;}
.qm-toggle-btn{position:fixed;top:8px;left:50%;transform:translateX(-50%);z-index:10000;background:var(--stage-color);color:white;border:none;border-radius:20px;padding:4px 16px;font-size:11px;font-family:'DM Mono',monospace;cursor:pointer;transition:all 0.25s;box-shadow:0 2px 8px rgba(0,0,0,0.2);display:none;align-items:center;gap:5px;white-space:nowrap;}
.qm-toggle-btn.show{display:flex;}
.qm-logo{display:flex;align-items:center;gap:10px;padding-right:20px;border-right:1px solid var(--ui-border);margin-right:12px;}
.qm-logo-icon{width:36px;height:36px;border-radius:9px;background:var(--stage-color);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:13px;transition:background 0.4s;font-family:'DM Mono',monospace;}
.qm-logo-name{font-size:14px;font-weight:700;color:var(--ink);}
.qm-logo-sub{font-size:10px;color:var(--ink-light);}
.stage-tabs{display:flex;align-items:center;gap:4px;}
.stage-tab{display:flex;align-items:center;gap:8px;padding:7px 16px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all 0.2s;user-select:none;}
.stage-tab-badge{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'DM Mono',monospace;font-size:13px;font-weight:600;transition:all 0.2s;}
.stage-tab-name{font-size:13px;font-weight:700;transition:color 0.2s;}
.stage-tab-sub{font-size:10px;color:var(--ink-light);}
.stage-tab[data-s="A"] .stage-tab-badge{background:var(--stage-a-light);color:var(--stage-a);}
.stage-tab[data-s="A"]:hover,.stage-tab[data-s="A"].on{background:var(--stage-a-light);}
.stage-tab[data-s="A"].on{border-color:var(--stage-a);}
.stage-tab[data-s="A"].on .stage-tab-badge{background:var(--stage-a);color:white;}
.stage-tab[data-s="A"].on .stage-tab-name{color:var(--stage-a);}
.stage-tab[data-s="B"] .stage-tab-badge{background:var(--stage-b-light);color:var(--stage-b);}
.stage-tab[data-s="B"]:hover,.stage-tab[data-s="B"].on{background:var(--stage-b-light);}
.stage-tab[data-s="B"].on{border-color:var(--stage-b);}
.stage-tab[data-s="B"].on .stage-tab-badge{background:var(--stage-b);color:white;}
.stage-tab[data-s="B"].on .stage-tab-name{color:var(--stage-b);}
.stage-tab[data-s="C"] .stage-tab-badge{background:var(--stage-c-light);color:var(--stage-c);}
.stage-tab[data-s="C"]:hover,.stage-tab[data-s="C"].on{background:var(--stage-c-light);}
.stage-tab[data-s="C"].on{border-color:var(--stage-c);}
.stage-tab[data-s="C"].on .stage-tab-badge{background:var(--stage-c);color:white;}
.stage-tab[data-s="C"].on .stage-tab-name{color:var(--stage-c);}
.qm-progress{display:flex;flex-direction:column;gap:5px;padding:0 16px;border-left:1px solid var(--ui-border);margin-left:8px;min-width:130px;}
.prog-row{display:flex;align-items:center;gap:6px;font-size:10px;color:var(--ink-light);font-family:'DM Mono',monospace;}
.prog-track{flex:1;height:4px;background:#e8e0d0;border-radius:2px;overflow:hidden;}
.prog-fill{height:100%;border-radius:2px;transition:width 0.4s;}
.prog-fill.a{background:var(--stage-a);}
.prog-fill.b{background:var(--stage-b);}
.prog-fill.c{background:var(--stage-c);}
.qm-right{margin-left:auto;display:flex;align-items:center;gap:8px;}
.qm-btn{display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:6px;border:1px solid var(--ui-border);background:none;font-family:'Noto Sans KR',sans-serif;font-size:11px;color:var(--ink-mid);cursor:pointer;transition:all 0.15s;white-space:nowrap;}
.qm-btn:hover{background:var(--bg);}
.qm-btn.on{background:var(--stage-light);border-color:var(--stage-mid);color:var(--stage-color);}
.pj-wrap{position:relative;}
.pj-btn{display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:6px;border:2px solid var(--stage-color);background:none;font-family:'DM Mono',monospace;font-size:12px;color:var(--stage-color);cursor:pointer;transition:all 0.2s;min-width:88px;justify-content:center;}
.pj-btn:hover{background:var(--stage-light);}
.pj-dropdown{position:absolute;top:calc(100% + 8px);right:0;background:var(--ui-bg);border:1px solid var(--ui-border);border-radius:12px;box-shadow:var(--shadow-lg);padding:12px;display:none;grid-template-columns:repeat(5,1fr);gap:4px;width:220px;z-index:500;}
.pj-dropdown.open{display:grid;}
.pj-item{aspect-ratio:1;border-radius:6px;display:flex;align-items:center;justify-content:center;font-family:'DM Mono',monospace;font-size:11px;color:var(--ink-mid);cursor:pointer;transition:all 0.15s;border:1.5px solid transparent;}
.pj-item:hover{background:var(--stage-light);color:var(--stage-color);border-color:var(--stage-mid);}
.pj-item.on{background:var(--stage-color);color:white;}
.pj-item.done{background:var(--stage-c-light);color:#1aad6e;border-color:#1aad6e;}

/* â•â• TOOLBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toolbar{height:44px;flex-shrink:0;min-height:44px;background:var(--ui-bg);border-bottom:1px solid var(--ui-border);display:flex;align-items:center;padding:0 16px;gap:8px;z-index:9998;overflow-x:auto;}
.tb-badge{display:flex;align-items:center;gap:6px;padding:4px 12px;border-radius:6px;background:var(--stage-light);font-size:12px;font-weight:700;color:var(--stage-color);transition:all 0.4s;flex-shrink:0;}
.tb-dot{width:7px;height:7px;border-radius:50%;background:var(--stage-color);transition:background 0.4s;}
.tb-sep{width:1px;height:20px;background:var(--ui-border);flex-shrink:0;}
.tb-group{display:flex;align-items:center;gap:2px;flex-shrink:0;}
.tb-btn{padding:4px 10px;border-radius:5px;border:1px solid transparent;background:none;font-family:'Noto Sans KR',sans-serif;font-size:11px;color:var(--ink-mid);cursor:pointer;transition:all 0.15s;white-space:nowrap;}
.tb-btn:hover{background:var(--bg);border-color:var(--ui-border);}
.tb-btn.on{background:var(--stage-light);border-color:var(--stage-mid);color:var(--stage-color);}
.zoom-val{font-family:'DM Mono',monospace;font-size:11px;color:var(--stage-color);min-width:38px;text-align:center;}
.tb-right{margin-left:auto;display:flex;align-items:center;gap:8px;flex-shrink:0;}
.tb-info{font-family:'DM Mono',monospace;font-size:11px;color:var(--ink-light);}

/* â•â• í•„ê¸° íˆ´ë°” â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pen-toolbar{height:52px;flex-shrink:0;background:#1e1c18;border-bottom:2px solid var(--stage-color);display:flex;align-items:center;padding:0 16px;gap:10px;transition:border-color 0.4s;overflow-x:auto;}
.pen-toolbar.hidden{display:none;}
.pen-tool-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;width:40px;height:36px;border-radius:7px;border:1.5px solid transparent;background:none;cursor:pointer;transition:all 0.15s;flex-shrink:0;gap:2px;color:#9a9488;}
.pen-tool-btn svg{width:18px;height:18px;}
.pen-tool-btn .lbl{font-size:8px;font-family:'DM Mono',monospace;}
.pen-tool-btn:hover{background:rgba(255,255,255,0.07);color:#d0c8b8;}
.pen-tool-btn.on{background:rgba(255,255,255,0.12);border-color:var(--stage-color);color:var(--stage-color);}
.pen-sep{width:1px;height:28px;background:rgba(255,255,255,0.1);flex-shrink:0;}
.color-palette{display:flex;align-items:center;gap:5px;flex-shrink:0;}
.color-dot{width:22px;height:22px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all 0.15s;flex-shrink:0;}
.color-dot:hover{transform:scale(1.15);}
.color-dot.on{border-color:white;transform:scale(1.2);box-shadow:0 0 0 2px rgba(255,255,255,0.3);}
.pen-size-wrap{display:flex;align-items:center;gap:8px;flex-shrink:0;}
.pen-lbl{font-size:10px;color:#9a9488;font-family:'DM Mono',monospace;white-space:nowrap;}
.pen-slider{-webkit-appearance:none;width:80px;height:4px;border-radius:2px;background:#3a3830;outline:none;cursor:pointer;}
.pen-slider::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--stage-color);cursor:pointer;}
.pen-preview{width:28px;height:28px;border-radius:50%;background:#2a2822;border:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.pen-action-btn{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.15);background:none;font-family:'Noto Sans KR',sans-serif;font-size:11px;color:#9a9488;cursor:pointer;transition:all 0.15s;white-space:nowrap;flex-shrink:0;}
.pen-action-btn:hover{background:rgba(255,255,255,0.07);color:#d0c8b8;}
.pen-action-btn.danger:hover{background:rgba(232,64,28,0.15);color:#e8401c;border-color:rgba(232,64,28,0.3);}
.pen-action-btn svg{width:13px;height:13px;}
.pen-status{margin-left:auto;font-size:10px;color:#5a5850;font-family:'DM Mono',monospace;white-space:nowrap;flex-shrink:0;}
.pen-status.has-ink{color:#9a9488;}

/* â•â• íƒ€ì´ë¨¸ ë°” â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.timer-bar{height:38px;flex-shrink:0;background:var(--ui-bg);border-bottom:1px solid var(--ui-border);display:flex;align-items:center;padding:0 16px;gap:12px;}
.timer-bar.hidden{display:none;}
.timer-display{font-family:'DM Mono',monospace;font-size:16px;font-weight:500;color:var(--stage-color);min-width:60px;letter-spacing:0.08em;}
.timer-display.warn{color:#e8401c;animation:blink 1s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.5}}
.timer-btn{padding:4px 10px;border-radius:5px;border:1px solid var(--ui-border);background:none;font-family:'Noto Sans KR',sans-serif;font-size:11px;color:var(--ink-mid);cursor:pointer;transition:all 0.15s;}
.timer-btn:hover{background:var(--bg);}
.timer-btn.on{background:var(--stage-light);border-color:var(--stage-mid);color:var(--stage-color);}
.timer-goal-sel{font-family:'DM Mono',monospace;font-size:11px;border:1px solid var(--ui-border);border-radius:4px;padding:2px 4px;background:var(--bg);color:var(--ink);}

/* â•â• BODY & SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app-body{display:flex;flex:1;overflow:hidden;}
.sidebar{width:200px;flex-shrink:0;background:var(--ui-bg);border-right:1px solid var(--ui-border);display:flex;flex-direction:column;overflow:hidden;transition:width 0.3s,opacity 0.3s;}
.sidebar.hidden{width:0;opacity:0;pointer-events:none;}
.sb-head{padding:12px 14px 10px;border-bottom:1px solid var(--ui-border);display:flex;align-items:center;gap:7px;flex-shrink:0;}
.sb-dot{width:8px;height:8px;border-radius:50%;background:var(--stage-color);transition:background 0.4s;flex-shrink:0;}
.sb-head-txt{font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--ink-light);white-space:nowrap;}
.sb-scroll{flex:1;overflow-y:auto;padding:10px 8px;display:flex;flex-direction:column;gap:5px;scrollbar-width:thin;scrollbar-color:var(--ui-border) transparent;}
.thumb{display:flex;align-items:flex-start;gap:6px;cursor:pointer;padding:3px;border-radius:6px;transition:all 0.15s;}
.thumb:hover{background:var(--bg);}
.thumb.on{background:var(--stage-light);}
.thumb-num{font-family:'DM Mono',monospace;font-size:10px;color:var(--ink-light);min-width:18px;text-align:right;padding-top:3px;flex-shrink:0;}
.thumb.on .thumb-num{color:var(--stage-color);font-weight:600;}
.thumb-canvas-wrap{flex:1;aspect-ratio:176/250;background:var(--paper);border-radius:2px;border:1.5px solid var(--ui-border);overflow:hidden;position:relative;}
.thumb.on .thumb-canvas-wrap{border-color:var(--stage-color);}
.thumb-canvas-wrap canvas{width:100%!important;height:100%!important;display:block;}
.thumb-ink-dot{position:absolute;top:3px;right:3px;width:6px;height:6px;border-radius:50%;background:var(--stage-color);display:none;}
.thumb-ink-dot.show{display:block;}
.thumb-check{position:absolute;top:3px;left:3px;width:14px;height:14px;border-radius:50%;background:#1aad6e;color:white;font-size:9px;display:none;align-items:center;justify-content:center;}
.thumb-check.show{display:flex;}

/* â•â• VIEWER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.viewer{flex:1;overflow:auto;position:relative;scrollbar-width:thin;scrollbar-color:var(--ui-border) transparent;background:radial-gradient(ellipse at 20% 10%,rgba(200,169,110,0.04) 0%,transparent 55%),var(--bg);}
.pages-wrap{display:flex;flex-direction:column;align-items:center;padding:40px 60px 80px;gap:32px;transform-origin:top center;}
.pages-wrap.double{flex-direction:row;flex-wrap:wrap;justify-content:center;align-items:flex-start;}
.b5-page{width:176mm;flex-shrink:0;position:relative;background:var(--paper);border-radius:2px;box-shadow:0 2px 6px rgba(0,0,0,0.08),0 8px 24px rgba(0,0,0,0.12),0 20px 56px rgba(0,0,0,0.1);overflow:hidden;transition:box-shadow 0.3s;animation:pageIn 0.4s ease both;}
@keyframes pageIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.page-top-bar{height:5px;background:var(--stage-color);transition:background 0.4s;}
.page-done-badge{position:absolute;top:12px;right:12px;z-index:20;width:28px;height:28px;border-radius:50%;background:#1aad6e;color:white;font-size:14px;display:none;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(26,173,110,0.4);}
.page-done-badge.show{display:flex;}
.pdf-canvas-wrap{width:176mm;position:relative;background:var(--paper);}
.pdf-canvas-wrap canvas.pdf-layer{display:block;width:100%!important;}
.ink-canvas{position:absolute;top:0;left:0;width:100%!important;height:100%!important;pointer-events:none;z-index:10;touch-action:none;}
.ink-canvas.active{pointer-events:all;cursor:crosshair;}
.ink-canvas.eraser-mode{cursor:cell;}
.page-loading{width:176mm;height:250mm;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;background:var(--paper);}
.spinner{width:36px;height:36px;border-radius:50%;border:3px solid var(--stage-light);border-top-color:var(--stage-color);animation:spin 0.8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-txt{font-size:11px;color:var(--ink-light);font-family:'DM Mono',monospace;}
.page-error{width:176mm;height:250mm;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;background:var(--paper);}
.error-icon{font-size:32px;opacity:0.4;}
.error-txt{font-size:11px;color:var(--ink-light);text-align:center;line-height:1.6;}

/* â•â• ìŒì„± ì±„ì  ëª¨ë‹¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#voice-modal{position:fixed;inset:0;z-index:8000;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;}
#voice-modal.open{display:flex;}
.vm-box{background:var(--ui-bg);border-radius:20px;padding:28px 24px;width:min(380px,90vw);box-shadow:var(--shadow-lg);display:flex;flex-direction:column;align-items:center;gap:14px;}
.vm-title{font-size:15px;font-weight:700;color:var(--ink);}
.vm-sub{font-size:12px;color:var(--ink-light);text-align:center;line-height:1.7;}
.vm-problem{width:100%;padding:16px;border-radius:12px;background:var(--stage-light);border:1.5px solid var(--stage-mid);font-size:22px;font-weight:700;text-align:center;color:var(--stage-color);font-family:'DM Mono',monospace;letter-spacing:0.06em;}
.vm-voice-box{width:100%;min-height:48px;padding:10px 16px;border-radius:12px;border:2px dashed var(--ui-border);background:var(--bg);font-size:15px;font-family:'DM Mono',monospace;color:var(--ink-light);text-align:center;display:flex;align-items:center;justify-content:center;transition:all 0.25s;}
.vm-voice-box.listening{border-color:var(--stage-a);border-style:solid;background:#fff5f3;color:var(--stage-a);}
.vm-voice-box.correct{border-color:#1aad6e;border-style:solid;background:#f0fbf6;color:#1aad6e;}
.vm-voice-box.wrong{border-color:var(--stage-a);border-style:solid;background:#fff5f3;color:var(--stage-a);}
.vm-mic{width:72px;height:72px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--stage-a),#f5a623);color:white;font-size:28px;cursor:pointer;transition:all 0.2s;box-shadow:0 4px 16px rgba(232,64,28,0.3);display:flex;align-items:center;justify-content:center;}
.vm-mic:hover{transform:scale(1.05);}
.vm-mic.on{background:linear-gradient(135deg,#c01010,#e8401c);animation:micPulse 1s infinite;}
@keyframes micPulse{0%,100%{box-shadow:0 4px 16px rgba(200,16,16,0.4),0 0 0 0 rgba(200,16,16,0.2);}50%{box-shadow:0 4px 16px rgba(200,16,16,0.4),0 0 0 16px rgba(200,16,16,0);}}
.vm-score{display:flex;gap:24px;font-family:'DM Mono',monospace;}
.vm-sc{display:flex;flex-direction:column;align-items:center;gap:4px;}
.vm-sc-val{font-size:28px;font-weight:500;color:var(--stage-color);}
.vm-sc-lbl{font-size:10px;color:var(--ink-light);}
.vm-keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;width:180px;}
.vm-kp{height:40px;border-radius:8px;background:var(--bg);border:1px solid var(--ui-border);font-family:'DM Mono',monospace;font-size:16px;font-weight:500;color:var(--ink);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.12s;}
.vm-kp:hover{background:var(--stage-light);border-color:var(--stage-mid);}
.vm-kp:active{transform:scale(0.94);}
.vm-kp.wide{grid-column:span 2;}
.vm-kp.del{font-size:14px;color:var(--ink-mid);}
.vm-input-display{width:100%;padding:8px 14px;border-radius:8px;border:2px solid var(--ui-border);background:var(--bg);font-family:'DM Mono',monospace;font-size:22px;font-weight:500;text-align:center;color:var(--ink);min-height:44px;display:flex;align-items:center;justify-content:center;}
.vm-btns{display:flex;gap:8px;}
.vm-submit{padding:8px 20px;border-radius:8px;border:none;background:var(--stage-color);color:white;font-family:'Noto Sans KR',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.15s;}
.vm-submit:hover{opacity:0.85;}
.vm-close-btn{padding:8px 20px;border-radius:8px;border:1px solid var(--ui-border);background:none;font-family:'Noto Sans KR',sans-serif;font-size:12px;color:var(--ink-mid);cursor:pointer;transition:all 0.15s;}
.vm-close-btn:hover{background:var(--bg);}

/* â•â• ì§„ë„ íŒ¨ë„ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#progress-panel{position:fixed;right:0;top:0;bottom:0;width:280px;background:var(--ui-bg);border-left:1px solid var(--ui-border);z-index:7000;transform:translateX(100%);transition:transform 0.3s;display:flex;flex-direction:column;padding:20px;gap:16px;box-shadow:var(--shadow-lg);overflow-y:auto;}
#progress-panel.open{transform:translateX(0);}
.pp-title{font-size:14px;font-weight:700;color:var(--ink);border-bottom:1px solid var(--ui-border);padding-bottom:12px;flex-shrink:0;}
.pp-stage-name{font-size:12px;font-weight:700;color:var(--ink-mid);margin-bottom:6px;margin-top:10px;}
.pp-bar-wrap{height:8px;background:var(--bg);border-radius:4px;overflow:hidden;margin-bottom:4px;}
.pp-bar{height:100%;border-radius:4px;transition:width 0.5s;}
.pp-pct{font-size:11px;font-family:'DM Mono',monospace;color:var(--ink-light);text-align:right;margin-bottom:8px;}
.pp-pages{display:flex;flex-wrap:wrap;gap:5px;}
.pp-page{width:28px;height:28px;border-radius:6px;border:1.5px solid var(--ui-border);font-family:'DM Mono',monospace;font-size:10px;color:var(--ink-mid);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.15s;}
.pp-page:hover{border-color:var(--stage-mid);color:var(--stage-color);}
.pp-page.done{background:var(--stage-c-light);border-color:#1aad6e;color:#1aad6e;}
.pp-page.cur{background:var(--stage-color);border-color:var(--stage-color);color:white;}
.pp-close-btn{padding:8px;border-radius:8px;border:1px solid var(--ui-border);background:none;font-size:11px;color:var(--ink-mid);cursor:pointer;align-self:flex-start;margin-top:auto;}
.pp-close-btn:hover{background:var(--bg);}

/* â•â• ê²Œì´ë¯¸í”¼ì¼€ì´ì…˜ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* í¬ì¸íŠ¸ íŒì—… */
.point-popup{position:fixed;z-index:5000;font-family:'DM Mono',monospace;font-size:14px;font-weight:700;color:#f5a623;pointer-events:none;animation:pointFly 1.2s ease forwards;}
@keyframes pointFly{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-60px) scale(0.8)}}
/* ë°°ì§€ ì•Œë¦¼ */
.badge-toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(10px);background:linear-gradient(135deg,#1a1814,#2a2218);border:1px solid #f5a623;border-radius:16px;padding:14px 20px;display:flex;align-items:center;gap:12px;z-index:5001;opacity:0;transition:all 0.3s;box-shadow:0 8px 32px rgba(0,0,0,0.4);}
.badge-toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.badge-toast-icon{font-size:28px;}
.badge-toast-info{display:flex;flex-direction:column;}
.badge-toast-title{font-size:12px;font-weight:700;color:#f5a623;}
.badge-toast-name{font-size:14px;font-weight:700;color:#d0c8b8;}
/* í•™ìƒ ìƒíƒœë°” (ê²Œì´ë¯¸í”¼ì¼€ì´ì…˜) */
.game-bar{height:36px;flex-shrink:0;background:var(--ui-bg);border-bottom:1px solid var(--ui-border);display:flex;align-items:center;padding:0 16px;gap:16px;}
.game-bar.hidden{display:none;}
.game-xp-wrap{display:flex;align-items:center;gap:8px;flex:1;max-width:200px;}
.game-xp-lbl{font-size:10px;color:var(--ink-light);font-family:'DM Mono',monospace;white-space:nowrap;}
.game-xp-bar{flex:1;height:6px;background:var(--bg);border-radius:3px;overflow:hidden;}
.game-xp-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,#f5a623,#e8401c);transition:width 0.5s;}
.game-level{font-family:'DM Mono',monospace;font-size:11px;font-weight:700;color:#f5a623;min-width:40px;}
.game-streak{display:flex;align-items:center;gap:4px;font-family:'DM Mono',monospace;font-size:11px;color:var(--ink-mid);}
.game-streak.active{color:#f5a623;}
.game-points{font-family:'DM Mono',monospace;font-size:11px;color:var(--stage-color);font-weight:700;}
.game-badges-mini{display:flex;gap:3px;}
.game-badge-icon{font-size:14px;cursor:pointer;}

/* â•â• ì˜¤ë‹µë…¸íŠ¸ íŒ¨ë„ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#wrong-panel{position:fixed;left:0;top:0;bottom:0;width:300px;background:var(--ui-bg);border-right:1px solid var(--ui-border);z-index:7000;transform:translateX(-100%);transition:transform 0.3s;display:flex;flex-direction:column;box-shadow:var(--shadow-lg);}
#wrong-panel.open{transform:translateX(0);}
.wp-header{padding:16px 18px 12px;border-bottom:1px solid var(--ui-border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.wp-title{font-size:14px;font-weight:700;color:var(--ink);}
.wp-close{width:28px;height:28px;border-radius:50%;border:1px solid var(--ui-border);background:none;color:var(--ink-mid);font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.wp-close:hover{background:var(--bg);}
.wp-body{flex:1;overflow-y:auto;padding:12px;}
.wp-empty{text-align:center;padding:40px 20px;color:var(--ink-light);font-size:13px;line-height:1.8;}
.wrong-item{background:var(--bg);border:1px solid var(--ui-border);border-radius:10px;padding:12px;margin-bottom:8px;cursor:pointer;transition:all 0.15s;}
.wrong-item:hover{border-color:var(--stage-mid);background:var(--stage-light);}
.wrong-item-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.wrong-item-stage{font-size:10px;font-family:'DM Mono',monospace;padding:2px 8px;border-radius:20px;background:var(--stage-light);color:var(--stage-color);font-weight:700;}
.wrong-item-date{font-size:10px;color:var(--ink-light);font-family:'DM Mono',monospace;}
.wrong-item-q{font-size:15px;font-weight:700;color:var(--ink);font-family:'DM Mono',monospace;margin-bottom:4px;}
.wrong-item-ans{font-size:11px;color:var(--ink-light);}
.wrong-item-ans span{color:#1aad6e;font-weight:700;}
.wp-clear-btn{margin:8px 12px;padding:8px;border-radius:8px;border:1px solid var(--ui-border);background:none;font-size:11px;color:var(--ink-light);cursor:pointer;width:calc(100% - 24px);transition:all 0.15s;}
.wp-clear-btn:hover{background:rgba(232,64,28,0.05);color:#e8401c;border-color:rgba(232,64,28,0.2);}

/* â•â• STATUS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.statusbar{height:26px;flex-shrink:0;background:var(--ui-bg);border-top:1px solid var(--ui-border);display:flex;align-items:center;padding:0 20px;gap:20px;font-size:10px;font-family:'DM Mono',monospace;z-index:100;}
.st-k{color:var(--ink-light);}
.st-v{color:var(--stage-color);transition:color 0.4s;}
.st-item{display:flex;gap:5px;}

/* â•â• ë‹¨ê³„ ì˜¤ë²„ë ˆì´ & í† ìŠ¤íŠ¸ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stage-overlay{position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0;transition:opacity 0.25s;background:rgba(0,0,0,0.35);}
.stage-overlay.show{opacity:1;}
.stage-overlay-box{padding:20px 48px;border-radius:16px;font-size:44px;font-weight:900;color:white;background:var(--stage-color);box-shadow:var(--shadow-lg);transition:background 0.4s;letter-spacing:0.08em;}
.toast{position:fixed;bottom:40px;left:50%;transform:translateX(-50%) translateY(10px);background:#1e1c18;color:#d0c8b8;padding:10px 20px;border-radius:8px;font-size:12px;font-family:'DM Mono',monospace;opacity:0;transition:all 0.3s;z-index:2000;white-space:nowrap;border:1px solid rgba(255,255,255,0.1);}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

@media(max-width:900px){.sidebar{display:none;}.qm-progress{display:none;}.b5-page,.pdf-canvas-wrap,.page-loading,.page-error{width:90vw;}.pages-wrap{padding:20px 10px 60px;}}
@media(max-width:600px){.stage-tab-sub{display:none;}.qm-logo-name{display:none;}.pen-size-wrap{display:none;}}
</style>
</head>
<body>

<!-- â”€â”€â”€ í•™ìƒ ì„ íƒ & PIN ì ê¸ˆ í™”ë©´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="lock-screen">
  <!-- í”„ë¡œí•„ ì„ íƒ -->
  <div id="profile-select">
    <div class="ls-header">
      <div class="ls-logo-row">
        <div class="ls-logo-icon">ìˆ˜í•™</div>
        <div class="ls-app-name">êµ¬ëª¬ìˆ˜í•™ ë·°ì–´</div>
      </div>
      <div class="ls-subtitle">ëˆ„ê°€ í•™ìŠµí• ê¹Œìš”?</div>
    </div>
    <div class="profiles-grid" id="profiles-grid">
      <!-- JSë¡œ ìƒì„± -->
    </div>
    <div class="ls-admin-hint" onclick="openAdmin()">âš™ ê´€ë¦¬ì ì„¤ì •</div>
  </div>

  <!-- PIN ì…ë ¥ -->
  <div id="pin-screen">
    <button class="pin-back-btn" onclick="backToProfiles()">â† ëŒì•„ê°€ê¸°</button>
    <div class="pin-user-avatar" id="pin-avatar">ğŸ˜Š</div>
    <div class="pin-user-name" id="pin-user-name">í•™ìƒ</div>
    <div class="pin-user-sub" id="pin-user-sub">PIN 4ìë¦¬ ì…ë ¥</div>
    <div class="pin-dots" id="pin-dots">
      <div class="pin-dot" id="d0"></div><div class="pin-dot" id="d1"></div>
      <div class="pin-dot" id="d2"></div><div class="pin-dot" id="d3"></div>
    </div>
    <div class="pin-hint-txt" id="pin-hint-txt"></div>
    <div class="pin-keypad">
      <div class="kp" onclick="pinInput('1')">1</div><div class="kp" onclick="pinInput('2')">2</div><div class="kp" onclick="pinInput('3')">3</div>
      <div class="kp" onclick="pinInput('4')">4</div><div class="kp" onclick="pinInput('5')">5</div><div class="kp" onclick="pinInput('6')">6</div>
      <div class="kp" onclick="pinInput('7')">7</div><div class="kp" onclick="pinInput('8')">8</div><div class="kp" onclick="pinInput('9')">9</div>
      <div class="kp wide" onclick="pinInput('0')">0</div><div class="kp del" onclick="pinDel()">âŒ«</div>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ ê´€ë¦¬ì ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="admin-modal">
  <div class="am-box">
    <div class="am-header">
      <div class="am-title">âš™ ê´€ë¦¬ì ì„¤ì •</div>
      <button class="am-close-x" onclick="closeAdmin()">âœ•</button>
    </div>
    <div class="am-body">

      <!-- ê´€ë¦¬ì ì¸ì¦ (ìµœì´ˆ) -->
      <div id="am-auth-section">
        <div class="am-section-title">ê´€ë¦¬ì ì¸ì¦</div>
        <div class="am-row">
          <div class="am-lbl">ê´€ë¦¬ì PIN</div>
          <input class="am-inp" type="password" id="am-auth-pin" placeholder="ê´€ë¦¬ì PIN ì…ë ¥" maxlength="4">
        </div>
        <div class="am-btns">
          <button class="am-cancel" onclick="closeAdmin()">ì·¨ì†Œ</button>
          <button class="am-save" onclick="authAdmin()">ì¸ì¦</button>
        </div>
      </div>

      <!-- ì¸ì¦ í›„ ê´€ë¦¬ íŒ¨ë„ -->
      <div id="am-panel" style="display:none;flex-direction:column;gap:18px;">

        <!-- í•™ìƒ ëª©ë¡ -->
        <div>
          <div class="am-section-title">í•™ìƒ ê³„ì • ê´€ë¦¬</div>
          <div class="student-list" id="student-list"></div>
        </div>

        <!-- í•™ìƒ ì¶”ê°€ í¼ -->
        <div>
          <button class="am-save" onclick="toggleAddForm()" id="add-form-toggle-btn" style="width:100%;">+ í•™ìƒ ì¶”ê°€</button>
          <div class="add-student-form hidden" id="add-student-form" style="margin-top:10px;">
            <div class="am-section-title">ìƒˆ í•™ìƒ ë“±ë¡</div>
            <div class="am-row"><div class="am-lbl">ì´ë¦„</div><input class="am-inp" id="new-student-name" placeholder="í•™ìƒ ì´ë¦„" maxlength="8"></div>
            <div class="am-row"><div class="am-lbl">PIN (4ìë¦¬)</div><input class="am-inp" type="password" id="new-student-pin" placeholder="PIN" maxlength="4"></div>
            <div class="am-row">
              <div class="am-lbl">ì•„ë°”íƒ€ ìƒ‰ìƒ</div>
              <div class="avatar-picker" id="avatar-picker"></div>
            </div>
            <div class="am-row"><div class="am-lbl">ë‹´ë‹¹ ë‹¨ê³„</div>
              <select class="am-inp" id="new-student-stage">
                <option value="A">Aë‹¨ê³„ Â· ê¸°ì´ˆ ì—°ì‚°</option>
                <option value="B">Bë‹¨ê³„ Â· ì‚¬ì¹™ì—°ì‚°</option>
                <option value="C">Cë‹¨ê³„ Â· ë¶„ìˆ˜Â·ì†Œìˆ˜</option>
              </select>
            </div>
            <div class="am-btns">
              <button class="am-cancel" onclick="toggleAddForm()">ì·¨ì†Œ</button>
              <button class="am-save" onclick="addStudent()">ë“±ë¡</button>
            </div>
          </div>
        </div>

        <div class="am-divider"></div>

        <!-- ê´€ë¦¬ì PIN ë³€ê²½ -->
        <div>
          <div class="am-section-title">ê´€ë¦¬ì PIN ë³€ê²½</div>
          <div class="am-row"><div class="am-lbl">ìƒˆ PIN (4ìë¦¬)</div><input class="am-inp" type="password" id="am-new-pin" placeholder="ìƒˆ PIN" maxlength="4"></div>
          <div class="am-btns">
            <button class="am-save" onclick="changeAdminPin()">PIN ë³€ê²½</button>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ ì•± ë©”ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="app-main" style="display:none;flex-direction:column;height:100vh;overflow:hidden;">

<div class="stage-overlay" id="overlay"><div class="stage-overlay-box" id="overlay-txt">Aë‹¨ê³„</div></div>
<div class="toast" id="toast"></div>

<button class="qm-toggle-btn" id="qm-show-btn" onclick="showQuickmenu()">
  <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M2 5l6 6 6-6"/></svg>ë©”ë‰´
</button>

<!-- QUICK MENU -->
<nav class="quickmenu" id="quickmenu">
  <div class="qm-logo">
    <div class="qm-logo-icon" id="logo-icon">ìˆ˜í•™</div>
    <div><div class="qm-logo-name">êµ¬ëª¬ìˆ˜í•™</div><div class="qm-logo-sub">ë‹¨ê³„ë³„ êµì¬ ë·°ì–´</div></div>
  </div>
  <div class="stage-tabs">
    <div class="stage-tab on" data-s="A" onclick="switchStage('A')"><div class="stage-tab-badge">A</div><div><div class="stage-tab-name">Aë‹¨ê³„</div><div class="stage-tab-sub">ê¸°ì´ˆ ì—°ì‚°</div></div></div>
    <div class="stage-tab" data-s="B" onclick="switchStage('B')"><div class="stage-tab-badge">B</div><div><div class="stage-tab-name">Bë‹¨ê³„</div><div class="stage-tab-sub">ì‚¬ì¹™ì—°ì‚°</div></div></div>
    <div class="stage-tab" data-s="C" onclick="switchStage('C')"><div class="stage-tab-badge">C</div><div><div class="stage-tab-name">Cë‹¨ê³„</div><div class="stage-tab-sub">ë¶„ìˆ˜Â·ì†Œìˆ˜</div></div></div>
  </div>
  <div class="qm-progress">
    <div class="prog-row"><span style="color:var(--stage-a);font-weight:700;min-width:14px">A</span><div class="prog-track"><div class="prog-fill a" id="prog-a" style="width:0%"></div></div><span id="prog-a-pct">0%</span></div>
    <div class="prog-row"><span style="color:var(--stage-b);font-weight:700;min-width:14px">B</span><div class="prog-track"><div class="prog-fill b" id="prog-b" style="width:0%"></div></div><span id="prog-b-pct">0%</span></div>
    <div class="prog-row"><span style="color:var(--stage-c);font-weight:700;min-width:14px">C</span><div class="prog-track"><div class="prog-fill c" id="prog-c" style="width:0%"></div></div><span id="prog-c-pct">0%</span></div>
  </div>
  <div class="qm-right">
    <button class="qm-btn" onclick="toggleSidebar()"><svg width="13" height="13" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="1" y="1" width="14" height="14" rx="2"/><line x1="5" y1="1" x2="5" y2="15"/></svg>ëª©ë¡</button>
    <button class="qm-btn" id="btn-progress" onclick="toggleProgress()"><svg width="13" height="13" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="1" y="3" width="14" height="2" rx="1"/><rect x="1" y="7" width="10" height="2" rx="1"/><rect x="1" y="11" width="7" height="2" rx="1"/></svg>ì§„ë„</button>
    <button class="qm-btn" id="btn-timer-toggle" onclick="toggleTimerBar()"><svg width="13" height="13" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="9" r="6"/><path d="M8 6v3l2 2"/><path d="M6 1h4"/></svg>íƒ€ì´ë¨¸</button>
    <button class="qm-btn" id="btn-dark" onclick="toggleDark()"><svg width="13" height="13" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M13 10A6 6 0 016 3a6.5 6.5 0 100 10 6 6 0 007-3z"/></svg>ë‹¤í¬</button>
    <div class="pj-wrap">
      <button class="pj-btn" onclick="togglePJ()"><svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="2" y="2" width="5" height="5" rx="1"/><rect x="9" y="2" width="5" height="5" rx="1"/><rect x="2" y="9" width="5" height="5" rx="1"/><rect x="9" y="9" width="5" height="5" rx="1"/></svg><span id="pj-label">1 / 10</span></button>
      <div class="pj-dropdown" id="pj-dd"></div>
    </div>
    <button class="qm-btn" onclick="hideQuickmenu()" style="padding:6px 10px;opacity:0.6;"><svg width="13" height="13" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M14 11L8 5l-6 6"/></svg></button>
    <div id="qm-student-name" style="display:none;align-items:center;gap:6px;padding:4px 10px;border-radius:20px;background:var(--stage-light);font-size:11px;font-weight:700;color:var(--stage-color);cursor:pointer;" onclick="logoutStudent()" title="ë¡œê·¸ì•„ì›ƒ"></div>
  </div>
</nav>

<!-- TOOLBAR -->
<div class="toolbar">
  <div class="tb-badge"><div class="tb-dot"></div><span id="tb-label">Aë‹¨ê³„ Â· ê¸°ì´ˆ ì—°ì‚°</span></div>
  <div class="tb-sep"></div>
  <div class="tb-group">
    <button class="tb-btn" onclick="chZoom(-10)">âˆ’</button>
    <span class="zoom-val" id="zoom-val">100%</span>
    <button class="tb-btn" onclick="chZoom(10)">+</button>
    <button class="tb-btn" onclick="resetZoom()">ë§ì¶¤</button>
  </div>
  <div class="tb-sep"></div>
  <div class="tb-group">
    <button class="tb-btn on" id="btn-single" onclick="setLayout('single')">ë‹¨ë©´</button>
    <button class="tb-btn" id="btn-double" onclick="setLayout('double')">ì–‘ë©´</button>
  </div>
  <div class="tb-sep"></div>
  <button class="tb-btn" id="btn-pen-mode" onclick="togglePenMode()" style="display:flex;align-items:center;gap:5px;"><svg width="13" height="13" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M11 2l3 3-8 8H3v-3L11 2z"/></svg>í•„ê¸°</button>
  <div class="tb-sep"></div>
  <button class="tb-btn" id="btn-voice" onclick="openVoice()" style="display:flex;align-items:center;gap:5px;"><svg width="13" height="13" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="5" y="1" width="6" height="9" rx="3"/><path d="M2 8s0 6 6 6 6-6 6-6"/><line x1="8" y1="14" x2="8" y2="16"/></svg>ì±„ì </button>
  <div class="tb-sep"></div>
  <button class="tb-btn" id="btn-done-check" onclick="togglePageDone()" style="display:flex;align-items:center;gap:5px;"><svg width="13" height="13" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="2 8 6 12 14 4"/></svg>ì™„ë£Œ</button>
  <div class="tb-sep"></div>
  <button class="tb-btn" id="btn-wrong-note" onclick="toggleWrongPanel()" style="display:flex;align-items:center;gap:5px;"><svg width="13" height="13" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 6h8M4 9h6M4 12h4"/><rect x="1" y="2" width="14" height="13" rx="2"/></svg>ì˜¤ë‹µë…¸íŠ¸<span id="wrong-count-badge" style="display:none;background:var(--stage-a);color:white;border-radius:10px;padding:1px 5px;font-size:9px;font-family:'DM Mono',monospace;"></span></button>
  <div class="tb-sep"></div>
  <button class="tb-btn" onclick="window.open('dashboard.html','_blank')" style="display:flex;align-items:center;gap:5px;color:var(--stage-b);"><svg width="13" height="13" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="1" y="1" width="6" height="6" rx="1"/><rect x="9" y="1" width="6" height="6" rx="1"/><rect x="1" y="9" width="6" height="6" rx="1"/><rect x="9" y="9" width="6" height="6" rx="1"/></svg>ëŒ€ì‹œë³´ë“œ</button>
  <div class="tb-right"><span class="tb-info" id="tb-info">1 / 10 Â· B5 176Ã—250mm</span></div>
</div>

<!-- í•„ê¸° íˆ´ë°” -->
<div class="pen-toolbar hidden" id="pen-toolbar">
  <div class="tb-group" style="gap:3px;">
    <button class="pen-tool-btn on" id="tool-pen" onclick="setTool('pen')"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M11 2l3 3-8 8H3v-3L11 2z"/></svg><span class="lbl">íœ</span></button>
    <button class="pen-tool-btn" id="tool-highlighter" onclick="setTool('highlighter')"><svg viewBox="0 0 16 16" fill="currentColor"><rect x="4" y="7" width="8" height="5" rx="1" opacity="0.6"/><path d="M5 7V4h6v3" fill="none" stroke="currentColor" stroke-width="1.4"/></svg><span class="lbl">í˜•ê´‘</span></button>
    <button class="pen-tool-btn" id="tool-eraser" onclick="setTool('eraser')"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M3 13h10M9 3l4 4-6 6H3l4-4"/></svg><span class="lbl">ì§€ìš°ê°œ</span></button>
  </div>
  <div class="pen-sep"></div>
  <div class="color-palette" id="color-palette">
    <div class="color-dot on" data-c="#1a1814" style="background:#1a1814" onclick="setColor('#1a1814')"></div>
    <div class="color-dot" data-c="#e8401c" style="background:#e8401c" onclick="setColor('#e8401c')"></div>
    <div class="color-dot" data-c="#1a7fd4" style="background:#1a7fd4" onclick="setColor('#1a7fd4')"></div>
    <div class="color-dot" data-c="#1aad6e" style="background:#1aad6e" onclick="setColor('#1aad6e')"></div>
    <div class="color-dot" data-c="#f5a623" style="background:#f5a623" onclick="setColor('#f5a623')"></div>
    <div class="color-dot" data-c="#9b59b6" style="background:#9b59b6" onclick="setColor('#9b59b6')"></div>
  </div>
  <div class="pen-sep"></div>
  <div class="pen-size-wrap"><span class="pen-lbl">êµµê¸°</span><input type="range" class="pen-slider" id="pen-size" min="1" max="20" value="3" oninput="updateSize()"><div class="pen-preview"><div id="pen-dot" style="border-radius:50%;background:#1a1814;width:3px;height:3px;"></div></div></div>
  <div class="pen-sep"></div>
  <div class="pen-size-wrap"><span class="pen-lbl">íˆ¬ëª…ë„</span><input type="range" class="pen-slider" id="pen-opacity" min="10" max="100" value="100" oninput="updateOpacity()"><span class="pen-lbl" id="opacity-val">100%</span></div>
  <div class="pen-sep"></div>
  <button class="pen-action-btn" onclick="undoStroke()"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 7H10a3 3 0 010 6H7"/><path d="M6 4L3 7l3 3"/></svg>ë˜ëŒë¦¬ê¸°</button>
  <button class="pen-action-btn" onclick="saveAsImage()"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2v8M5 7l3 3 3-3"/><rect x="2" y="11" width="12" height="3" rx="1"/></svg>ì €ì¥</button>
  <button class="pen-action-btn danger" onclick="clearPage()"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 13h10M9 3l4 4-6 6H3l4-4"/></svg>ì´ˆê¸°í™”</button>
  <span class="pen-status" id="pen-status">âœï¸ í•„ê¸° ëª¨ë“œ ì¼œì§</span>
</div>

<!-- íƒ€ì´ë¨¸ ë°” -->
<div class="timer-bar hidden" id="timer-bar">
  <span style="font-size:11px;color:var(--ink-mid);">â± í•™ìŠµ íƒ€ì´ë¨¸</span>
  <span class="timer-display" id="timer-display">00:00</span>
  <button class="timer-btn" id="timer-start-btn" onclick="toggleTimer()">ì‹œì‘</button>
  <button class="timer-btn" onclick="resetTimer()">ì´ˆê¸°í™”</button>
  <span style="font-size:11px;color:var(--ink-light);">ëª©í‘œ</span>
  <select class="timer-goal-sel" id="timer-goal" onchange="setTimerGoal()">
    <option value="0">ì—†ìŒ</option><option value="600">10ë¶„</option>
    <option value="1200">20ë¶„</option><option value="1800">30ë¶„</option><option value="3600">60ë¶„</option>
  </select>
</div>

<!-- ê²Œì´ë¯¸í”¼ì¼€ì´ì…˜ ë°” -->
<div class="game-bar" id="game-bar">
  <div class="game-level" id="game-level">Lv.1</div>
  <div class="game-xp-wrap">
    <span class="game-xp-lbl">XP</span>
    <div class="game-xp-bar"><div class="game-xp-fill" id="game-xp-fill" style="width:0%"></div></div>
    <span class="game-xp-lbl" id="game-xp-txt">0/100</span>
  </div>
  <div class="game-streak" id="game-streak">ğŸ”¥ 0ì¼</div>
  <div class="game-points" id="game-points">â­ 0pt</div>
  <div class="game-badges-mini" id="game-badges-mini"></div>
</div>

<!-- BODY -->
<div class="app-body">
  <aside class="sidebar" id="sidebar">
    <div class="sb-head"><div class="sb-dot"></div><span class="sb-head-txt" id="sb-title">Aë‹¨ê³„ í˜ì´ì§€</span></div>
    <div class="sb-scroll" id="thumb-list"></div>
  </aside>
  <div class="viewer" id="viewer">
    <div class="pages-wrap" id="pages-wrap"></div>
  </div>
</div>

<!-- STATUS BAR -->
<div class="statusbar">
  <div class="st-item"><span class="st-k">ë‹¨ê³„</span><span class="st-v" id="st-stage">Aë‹¨ê³„</span></div>
  <div class="st-item"><span class="st-k">í˜ì´ì§€</span><span class="st-v" id="st-page">1/10</span></div>
  <div class="st-item"><span class="st-k">í™•ëŒ€</span><span class="st-v" id="st-zoom">100%</span></div>
  <div class="st-item"><span class="st-k">ì™„ë£Œ</span><span class="st-v" id="st-done">0p</span></div>
  <div class="st-item"><span class="st-k">ì±„ì </span><span class="st-v" id="st-score">-</span></div>
  <div class="st-item"><span class="st-k">í•„ê¸°</span><span class="st-v" id="st-ink">OFF</span></div>
</div>
</div><!-- #app-main -->

<!-- â”€â”€â”€ ì˜¤ë‹µë…¸íŠ¸ íŒ¨ë„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="wrong-panel">
  <div class="wp-header">
    <div class="wp-title">ğŸ“ ì˜¤ë‹µë…¸íŠ¸</div>
    <button class="wp-close" onclick="toggleWrongPanel()">âœ•</button>
  </div>
  <div class="wp-body" id="wrong-body"></div>
  <button class="wp-clear-btn" onclick="clearWrongNotes()">ì „ì²´ ì‚­ì œ</button>
</div>

<!-- ë°°ì§€ ì•Œë¦¼ -->
<div class="badge-toast" id="badge-toast">
  <div class="badge-toast-icon" id="badge-toast-icon">ğŸ†</div>
  <div class="badge-toast-info">
    <div class="badge-toast-title">ë°°ì§€ íšë“!</div>
    <div class="badge-toast-name" id="badge-toast-name"></div>
  </div>
</div>

<!-- â”€â”€â”€ ìŒì„± ì±„ì  ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="voice-modal">
  <div class="vm-box">
    <div class="vm-title">ğŸ¤ ìŒì„± ì±„ì </div>
    <div class="vm-problem" id="vm-problem">12 + 34 = ?</div>
    <div class="vm-sub">ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë‹µì„ ë§í•˜ê±°ë‚˜<br>í‚¤íŒ¨ë“œë¡œ ì…ë ¥ í›„ ì œì¶œí•˜ì„¸ìš”</div>
    <div class="vm-voice-box" id="vm-voice-box">ë§í•˜ê¸° ì¤€ë¹„ë¨</div>
    <button class="vm-mic" id="vm-mic-btn" onclick="toggleVoice()">ğŸ¤</button>
    <div class="vm-input-display" id="vm-input-display">â€”</div>
    <div class="vm-keypad">
      <div class="vm-kp" onclick="vmKey('1')">1</div><div class="vm-kp" onclick="vmKey('2')">2</div><div class="vm-kp" onclick="vmKey('3')">3</div>
      <div class="vm-kp" onclick="vmKey('4')">4</div><div class="vm-kp" onclick="vmKey('5')">5</div><div class="vm-kp" onclick="vmKey('6')">6</div>
      <div class="vm-kp" onclick="vmKey('7')">7</div><div class="vm-kp" onclick="vmKey('8')">8</div><div class="vm-kp" onclick="vmKey('9')">9</div>
      <div class="vm-kp wide" onclick="vmKey('0')">0</div><div class="vm-kp del" onclick="vmDel()">âŒ«</div>
    </div>
    <div class="vm-btns">
      <button class="vm-submit" onclick="vmSubmit()">ì œì¶œ</button>
      <button class="vm-close-btn" onclick="closeVoice()">ë‹«ê¸°</button>
    </div>
    <div class="vm-score">
      <div class="vm-sc"><div class="vm-sc-val" id="vm-correct">0</div><div class="vm-sc-lbl">ì •ë‹µ</div></div>
      <div class="vm-sc"><div class="vm-sc-val" id="vm-wrong" style="color:var(--stage-a)">0</div><div class="vm-sc-lbl">ì˜¤ë‹µ</div></div>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ ì§„ë„ íŒ¨ë„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="progress-panel">
  <div class="pp-title">ğŸ“Š í•™ìŠµ ì§„ë„ í˜„í™©</div>
  <div id="pp-content"></div>
  <button class="pp-close-btn" onclick="toggleProgress()">ë‹«ê¸°</button>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

/* â•â• 1. í•™ìƒ ê³„ì • ì‹œìŠ¤í…œ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const AVATAR_COLORS=['#e8401c','#1a7fd4','#1aad6e','#f5a623','#9b59b6','#e91e8c','#00bcd4','#ff5722','#4caf50','#3f51b5'];
const AVATAR_EMOJIS=['ğŸ˜Š','ğŸ¦Š','ğŸ¶','ğŸ±','ğŸ¼','ğŸ¦','ğŸ¸','ğŸ¦‹','â­','ğŸš€'];

function defaultStudents(){
  return[
    {id:'s1',name:'ë¯¼ì¤€',emoji:'ğŸ˜Š',color:'#e8401c',pin:'1234',stage:'A',created:Date.now()},
    {id:'s2',name:'ì„œì—°',emoji:'ğŸ¦‹',color:'#1a7fd4',pin:'1234',stage:'B',created:Date.now()},
  ];
}
function getStudents(){try{const r=localStorage.getItem('kumon-students');return r?JSON.parse(r):defaultStudents();}catch(e){return defaultStudents();}}
function saveStudents(arr){localStorage.setItem('kumon-students',JSON.stringify(arr));}
function getAdminPin(){return localStorage.getItem('kumon-admin-pin')||'0000';}
function saveAdminPin(p){localStorage.setItem('kumon-admin-pin',p);}

let currentStudent=null,pinBuf='',adminAuthed=false,editingStudentId=null;
let selectedAvatarColor=AVATAR_COLORS[0],selectedAvatarEmoji=AVATAR_EMOJIS[0];

function renderProfiles(){
  const grid=document.getElementById('profiles-grid');
  grid.innerHTML='';
  const students=getStudents();
  students.forEach((s,idx)=>{
    const card=document.createElement('div');
    card.className='profile-card';
    card.style.animationDelay=(idx*0.06)+'s';
    card.style.setProperty('--avatar-color',s.color);
    let doneCount=0,totalCount=totalPages[s.stage]||10;
    try{for(let p=1;p<=totalCount;p++){if(localStorage.getItem(`kumon-done-${s.id}-${s.stage}-${p}`)==='1') doneCount++;}}catch(e){}
    const pct=Math.round(doneCount/totalCount*100);
    card.innerHTML=`<div class="profile-avatar" style="background:${s.color};">${s.emoji}</div><div class="profile-name">${s.name}</div><div class="profile-stage-badge">${s.stage}ë‹¨ê³„ Â· ${pct}%</div><div class="profile-progress-mini"><div class="profile-progress-mini-fill" style="width:${pct}%;background:${s.color};"></div></div>`;
    card.onclick=()=>selectProfile(s);
    grid.appendChild(card);
  });
  // ê´€ë¦¬ì ì¹´ë“œ
  const ac=document.createElement('div');ac.className='profile-card admin';ac.style.animationDelay=(students.length*0.06)+'s';
  ac.innerHTML=`<div class="profile-avatar">âš™ï¸</div><div class="profile-name" style="color:#5a5850;">ê´€ë¦¬ì</div><div class="profile-stage-badge">ì„¤ì •</div>`;
  ac.onclick=openAdmin;grid.appendChild(ac);
  // ì¶”ê°€ ì¹´ë“œ
  const add=document.createElement('div');add.className='profile-card add-btn';add.style.animationDelay=((students.length+1)*0.06)+'s';
  add.innerHTML=`<div class="profile-avatar" style="font-size:28px;color:#4a4840;">ï¼‹</div><div class="profile-name" style="color:#4a4840;">ì¶”ê°€</div><div class="profile-stage-badge">ìƒˆ í•™ìƒ</div>`;
  add.onclick=()=>{openAdmin();setTimeout(()=>{authAdmin(true);},50);};
  grid.appendChild(add);
}

function selectProfile(student){
  currentStudent=student;pinBuf='';
  document.getElementById('pin-avatar').textContent=student.emoji;
  document.getElementById('pin-avatar').style.background=student.color;
  document.getElementById('pin-user-name').textContent=student.name;
  document.getElementById('pin-user-sub').textContent=`${student.stage}ë‹¨ê³„ Â· PIN 4ìë¦¬ ì…ë ¥`;
  document.getElementById('pin-hint-txt').textContent='';
  document.documentElement.style.setProperty('--avatar-color',student.color);
  updDots();
  document.getElementById('profile-select').classList.add('hidden');
  document.getElementById('pin-screen').classList.add('show');
}
function backToProfiles(){
  document.getElementById('pin-screen').classList.remove('show');
  document.getElementById('profile-select').classList.remove('hidden');
  pinBuf='';currentStudent=null;updDots();
}
function pinInput(d){
  if(pinBuf.length>=4) return;
  pinBuf+=d;updDots();
  if(pinBuf.length===4) checkPin();
}
function pinDel(){pinBuf=pinBuf.slice(0,-1);updDots();}
function updDots(){
  for(let i=0;i<4;i++){
    const dot=document.getElementById('d'+i);if(!dot) continue;
    dot.classList.toggle('filled',i<pinBuf.length);dot.classList.remove('error','success');
  }
}
function checkPin(){
  if(!currentStudent) return;
  if(pinBuf===currentStudent.pin){
    for(let i=0;i<4;i++) document.getElementById('d'+i).classList.add('success');
    setTimeout(()=>unlockApp(currentStudent),400);
  } else {
    for(let i=0;i<4;i++) document.getElementById('d'+i).classList.add('error');
    const hint=document.getElementById('pin-hint-txt');hint.textContent='âŒ PINì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤';
    setTimeout(()=>{pinBuf='';updDots();hint.textContent='';},700);
  }
}
function unlockApp(student){
  document.getElementById('lock-screen').classList.add('hidden');
  const app=document.getElementById('app-main');app.style.display='flex';
  currentStudentId=student.id;
  loadLS();applyColors(student.stage);curStage=student.stage;
  buildPJ();renderAll();
  document.getElementById('logo-icon').textContent=student.emoji;
  document.getElementById('logo-icon').style.background=student.color;
  document.querySelectorAll('.stage-tab').forEach(t=>t.classList.toggle('on',t.dataset.s===student.stage));
  document.getElementById('tb-label').textContent=`${student.name} Â· ${STAGE_CFG[student.stage].label}`;
  const sn=document.getElementById('qm-student-name');if(sn){sn.textContent=student.name;sn.style.display='flex';}
  const urlStage=new URLSearchParams(location.search).get('stage');
  if(urlStage&&['A','B','C'].includes(urlStage)) switchStage(urlStage);
  // ê²Œì´ë¯¸í”¼ì¼€ì´ì…˜ ì´ˆê¸°í™”
  setTimeout(()=>{ updateGameBar(); updateWrongBadge(); checkStreak(); }, 300);
}

/* ê´€ë¦¬ì ëª¨ë‹¬ */
function openAdmin(){
  adminAuthed=false;
  document.getElementById('am-auth-section').style.display='';
  document.getElementById('am-panel').style.display='none';
  document.getElementById('am-auth-pin').value='';
  document.getElementById('admin-modal').classList.add('open');
}
function closeAdmin(){
  document.getElementById('admin-modal').classList.remove('open');
  adminAuthed=false;
  const f=document.getElementById('add-student-form');if(f) f.classList.add('hidden');
  editingStudentId=null;
}
function authAdmin(skipCheck){
  if(!skipCheck){
    const p=document.getElementById('am-auth-pin').value;
    if(p!==getAdminPin()){
      document.getElementById('am-auth-pin').style.borderColor='#e8401c';
      setTimeout(()=>document.getElementById('am-auth-pin').style.borderColor='',1000);return;
    }
  }
  adminAuthed=true;
  document.getElementById('am-auth-section').style.display='none';
  document.getElementById('am-panel').style.display='flex';
  document.getElementById('am-panel').style.flexDirection='column';
  document.getElementById('am-panel').style.gap='18px';
  renderStudentList();renderAvatarPicker();
}
function renderStudentList(){
  const list=document.getElementById('student-list');list.innerHTML='';
  const students=getStudents();
  if(!students.length){list.innerHTML='<div style="font-size:12px;color:#4a4840;text-align:center;padding:16px;">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</div>';return;}
  students.forEach(s=>{
    const item=document.createElement('div');item.className='student-item';
    item.innerHTML=`<div class="student-item-avatar" style="background:${s.color};">${s.emoji}</div><div class="student-item-info"><div class="student-item-name">${s.name}</div><div class="student-item-sub">${s.stage}ë‹¨ê³„ Â· PIN: ${s.pin}</div></div><div class="student-item-btns"><button class="student-edit-btn" onclick="editStudent('${s.id}')">ìˆ˜ì •</button><button class="student-del-btn" onclick="deleteStudent('${s.id}')">ì‚­ì œ</button></div>`;
    list.appendChild(item);
  });
}
function renderAvatarPicker(){
  const picker=document.getElementById('avatar-picker');picker.innerHTML='';
  AVATAR_COLORS.forEach((c,i)=>{
    const opt=document.createElement('div');
    opt.className='avatar-opt'+(c===selectedAvatarColor?' on':'');
    opt.style.background=c;opt.textContent=AVATAR_EMOJIS[i];
    opt.onclick=()=>{selectedAvatarColor=c;selectedAvatarEmoji=AVATAR_EMOJIS[i];document.querySelectorAll('.avatar-opt').forEach(x=>x.classList.remove('on'));opt.classList.add('on');};
    picker.appendChild(opt);
  });
}
function toggleAddForm(){
  const form=document.getElementById('add-student-form'),btn=document.getElementById('add-form-toggle-btn');
  const hidden=form.classList.toggle('hidden');
  btn.textContent=hidden?'+ í•™ìƒ ì¶”ê°€':'ë‹«ê¸°';
  if(!hidden) document.getElementById('new-student-name').focus();
  editingStudentId=null;
}
function addStudent(){
  const name=document.getElementById('new-student-name').value.trim();
  const pin=document.getElementById('new-student-pin').value.trim();
  const stage=document.getElementById('new-student-stage').value;
  if(!name){alert('ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');return;}
  if(!/^\d{4}$/.test(pin)){alert('PINì€ ìˆ«ì 4ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.');return;}
  const students=getStudents();
  if(editingStudentId){
    const idx=students.findIndex(s=>s.id===editingStudentId);
    if(idx>=0) students[idx]={...students[idx],name,pin,stage,color:selectedAvatarColor,emoji:selectedAvatarEmoji};
  } else {
    students.push({id:'s'+Date.now(),name,emoji:selectedAvatarEmoji,color:selectedAvatarColor,pin,stage,created:Date.now()});
  }
  saveStudents(students);renderStudentList();renderProfiles();
  document.getElementById('new-student-name').value='';document.getElementById('new-student-pin').value='';
  document.getElementById('add-student-form').classList.add('hidden');
  document.getElementById('add-form-toggle-btn').textContent='+ í•™ìƒ ì¶”ê°€';
  editingStudentId=null;
  showToast(editingStudentId?'í•™ìƒ ì •ë³´ ìˆ˜ì • ì™„ë£Œ':'ìƒˆ í•™ìƒ ë“±ë¡ ì™„ë£Œ! ğŸ‰');
}
function editStudent(id){
  const s=getStudents().find(x=>x.id===id);if(!s) return;
  editingStudentId=id;
  document.getElementById('new-student-name').value=s.name;
  document.getElementById('new-student-pin').value=s.pin;
  document.getElementById('new-student-stage').value=s.stage;
  selectedAvatarColor=s.color;selectedAvatarEmoji=s.emoji;renderAvatarPicker();
  document.getElementById('add-student-form').classList.remove('hidden');
  document.getElementById('add-form-toggle-btn').textContent='ë‹«ê¸°';
}
function deleteStudent(id){
  const s=getStudents().find(x=>x.id===id);if(!s) return;
  if(!confirm(`"${s.name}" í•™ìƒì„ ì‚­ì œí• ê¹Œìš”?\ní•™ìŠµ ë°ì´í„°ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.`)) return;
  try{['A','B','C'].forEach(stage=>{for(let p=1;p<=20;p++){localStorage.removeItem(`kumon-ink-${s.id}-${stage}-${p}`);localStorage.removeItem(`kumon-done-${s.id}-${stage}-${p}`);}});}catch(e){}
  saveStudents(getStudents().filter(x=>x.id!==id));
  renderStudentList();renderProfiles();showToast('í•™ìƒ ê³„ì • ì‚­ì œ ì™„ë£Œ');
}
function changeAdminPin(){
  const nw=document.getElementById('am-new-pin').value;
  if(!/^\d{4}$/.test(nw)){alert('PINì€ ìˆ«ì 4ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.');return;}
  saveAdminPin(nw);document.getElementById('am-new-pin').value='';showToast('ê´€ë¦¬ì PIN ë³€ê²½ ì™„ë£Œ âœ“');
}
document.addEventListener('DOMContentLoaded',()=>{
  if(!localStorage.getItem('kumon-admin-pin')) saveAdminPin('0000');
  renderProfiles();
});

/* â•â• 2. ì•± ìƒíƒœ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const STAGE_CFG={
  A:{label:'Aë‹¨ê³„',sub:'ê¸°ì´ˆ ì—°ì‚°',color:'#e8401c',light:'#fde8e3',mid:'#f4a48e',pdf:'êµ¬ëª¬ìˆ˜í•™Aë‹¨ê³„í…ŒìŠ¤íŠ¸10ì¥.pdf'},
  B:{label:'Bë‹¨ê³„',sub:'ì‚¬ì¹™ì—°ì‚°', color:'#1a7fd4',light:'#e0eefc',mid:'#7ab8eb',pdf:'êµ¬ëª¬ìˆ˜í•™Bë‹¨ê³„í…ŒìŠ¤íŠ¸10ì¥.pdf'},
  C:{label:'Cë‹¨ê³„',sub:'ë¶„ìˆ˜Â·ì†Œìˆ˜',color:'#1aad6e',light:'#dcf5eb',mid:'#76d4a8',pdf:'êµ¬ëª¬ìˆ˜í•™Cë‹¨ê³„í…ŒìŠ¤íŠ¸10ì¥.pdf'},
};
let curStage='A',curPage=1,zoom=100,layout='single',sidebarOn=true;
let penMode=false,curTool='pen',penColor='#1a1814',penSize=3,penOpacity=1.0;
let isDrawing=false,curStroke=null,darkMode=false,timerBarVisible=false;
let currentStudentId='default'; // í•™ìƒ ID (í•™ìƒë³„ ë°ì´í„° ë¶„ë¦¬ í‚¤)
const inkData={A:{},B:{},C:{}};
const pagesDone={A:{},B:{},C:{}};
const pdfCache={};
const totalPages={A:10,B:10,C:10};
let vmInput='',vmCorrect=0,vmWrong=0,recognition=null,vmListening=false;
let timerSec=0,timerGoal=0,timerRunning=false,timerInterval=null;
let vmCurrentProblem=null;

/* â•â• 3. ë‹¤í¬ëª¨ë“œ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleDark(){
  darkMode=!darkMode;
  document.body.classList.toggle('dark',darkMode);
  document.getElementById('btn-dark').classList.toggle('on',darkMode);
  localStorage.setItem('kumon-dark',darkMode?'1':'0');
  showToast(darkMode?'ë‹¤í¬ ëª¨ë“œ ì¼œì§ ğŸŒ™':'ë¼ì´íŠ¸ ëª¨ë“œ ì¼œì§');
}

/* â•â• 4. CSS ë³€ìˆ˜ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function applyColors(s){
  const c=STAGE_CFG[s],r=document.documentElement;
  r.style.setProperty('--stage-color',c.color);
  r.style.setProperty('--stage-light',c.light);
  r.style.setProperty('--stage-mid',c.mid);
}

/* â•â• 5. PDF â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadPDF(stage){
  if(pdfCache[stage]) return pdfCache[stage];
  try{const doc=await pdfjsLib.getDocument(STAGE_CFG[stage].pdf).promise;pdfCache[stage]=doc;totalPages[stage]=doc.numPages;return doc;}
  catch(e){return null;}
}
async function renderPDFPage(doc,num,canvas){
  try{
    const page=await doc.getPage(num);
    const vp0=page.getViewport({scale:1});
    const vp=page.getViewport({scale:665/vp0.width});
    canvas.width=vp.width;canvas.height=vp.height;
    await page.render({canvasContext:canvas.getContext('2d'),viewport:vp}).promise;
    return{w:vp.width,h:vp.height};
  }catch(e){return null;}
}
async function renderThumb(doc,num,container){
  container.innerHTML='';
  if(!doc) return;
  try{
    const page=await doc.getPage(num);
    const scale=160/page.getViewport({scale:1}).width;
    const vp=page.getViewport({scale});
    const c=document.createElement('canvas');c.width=vp.width;c.height=vp.height;
    await page.render({canvasContext:c.getContext('2d'),viewport:vp}).promise;
    container.appendChild(c);
  }catch(e){}
}

async function renderAll(){
  const wrap=document.getElementById('pages-wrap');
  wrap.innerHTML='';
  wrap.className='pages-wrap'+(layout==='double'?' double':'');
  const total=totalPages[curStage];
  for(let i=1;i<=total;i++){
    const pd=document.createElement('div');
    pd.className='b5-page';pd.dataset.page=i;pd.style.animationDelay=(i*0.04)+'s';
    pd.innerHTML=`<div class="page-top-bar"></div><div class="page-loading" id="ld-${i}"><div class="spinner"></div><div class="loading-txt">${i}í˜ì´ì§€ ë¡œë”©ì¤‘...</div></div>`;
    wrap.appendChild(pd);
  }
  applyZoom();
  const pdfDoc=await loadPDF(curStage);
  if(!pdfDoc){
    for(let i=1;i<=total;i++){const el=document.getElementById(`ld-${i}`);if(el){el.className='page-error';el.innerHTML=`<div class="error-icon">ğŸ“„</div><div class="error-txt">PDF ë¡œë“œ ì‹¤íŒ¨<br>${STAGE_CFG[curStage].pdf}</div>`;}}
    return;
  }
  totalPages[curStage]=pdfDoc.numPages;
  await Promise.all(Array.from({length:pdfDoc.numPages},(_,i)=>i+1).map(async num=>{
    const loading=document.getElementById(`ld-${num}`);
    if(!loading) return;
    const parent=loading.parentElement;
    const pdfCanvas=document.createElement('canvas');pdfCanvas.className='pdf-layer';
    const wrap2=document.createElement('div');wrap2.className='pdf-canvas-wrap';
    wrap2.appendChild(pdfCanvas);
    const dim=await renderPDFPage(pdfDoc,num,pdfCanvas);
    const ic=document.createElement('canvas');
    ic.className='ink-canvas'+(penMode?' active':'');
    ic.dataset.stage=curStage;ic.dataset.page=num;
    if(dim){ic.width=dim.w;ic.height=dim.h;}
    wrap2.appendChild(ic);
    // ì™„ë£Œ ë°°ì§€
    const badge=document.createElement('div');
    badge.className='page-done-badge'+(pagesDone[curStage][num]?' show':'');
    badge.id=`done-badge-${curStage}-${num}`;badge.textContent='âœ“';
    wrap2.appendChild(badge);
    restoreInk(ic,curStage,num);bindInkEvents(ic);
    parent.removeChild(loading);parent.appendChild(wrap2);
  }));
  renderThumbs(pdfDoc);buildPJ();updateUI();refreshCanvasModes();updateProgressBars();
}

/* â•â• 6. ì¸ë„¤ì¼ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function renderThumbs(pdfDoc){
  const list=document.getElementById('thumb-list');list.innerHTML='';
  const total=pdfDoc?pdfDoc.numPages:totalPages[curStage];
  for(let i=1;i<=total;i++){
    const div=document.createElement('div');
    div.className='thumb'+(i===curPage?' on':'');div.dataset.page=i;div.onclick=()=>goToPage(i);
    const cw=document.createElement('div');cw.className='thumb-canvas-wrap';
    const dot=document.createElement('div');dot.className='thumb-ink-dot';dot.id=`idot-${curStage}-${i}`;
    const chk=document.createElement('div');chk.className='thumb-check'+(pagesDone[curStage][i]?' show':'');chk.id=`tchk-${curStage}-${i}`;chk.textContent='âœ“';
    cw.appendChild(dot);cw.appendChild(chk);
    div.innerHTML=`<span class="thumb-num">${i}</span>`;div.appendChild(cw);list.appendChild(div);
    if(pdfDoc) renderThumb(pdfDoc,i,cw);refreshInkDot(curStage,i);
  }
}
function refreshInkDot(stage,p){
  const d=document.getElementById(`idot-${stage}-${p}`);
  if(d) d.classList.toggle('show',!!(inkData[stage][p]&&inkData[stage][p].length));
}

/* â•â• 7. í•„ê¸° â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function bindInkEvents(canvas){
  canvas.addEventListener('pointerdown',e=>onDown(e,canvas),{passive:false});
  canvas.addEventListener('pointermove',e=>onMove(e,canvas),{passive:false});
  canvas.addEventListener('pointerup',e=>onUp(e,canvas),{passive:false});
  canvas.addEventListener('pointerleave',e=>onUp(e,canvas),{passive:false});
  canvas.addEventListener('contextmenu',e=>e.preventDefault());
}
function pos(e,canvas){const r=canvas.getBoundingClientRect();return{x:(e.clientX-r.left)*(canvas.width/r.width),y:(e.clientY-r.top)*(canvas.height/r.height),p:e.pressure||1};}
function onDown(e,canvas){
  if(!penMode) return;
  e.preventDefault();canvas.setPointerCapture(e.pointerId);isDrawing=true;
  const{x,y,p}=pos(e,canvas);
  curStroke={tool:curTool,color:curTool==='eraser'?null:penColor,size:curTool==='eraser'?penSize*4:penSize,opacity:curTool==='highlighter'?Math.min(penOpacity,0.45):penOpacity,points:[{x,y,p}]};
  drawSeg(canvas,curStroke,x,y,x,y,p);
}
function onMove(e,canvas){
  if(!penMode||!isDrawing||!curStroke) return;
  e.preventDefault();
  const{x,y,p}=pos(e,canvas),pts=curStroke.points,prev=pts[pts.length-1];
  pts.push({x,y,p});drawSeg(canvas,curStroke,prev.x,prev.y,x,y,p);
}
function onUp(e,canvas){
  if(!penMode||!isDrawing||!curStroke) return;
  isDrawing=false;
  const stage=canvas.dataset.stage,num=parseInt(canvas.dataset.page);
  if(!inkData[stage][num]) inkData[stage][num]=[];
  inkData[stage][num].push({...curStroke});
  saveLS(stage,num);refreshInkDot(stage,num);updatePenStatus();curStroke=null;
}
function drawSeg(canvas,stroke,x1,y1,x2,y2,p){
  const ctx=canvas.getContext('2d');ctx.save();
  if(stroke.tool==='eraser'){ctx.globalCompositeOperation='destination-out';ctx.strokeStyle='rgba(0,0,0,1)';ctx.lineWidth=stroke.size*(0.5+p*0.5);}
  else{ctx.globalCompositeOperation=stroke.tool==='highlighter'?'multiply':'source-over';ctx.globalAlpha=stroke.opacity;ctx.strokeStyle=stroke.color;ctx.lineWidth=stroke.size*(0.4+p*0.6);}
  ctx.lineCap='round';ctx.lineJoin='round';ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();ctx.restore();
}
function restoreInk(canvas,stage,num){
  const strokes=inkData[stage][num];if(!strokes||!strokes.length) return;
  const ctx=canvas.getContext('2d');ctx.clearRect(0,0,canvas.width,canvas.height);
  strokes.forEach(s=>{
    const pts=s.points;
    if(pts.length===1){drawSeg(canvas,s,pts[0].x,pts[0].y,pts[0].x+0.1,pts[0].y+0.1,pts[0].p||1);return;}
    for(let i=1;i<pts.length;i++) drawSeg(canvas,s,pts[i-1].x,pts[i-1].y,pts[i].x,pts[i].y,pts[i].p||1);
  });
}
function saveLS(stage,num){try{localStorage.setItem(`kumon-ink-${currentStudentId}-${stage}-${num}`,JSON.stringify(inkData[stage][num]||[]));}catch(e){}}
function loadLS(){
  try{
    ['A','B','C'].forEach(s=>{
      for(let p=1;p<=20;p++){
        const raw=localStorage.getItem(`kumon-ink-${currentStudentId}-${s}-${p}`);
        inkData[s][p]=raw?JSON.parse(raw):[];
        if(localStorage.getItem(`kumon-done-${currentStudentId}-${s}-${p}`)==='1') pagesDone[s][p]=true;
        else delete pagesDone[s][p];
      }
    });
    if(localStorage.getItem('kumon-dark')==='1'){darkMode=true;document.body.classList.add('dark');}
  }catch(e){}
}
function undoStroke(){
  const s=inkData[curStage][curPage];if(!s||!s.length){showToast('ë˜ëŒë¦´ í•„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤');return;}
  s.pop();saveLS(curStage,curPage);
  const c=getIC(curStage,curPage);if(c){c.getContext('2d').clearRect(0,0,c.width,c.height);restoreInk(c,curStage,curPage);}
  refreshInkDot(curStage,curPage);updatePenStatus();showToast('ë˜ëŒë¦¬ê¸° ì™„ë£Œ');
}
function clearPage(){
  if(!confirm(`${curPage}í˜ì´ì§€ì˜ ëª¨ë“  í•„ê¸°ë¥¼ ì§€ìš¸ê¹Œìš”?`)) return;
  inkData[curStage][curPage]=[];saveLS(curStage,curPage);
  const c=getIC(curStage,curPage);if(c) c.getContext('2d').clearRect(0,0,c.width,c.height);
  refreshInkDot(curStage,curPage);updatePenStatus();showToast('í•„ê¸° ì´ˆê¸°í™” ì™„ë£Œ');
}
async function saveAsImage(){
  const pd=document.querySelector(`.b5-page[data-page="${curPage}"]`);if(!pd){showToast('í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');return;}
  const pdfC=pd.querySelector('canvas.pdf-layer'),inkC=pd.querySelector('canvas.ink-canvas');
  if(!pdfC){showToast('PDFê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');return;}
  const merged=document.createElement('canvas');merged.width=pdfC.width;merged.height=pdfC.height;
  const ctx=merged.getContext('2d');ctx.drawImage(pdfC,0,0);if(inkC) ctx.drawImage(inkC,0,0);
  const a=document.createElement('a');a.download=`êµ¬ëª¬ìˆ˜í•™_${curStage}ë‹¨ê³„_${curPage}í˜ì´ì§€.png`;a.href=merged.toDataURL('image/png');a.click();
  showToast(`${curPage}í˜ì´ì§€ ì €ì¥ ì™„ë£Œ ğŸ‰`);
}
function getIC(stage,num){return document.querySelector(`.ink-canvas[data-stage="${stage}"][data-page="${num}"]`);}
function refreshCanvasModes(){
  document.querySelectorAll('.ink-canvas').forEach(c=>{c.classList.toggle('active',penMode);c.classList.toggle('eraser-mode',penMode&&curTool==='eraser');});
}
function updatePenStatus(){
  const total=Object.values(inkData[curStage]).reduce((s,a)=>s+(a?a.length:0),0);
  const el=document.getElementById('pen-status');
  el.className='pen-status'+(total?' has-ink':'');el.textContent=total?`âœï¸ í•„ê¸° ëª¨ë“œ (${total}íš)`:'âœï¸ í•„ê¸° ëª¨ë“œ ì¼œì§';
}

/* â•â• 8. í˜ì´ì§€ ì™„ë£Œ ì²´í¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function togglePageDone(){
  const isDone=!pagesDone[curStage][curPage];
  if(isDone) pagesDone[curStage][curPage]=true; else delete pagesDone[curStage][curPage];
  localStorage.setItem(`kumon-done-${currentStudentId}-${curStage}-${curPage}`,isDone?'1':'0');
  const badge=document.getElementById(`done-badge-${curStage}-${curPage}`);if(badge) badge.classList.toggle('show',isDone);
  const tchk=document.getElementById(`tchk-${curStage}-${curPage}`);if(tchk) tchk.classList.toggle('show',isDone);
  document.getElementById('btn-done-check').classList.toggle('on',isDone);
  updateUI();updateProgressBars();refreshProgressPanel();
  if(isDone){ checkStreak(); addPoints(10,'í˜ì´ì§€ ì™„ë£Œ'); }
  showToast(isDone?`âœ“ ${curPage}í˜ì´ì§€ ì™„ë£Œ! +10pt ğŸŒŸ`:`${curPage}í˜ì´ì§€ ì™„ë£Œ ì·¨ì†Œ`);
}
function updateProgressBars(){
  ['A','B','C'].forEach(s=>{
    const total=totalPages[s],done=Object.values(pagesDone[s]).filter(v=>v).length;
    const pct=total>0?Math.round(done/total*100):0;
    const fl=document.getElementById(`prog-${s.toLowerCase()}`),lb=document.getElementById(`prog-${s.toLowerCase()}-pct`);
    if(fl) fl.style.width=pct+'%';if(lb) lb.textContent=pct+'%';
  });
}

/* â•â• 9. ì§„ë„ íŒ¨ë„ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleProgress(){
  const panel=document.getElementById('progress-panel');panel.classList.toggle('open');
  document.getElementById('btn-progress').classList.toggle('on',panel.classList.contains('open'));
  if(panel.classList.contains('open')) refreshProgressPanel();
}
function refreshProgressPanel(){
  const content=document.getElementById('pp-content');let html='';
  ['A','B','C'].forEach(s=>{
    const total=totalPages[s],done=Object.values(pagesDone[s]).filter(v=>v).length;
    const pct=total>0?Math.round(done/total*100):0,c=STAGE_CFG[s];
    html+=`<div class="pp-stage-name">${c.label} Â· ${c.sub}</div>
    <div class="pp-bar-wrap"><div class="pp-bar" style="width:${pct}%;background:${c.color}"></div></div>
    <div class="pp-pct">${done} / ${total} (${pct}%)</div>
    <div class="pp-pages">`;
    for(let i=1;i<=total;i++){
      const cls=pagesDone[s][i]?'done':(s===curStage&&i===curPage)?'cur':'';
      html+=`<div class="pp-page ${cls}" onclick="switchStage('${s}');goToPage(${i});toggleProgress();">${i}</div>`;
    }
    html+='</div>';
  });
  content.innerHTML=html;
}

/* â•â• 10. íƒ€ì´ë¨¸ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleTimerBar(){
  timerBarVisible=!timerBarVisible;
  document.getElementById('timer-bar').classList.toggle('hidden',!timerBarVisible);
  document.getElementById('btn-timer-toggle').classList.toggle('on',timerBarVisible);
}
function toggleTimer(){
  if(timerRunning){clearInterval(timerInterval);timerRunning=false;document.getElementById('timer-start-btn').textContent='ê³„ì†';document.getElementById('timer-start-btn').classList.remove('on');}
  else{timerRunning=true;document.getElementById('timer-start-btn').textContent='ì •ì§€';document.getElementById('timer-start-btn').classList.add('on');timerInterval=setInterval(tickTimer,1000);}
}
function tickTimer(){
  timerSec++;updateTimerDisplay();
  if(timerGoal>0&&timerSec>=timerGoal){clearInterval(timerInterval);timerRunning=false;document.getElementById('timer-start-btn').textContent='ì™„ë£Œ!';document.getElementById('timer-display').classList.add('warn');showToast(`ğŸ‰ ëª©í‘œ ë‹¬ì„±! (${fmtTime(timerGoal)})`);}
}
function resetTimer(){clearInterval(timerInterval);timerRunning=false;timerSec=0;updateTimerDisplay();document.getElementById('timer-start-btn').textContent='ì‹œì‘';document.getElementById('timer-start-btn').classList.remove('on');document.getElementById('timer-display').classList.remove('warn');}
function setTimerGoal(){timerGoal=parseInt(document.getElementById('timer-goal').value)||0;}
function updateTimerDisplay(){document.getElementById('timer-display').textContent=fmtTime(timerSec);}
function fmtTime(s){return String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0');}

/* â•â• 11. ìŒì„± ì±„ì  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PROBLEMS=[
  {q:'12 + 34 = ?',a:'46'},{q:'25 + 38 = ?',a:'63'},{q:'47 - 19 = ?',a:'28'},
  {q:'8 Ã— 7 = ?',a:'56'},{q:'72 Ã· 8 = ?',a:'9'},{q:'15 + 27 = ?',a:'42'},
  {q:'36 - 18 = ?',a:'18'},{q:'9 Ã— 6 = ?',a:'54'},{q:'45 Ã· 9 = ?',a:'5'},
];
function openVoice(){
  vmInput='';vmCorrect=0;vmWrong=0;
  document.getElementById('vm-correct').textContent='0';document.getElementById('vm-wrong').textContent='0';
  document.getElementById('vm-input-display').textContent='â€”';
  setVmProblem();document.getElementById('voice-modal').classList.add('open');
}
function closeVoice(){stopVoice();document.getElementById('voice-modal').classList.remove('open');document.getElementById('st-score').textContent=`${vmCorrect}ì • ${vmWrong}ì˜¤`;}
function setVmProblem(){
  vmCurrentProblem=PROBLEMS[Math.floor(Math.random()*PROBLEMS.length)];
  document.getElementById('vm-problem').textContent=vmCurrentProblem.q;
  const vb=document.getElementById('vm-voice-box');vb.textContent='ë§í•˜ê¸° ì¤€ë¹„ë¨';vb.className='vm-voice-box';
  vmInput='';document.getElementById('vm-input-display').textContent='â€”';
}
function toggleVoice(){
  if(vmListening){stopVoice();return;}
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){showToast('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');return;}
  recognition=new SR();recognition.lang='ko-KR';recognition.interimResults=true;
  recognition.onstart=()=>{vmListening=true;document.getElementById('vm-mic-btn').classList.add('on');const vb=document.getElementById('vm-voice-box');vb.textContent='ğŸ¤ ë“£ê³  ìˆìŠµë‹ˆë‹¤...';vb.className='vm-voice-box listening';};
  recognition.onresult=e=>{
    const t=Array.from(e.results).map(r=>r[0].transcript).join('');
    document.getElementById('vm-voice-box').textContent=t;
    if(e.results[e.results.length-1].isFinal){document.getElementById('vm-input-display').textContent=t.replace(/\s/g,'');checkVmAnswer(t.replace(/\s/g,''));}
  };
  recognition.onerror=()=>{stopVoice();showToast('ìŒì„± ì¸ì‹ ì˜¤ë¥˜. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');};
  recognition.onend=()=>{vmListening=false;document.getElementById('vm-mic-btn').classList.remove('on');};
  recognition.start();
}
function stopVoice(){if(recognition) recognition.stop();vmListening=false;document.getElementById('vm-mic-btn').classList.remove('on');}
function checkVmAnswer(ans){
  const correct=vmCurrentProblem.a;
  const q=vmCurrentProblem.q;
  const isOk=ans.includes(correct)||ans.replace(/[^0-9]/g,'')===correct.replace(/[^0-9]/g,'');
  const vb=document.getElementById('vm-voice-box');
  if(isOk){
    vb.textContent='â­• ì •ë‹µ!';vb.className='vm-voice-box correct';
    vmCorrect++;document.getElementById('vm-correct').textContent=vmCorrect;
    addPoints(5,'ì •ë‹µ');
    setTimeout(setVmProblem,1200);
  } else {
    vb.textContent=`âŒ ì˜¤ë‹µ! ì •ë‹µ: ${correct}`;vb.className='vm-voice-box wrong';
    vmWrong++;document.getElementById('vm-wrong').textContent=vmWrong;
    addWrongNote(q, correct, ans); // ì˜¤ë‹µë…¸íŠ¸ ìë™ ì €ì¥
    updateWrongBadge();
    setTimeout(setVmProblem,1800);
  }
}
function vmKey(d){vmInput+=d;document.getElementById('vm-input-display').textContent=vmInput;}
function vmDel(){vmInput=vmInput.slice(0,-1);document.getElementById('vm-input-display').textContent=vmInput||'â€”';}
function vmSubmit(){if(vmInput) checkVmAnswer(vmInput);}

/* â•â• 12. í•„ê¸° ëª¨ë“œ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function togglePenMode(){
  penMode=!penMode;
  document.getElementById('btn-pen-mode').classList.toggle('on',penMode);
  document.getElementById('pen-toolbar').classList.toggle('hidden',!penMode);
  document.getElementById('st-ink').textContent=penMode?'ON âœï¸':'OFF';
  document.getElementById('viewer').style.overflowY=penMode?'hidden':'auto';
  refreshCanvasModes();showToast(penMode?'í•„ê¸° ëª¨ë“œ ì¼œì§ âœï¸':'í•„ê¸° ëª¨ë“œ êº¼ì§');
}
function setTool(t){curTool=t;['pen','highlighter','eraser'].forEach(x=>document.getElementById(`tool-${x}`).classList.toggle('on',x===t));document.getElementById('color-palette').style.opacity=t==='eraser'?'0.3':'1';refreshCanvasModes();}
function setColor(c){penColor=c;document.querySelectorAll('.color-dot').forEach(d=>d.classList.toggle('on',d.dataset.c===c));if(curTool==='eraser') setTool('pen');}
function updateSize(){penSize=parseInt(document.getElementById('pen-size').value);const d=document.getElementById('pen-dot');d.style.width=d.style.height=penSize+'px';d.style.background=penColor;}
function updateOpacity(){const v=parseInt(document.getElementById('pen-opacity').value);penOpacity=v/100;document.getElementById('opacity-val').textContent=v+'%';}

/* â•â• 13. í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('keydown',e=>{
  if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();undoStroke();}
  if(!e.ctrlKey&&!e.metaKey){
    if(e.key==='p'||e.key==='P') togglePenMode();
    if(penMode&&(e.key==='e'||e.key==='E')) setTool('eraser');
    if(penMode&&(e.key==='h'||e.key==='H')) setTool('highlighter');
    if(penMode&&e.key==='1') setTool('pen');
    if(e.key==='Escape'&&penMode) togglePenMode();
  }
});

/* â•â• 14. í† ìŠ¤íŠ¸ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),2200);}

/* â•â• 15. í˜ì´ì§€ ì´ë™ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function goToPage(num){curPage=num;document.querySelector(`.b5-page[data-page="${num}"]`)?.scrollIntoView({behavior:'smooth',block:'start'});updateUI();closePJ();}

/* â•â• 16. UI ì—…ë°ì´íŠ¸ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateUI(){
  const total=totalPages[curStage];
  document.getElementById('pj-label').textContent=`${curPage} / ${total}`;
  document.getElementById('tb-info').textContent=`${curPage} / ${total} Â· B5 176Ã—250mm`;
  document.getElementById('st-page').textContent=`${curPage}/${total}`;
  document.getElementById('st-stage').textContent=STAGE_CFG[curStage].label;
  const done=Object.values(pagesDone[curStage]).filter(v=>v).length;
  document.getElementById('st-done').textContent=`${done}p`;
  document.querySelectorAll('.thumb').forEach(t=>t.classList.toggle('on',parseInt(t.dataset.page)===curPage));
  document.querySelectorAll('.pj-item').forEach(d=>d.classList.toggle('on',parseInt(d.textContent)===curPage));
  document.getElementById('btn-done-check').classList.toggle('on',!!pagesDone[curStage][curPage]);
}

/* â•â• 17. ë‹¨ê³„ ì „í™˜ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchStage(s){
  if(s===curStage) return;
  curStage=s;curPage=1;const c=STAGE_CFG[s];
  const ov=document.getElementById('overlay');
  document.getElementById('overlay-txt').textContent=c.label;document.getElementById('overlay-txt').style.background=c.color;
  ov.classList.add('show');setTimeout(()=>ov.classList.remove('show'),650);
  applyColors(s);
  document.querySelectorAll('.stage-tab').forEach(t=>t.classList.toggle('on',t.dataset.s===s));
  document.getElementById('logo-icon').textContent=c.label.slice(0,2);
  document.getElementById('tb-label').textContent=`${c.label} Â· ${c.sub}`;
  document.getElementById('sb-title').textContent=`${c.label} í˜ì´ì§€`;
  renderAll();
}

/* â•â• 18. ì¤Œ / ë ˆì´ì•„ì›ƒ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function chZoom(d){zoom=Math.max(50,Math.min(200,zoom+d));applyZoom();}
function resetZoom(){zoom=100;applyZoom();}
function applyZoom(){const w=document.getElementById('pages-wrap');w.style.transform=`scale(${zoom/100})`;w.style.marginBottom=`${w.scrollHeight*(zoom/100-1)}px`;document.getElementById('zoom-val').textContent=zoom+'%';document.getElementById('st-zoom').textContent=zoom+'%';}
function setLayout(v){layout=v;document.getElementById('btn-single').classList.toggle('on',v==='single');document.getElementById('btn-double').classList.toggle('on',v==='double');document.getElementById('pages-wrap').className='pages-wrap'+(v==='double'?' double':'');}

/* â•â• 19. ì‚¬ì´ë“œë°” / í€µë©”ë‰´ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleSidebar(){sidebarOn=!sidebarOn;document.getElementById('sidebar').classList.toggle('hidden',!sidebarOn);}
function logoutStudent(){
  if(!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  document.getElementById('app-main').style.display='none';
  document.getElementById('lock-screen').classList.remove('hidden');
  document.getElementById('profile-select').classList.remove('hidden');
  document.getElementById('pin-screen').classList.remove('show');
  currentStudent=null;currentStudentId='default';pinBuf='';
  // ë°ì´í„° ì´ˆê¸°í™”
  ['A','B','C'].forEach(s=>{inkData[s]={};pagesDone[s]={};});
  renderProfiles();
  showToast('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
}
function hideQuickmenu(){document.getElementById('quickmenu').classList.add('qm-hidden');document.getElementById('qm-show-btn').classList.add('show');showToast('í€µë©”ë‰´ ìˆ¨ê¹€');}
function showQuickmenu(){document.getElementById('quickmenu').classList.remove('qm-hidden');document.getElementById('qm-show-btn').classList.remove('show');}

/* â•â• 20. í˜ì´ì§€ ì í”„ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildPJ(){
  const dd=document.getElementById('pj-dd');dd.innerHTML='';
  for(let i=1;i<=totalPages[curStage];i++){
    const d=document.createElement('div');
    d.className='pj-item'+(i===curPage?' on':pagesDone[curStage][i]?' done':'');
    d.textContent=i;d.onclick=()=>goToPage(i);dd.appendChild(d);
  }
}
function togglePJ(){document.getElementById('pj-dd').classList.toggle('open');}
function closePJ(){document.getElementById('pj-dd').classList.remove('open');}
document.addEventListener('click',e=>{if(!e.target.closest('.pj-wrap')) closePJ();});

/* â•â• 22. ê²Œì´ë¯¸í”¼ì¼€ì´ì…˜ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const BADGES=[
  {id:'first_done',icon:'ğŸŒŸ',name:'ì²« ì™„ë£Œ!',desc:'ì²« í˜ì´ì§€ ì™„ë£Œ',condition:s=>s.totalDone>=1},
  {id:'streak3',icon:'ğŸ”¥',name:'3ì¼ ì—°ì†',desc:'3ì¼ ì—°ì† í•™ìŠµ',condition:s=>s.streak>=3},
  {id:'streak7',icon:'ğŸ’«',name:'7ì¼ ì—°ì†',desc:'7ì¼ ì—°ì† í•™ìŠµ',condition:s=>s.streak>=7},
  {id:'points100',icon:'â­',name:'100ì  ë‹¬ì„±',desc:'ëˆ„ì  100í¬ì¸íŠ¸',condition:s=>s.points>=100},
  {id:'points500',icon:'ğŸ†',name:'500ì  ë‹¬ì„±',desc:'ëˆ„ì  500í¬ì¸íŠ¸',condition:s=>s.points>=500},
  {id:'done10',icon:'ğŸ“š',name:'10ì¥ ì™„ë£Œ',desc:'10í˜ì´ì§€ ì™„ë£Œ',condition:s=>s.totalDone>=10},
  {id:'done30',icon:'ğŸ“',name:'30ì¥ ì™„ë£Œ',desc:'30í˜ì´ì§€ ì™„ë£Œ',condition:s=>s.totalDone>=30},
  {id:'all_a',icon:'ğŸ…°ï¸',name:'Aë‹¨ê³„ ì •ë³µ',desc:'Aë‹¨ê³„ ì „ì²´ ì™„ë£Œ',condition:s=>s.stagesDone&&s.stagesDone.A},
];
const XP_PER_LEVEL=100;

function getGameData(){
  try{const r=localStorage.getItem(`kumon-game-${currentStudentId}`);return r?JSON.parse(r):{points:0,xp:0,level:1,streak:0,lastDate:'',badges:[],totalDone:0,stagesDone:{}};}
  catch(e){return{points:0,xp:0,level:1,streak:0,lastDate:'',badges:[],totalDone:0,stagesDone:{}};}
}
function saveGameData(d){localStorage.setItem(`kumon-game-${currentStudentId}`,JSON.stringify(d));}

function addPoints(pts, reason){
  if(!currentStudentId||currentStudentId==='default') return;
  const d=getGameData();
  d.points+=pts; d.xp+=pts;
  // ë ˆë²¨ì—…
  while(d.xp>=XP_PER_LEVEL*d.level){ d.xp-=XP_PER_LEVEL*d.level; d.level++; showToast(`ğŸ‰ ë ˆë²¨ ì—…! Lv.${d.level} ë‹¬ì„±!`); }
  saveGameData(d); updateGameBar();
  // íŒì—…
  showPointPopup(`+${pts}pt`, reason);
  checkBadges();
}

function checkStreak(){
  const d=getGameData();
  const today=new Date().toDateString();
  const yesterday=new Date(Date.now()-86400000).toDateString();
  if(d.lastDate===today) return;
  if(d.lastDate===yesterday){ d.streak++; }
  else if(d.lastDate!==today){ d.streak=1; }
  d.lastDate=today;
  saveGameData(d); updateGameBar();
  if(d.streak>1) showToast(`ğŸ”¥ ${d.streak}ì¼ ì—°ì† í•™ìŠµ ì¤‘!`);
}

function checkBadges(){
  const d=getGameData();
  // totalDone ê³„ì‚°
  let total=0;
  ['A','B','C'].forEach(s=>{for(let p=1;p<=20;p++){if(localStorage.getItem(`kumon-done-${currentStudentId}-${s}-${p}`)==='1') total++;}});
  d.totalDone=total;
  BADGES.forEach(b=>{
    if(!d.badges.includes(b.id)&&b.condition(d)){
      d.badges.push(b.id);
      saveGameData(d);
      showBadgeToast(b);
    }
  });
  saveGameData(d);
}

function showBadgeToast(badge){
  const t=document.getElementById('badge-toast');
  document.getElementById('badge-toast-icon').textContent=badge.icon;
  document.getElementById('badge-toast-name').textContent=badge.name;
  t.classList.add('show');
  clearTimeout(t._t); t._t=setTimeout(()=>t.classList.remove('show'),3000);
}

function showPointPopup(text){
  const el=document.createElement('div');
  el.className='point-popup'; el.textContent=text;
  // í˜„ì¬ í˜ì´ì§€ ê·¼ì²˜ì— í‘œì‹œ
  el.style.left=(Math.random()*60+20)+'%';
  el.style.top='40%';
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),1300);
}

function updateGameBar(){
  const d=getGameData();
  const level=d.level||1, xp=d.xp||0, maxXp=XP_PER_LEVEL*level;
  document.getElementById('game-level').textContent=`Lv.${level}`;
  document.getElementById('game-xp-fill').style.width=Math.min(100,xp/maxXp*100)+'%';
  document.getElementById('game-xp-txt').textContent=`${xp}/${maxXp}`;
  const streak=d.streak||0;
  const sg=document.getElementById('game-streak');
  sg.textContent=`ğŸ”¥ ${streak}ì¼`;sg.className='game-streak'+(streak>=3?' active':'');
  document.getElementById('game-points').textContent=`â­ ${d.points||0}pt`;
  // ë¯¸ë‹ˆ ë°°ì§€
  const mini=document.getElementById('game-badges-mini');
  mini.innerHTML=(d.badges||[]).slice(-4).map(id=>{const b=BADGES.find(x=>x.id===id);return b?`<span class="game-badge-icon" title="${b.name}">${b.icon}</span>`:''}).join('');
}

/* â•â• 23. ì˜¤ë‹µë…¸íŠ¸ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getWrongNotes(){
  try{const r=localStorage.getItem(`kumon-wrong-${currentStudentId}`);return r?JSON.parse(r):[];}
  catch(e){return[];}
}
function saveWrongNotes(arr){localStorage.setItem(`kumon-wrong-${currentStudentId}`,JSON.stringify(arr));}

function addWrongNote(question, correctAnswer, myAnswer){
  const notes=getWrongNotes();
  // ì¤‘ë³µ ë°©ì§€
  if(notes.find(n=>n.q===question)) return;
  notes.unshift({id:Date.now(),q:question,correct:correctAnswer,mine:myAnswer,stage:curStage,page:curPage,date:new Date().toLocaleDateString('ko-KR')});
  if(notes.length>50) notes.splice(50); // ìµœëŒ€ 50ê°œ
  saveWrongNotes(notes);
  updateWrongBadge();
}

function updateWrongBadge(){
  const notes=getWrongNotes();
  const badge=document.getElementById('wrong-count-badge');
  if(notes.length>0){badge.textContent=notes.length;badge.style.display='';}
  else{badge.style.display='none';}
}

function toggleWrongPanel(){
  const panel=document.getElementById('wrong-panel');
  panel.classList.toggle('open');
  if(panel.classList.contains('open')) renderWrongNotes();
}

function renderWrongNotes(){
  const notes=getWrongNotes();
  const body=document.getElementById('wrong-body');
  if(!notes.length){
    body.innerHTML=`<div class="wp-empty">ğŸ“ ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤!<br><br>ìŒì„± ì±„ì ì—ì„œ í‹€ë¦° ë¬¸ì œê°€<br>ì—¬ê¸°ì— ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</div>`;
    return;
  }
  body.innerHTML=notes.map(n=>`
    <div class="wrong-item" onclick="goToPage(${n.page});toggleWrongPanel();">
      <div class="wrong-item-header">
        <span class="wrong-item-stage">${n.stage}ë‹¨ê³„ ${n.page}p</span>
        <span class="wrong-item-date">${n.date}</span>
      </div>
      <div class="wrong-item-q">${n.q}</div>
      <div class="wrong-item-ans">ë‚´ ë‹µ: ${n.mine||'?'} â†’ ì •ë‹µ: <span>${n.correct}</span></div>
    </div>
  `).join('');
}

function clearWrongNotes(){
  if(!confirm('ì˜¤ë‹µë…¸íŠ¸ë¥¼ ì „ì²´ ì‚­ì œí• ê¹Œìš”?')) return;
  saveWrongNotes([]);
  renderWrongNotes();
  updateWrongBadge();
  showToast('ì˜¤ë‹µë…¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
}

/* â•â• 21. PWA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
if('serviceWorker' in navigator){
  window.addEventListener('load',async()=>{
    try{
      const reg=await navigator.serviceWorker.register('sw.js');
      reg.addEventListener('updatefound',()=>{const nw=reg.installing;nw.addEventListener('statechange',()=>{if(nw.state==='installed'&&navigator.serviceWorker.controller) showToast('ìƒˆ ë²„ì „ì´ ìˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”! ğŸ”„');});});
    }catch(e){}
  });
}
let deferredInstallPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();deferredInstallPrompt=e;
  if(!window.matchMedia('(display-mode: standalone)').matches&&!localStorage.getItem('pwa-install-dismissed')){
    setTimeout(()=>{
      const banner=document.createElement('div');
      banner.style.cssText='position:fixed;bottom:40px;left:50%;transform:translateX(-50%);background:#1e1c18;color:#d0c8b8;padding:14px 20px;border-radius:12px;font-family:Noto Sans KR,sans-serif;font-size:13px;box-shadow:0 8px 32px rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.12);display:flex;align-items:center;gap:14px;z-index:9999;white-space:nowrap;';
      banner.innerHTML=`<span>ğŸ“± í™ˆí™”ë©´ì— ì„¤ì¹˜í•  ìˆ˜ ìˆì–´ìš”!</span><button onclick="installPWA()" style="background:var(--stage-color);color:white;border:none;padding:7px 16px;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;">ì„¤ì¹˜</button><button onclick="this.parentElement.remove();localStorage.setItem('pwa-install-dismissed','1')" style="background:none;border:none;color:#9a9488;font-size:16px;cursor:pointer;">âœ•</button>`;
      document.body.appendChild(banner);
    },3000);
  }
});
async function installPWA(){if(!deferredInstallPrompt) return;deferredInstallPrompt.prompt();const{outcome}=await deferredInstallPrompt.userChoice;if(outcome==='accepted') showToast('ì•± ì„¤ì¹˜ ì™„ë£Œ! ğŸ‰');deferredInstallPrompt=null;document.querySelector('[onclick*="installPWA"]')?.closest('div')?.remove();}
</script>
</body>
</html>
