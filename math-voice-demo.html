<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>êµ¬ëª¬ìˆ˜í•™ Â· ìŒì„± ì±„ì </title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=DM+Mono:wght@400;500&family=Noto+Serif+KR:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f5f2ed;--card:#fff;--border:#e0dbd2;
  --ink:#1a1814;--ink-mid:#4a4540;--ink-light:#9a9088;
  --a:#e8401c;--b:#1a7fd4;--c:#1aad6e;--gold:#f5a623;
  --shadow:0 4px 24px rgba(0,0,0,0.08);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;}

/* í—¤ë” */
.header{background:var(--card);border-bottom:1px solid var(--border);padding:0 20px;height:58px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:var(--shadow);}
.h-logo{display:flex;align-items:center;gap:10px;}
.h-icon{width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,#e8401c,#f5a623);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:12px;}
.h-title{font-size:14px;font-weight:700;}
.h-sub{font-size:10px;color:var(--ink-light);}
.h-score{display:flex;align-items:center;gap:6px;padding:5px 13px;border-radius:20px;background:linear-gradient(135deg,#1aad6e,#76d4a8);color:white;font-family:'DM Mono',monospace;font-size:12px;}

/* ë©”ì¸ */
.main{max-width:680px;margin:0 auto;padding:24px 16px 80px;}

/* ìŠ¤ì½”ì–´ */
.scoreboard{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px 18px;display:flex;align-items:center;gap:14px;box-shadow:var(--shadow);margin-bottom:18px;flex-wrap:wrap;}
.sc-item{display:flex;flex-direction:column;align-items:center;gap:2px;flex:1;min-width:48px;}
.sc-val{font-family:'DM Mono',monospace;font-size:24px;font-weight:500;}
.sc-div{width:1px;height:32px;background:var(--border);}
.sc-bar-wrap{flex:2;min-width:100px;}
.sc-bar-lbl{font-size:10px;color:var(--ink-light);margin-bottom:4px;font-family:'DM Mono',monospace;}
.sc-bar{height:6px;background:var(--border);border-radius:3px;overflow:hidden;}
.sc-bar-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,#1aad6e,#76d4a8);transition:width 0.5s;}
.sc-lbl{font-size:10px;color:var(--ink-light);}

/* ìœ í˜• íƒ­ */
.type-tabs{display:flex;gap:5px;margin-bottom:18px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none;}
.type-tabs::-webkit-scrollbar{display:none;}
.type-tab{display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 12px;border-radius:10px;border:2px solid var(--border);background:var(--card);cursor:pointer;transition:all 0.18s;flex-shrink:0;min-width:68px;}
.type-tab:hover{border-color:var(--a);}
.type-tab.on{border-color:var(--a);background:#fde8e3;}
.type-tab-icon{font-size:18px;}
.type-tab-name{font-size:9px;font-weight:700;color:var(--ink-mid);white-space:nowrap;}
.type-tab.on .type-tab-name{color:var(--a);}

/* ë¬¸ì œ ì¹´ë“œ */
.prob-card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);overflow:hidden;margin-bottom:16px;animation:slideIn 0.3s ease;}
@keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.prob-topbar{height:5px;background:linear-gradient(90deg,var(--a),var(--gold));transition:background 0.4s;}
.prob-inner{padding:22px 24px;}
.prob-meta{display:flex;align-items:center;gap:7px;margin-bottom:16px;}
.prob-badge{padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;font-family:'DM Mono',monospace;}
.new-btn{padding:4px 10px;border-radius:6px;border:1px solid var(--border);background:none;font-size:11px;color:var(--ink-mid);cursor:pointer;transition:all 0.15s;margin-left:auto;}
.new-btn:hover{border-color:var(--a);color:var(--a);}
.prob-num{font-size:11px;color:var(--ink-light);font-family:'DM Mono',monospace;}

/* ìˆ˜ì‹ */
.eq-wrap{display:flex;align-items:center;justify-content:center;min-height:100px;margin-bottom:20px;}
.eq-h{font-family:'Noto Serif KR',serif;font-size:48px;font-weight:700;display:flex;align-items:center;gap:12px;}
.eq-op{color:var(--a);}
.eq-eq{color:var(--ink-light);}
.eq-blank{display:inline-flex;align-items:center;justify-content:center;min-width:68px;height:56px;border-bottom:4px solid var(--ink);font-size:48px;color:var(--b);transition:all 0.3s;}
.eq-blank.correct{border-color:var(--c);color:var(--c);}
.eq-blank.wrong{border-color:var(--a);color:var(--a);}
.eq-v{font-family:'Noto Serif KR',serif;display:flex;flex-direction:column;align-items:flex-end;gap:2px;font-size:40px;font-weight:700;}
.eq-v-op{color:var(--a);font-size:32px;}
.eq-v-line{width:100%;height:3px;background:var(--ink);margin:2px 0 5px;border-radius:2px;}
.eq-gugu{font-family:'Noto Serif KR',serif;font-size:44px;font-weight:700;display:flex;align-items:center;gap:10px;background:linear-gradient(135deg,#fde8e3,#fff8f0);padding:14px 24px;border-radius:14px;border:2px solid #f4a48e;}
.eq-dv{font-family:'Noto Serif KR',serif;font-size:36px;font-weight:700;display:flex;align-items:stretch;}
.div-divisor{align-self:flex-end;padding-bottom:5px;padding-right:3px;}
.div-bracket{border-left:3px solid var(--ink);border-top:3px solid var(--ink);padding:5px 12px 5px 8px;display:flex;flex-direction:column;gap:3px;}
.div-q{color:var(--b);}

/* â”€â”€ ì…ë ¥ ì˜ì—­ â”€â”€ */
.input-area{display:flex;flex-direction:column;align-items:center;gap:14px;}

/* ìŒì„± ìƒíƒœì°½ */
.voice-box{
  width:100%;max-width:340px;min-height:48px;
  padding:10px 16px;border-radius:12px;
  border:2px dashed var(--border);
  background:var(--bg);
  font-size:15px;font-family:'DM Mono',monospace;
  color:var(--ink-light);text-align:center;
  display:flex;align-items:center;justify-content:center;
  transition:all 0.25s;
}
.voice-box.ready   {border-color:var(--border);color:var(--ink-light);}
.voice-box.listening{border-color:var(--a);border-style:solid;background:#fff5f3;color:var(--a);}
.voice-box.interim {border-color:var(--gold);border-style:solid;background:#fffbf0;color:#b07c10;}
.voice-box.correct {border-color:var(--c);border-style:solid;background:#f0fbf6;color:var(--c);}
.voice-box.wrong   {border-color:var(--a);border-style:solid;background:#fff5f3;color:var(--a);}
.voice-box.error   {border-color:#9b59b6;border-style:solid;background:#f8f0ff;color:#9b59b6;}

/* ë§ˆì´í¬ ë²„íŠ¼ */
.mic-btn{
  width:72px;height:72px;border-radius:50%;border:none;
  background:linear-gradient(135deg,var(--a),var(--gold));
  color:white;font-size:28px;cursor:pointer;
  transition:all 0.2s;box-shadow:0 4px 16px rgba(232,64,28,0.3);
  display:flex;align-items:center;justify-content:center;
  position:relative;user-select:none;-webkit-user-select:none;
}
.mic-btn:hover{transform:scale(1.05);}
.mic-btn:active{transform:scale(0.95);}
.mic-btn.on{
  background:linear-gradient(135deg,#c01010,#e8401c);
  animation:micPulse 1s infinite;
}
@keyframes micPulse{
  0%,100%{box-shadow:0 4px 16px rgba(200,16,16,0.4),0 0 0 0 rgba(200,16,16,0.2);}
  50%{box-shadow:0 4px 16px rgba(200,16,16,0.4),0 0 0 16px rgba(200,16,16,0);}
}
.mic-lbl{font-size:11px;color:var(--ink-light);font-family:'DM Mono',monospace;}

/* í‚¤íŒ¨ë“œ */
.keypad-wrap{width:100%;max-width:280px;}
.keypad-display{
  width:100%;padding:10px 14px;border-radius:10px;
  border:2px solid var(--border);background:var(--bg);
  font-family:'DM Mono',monospace;font-size:28px;font-weight:500;
  color:var(--ink);text-align:center;margin-bottom:8px;
  min-height:52px;display:flex;align-items:center;justify-content:center;
  transition:border-color 0.2s;letter-spacing:0.05em;
}
.keypad-display.has-val{border-color:var(--b);color:var(--b);}
.keypad-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;}
.kp-btn{
  padding:14px 0;border-radius:10px;border:1.5px solid var(--border);
  background:var(--card);font-family:'DM Mono',monospace;font-size:20px;font-weight:500;
  color:var(--ink);cursor:pointer;transition:all 0.12s;
  display:flex;align-items:center;justify-content:center;
}
.kp-btn:hover{background:var(--bg);border-color:var(--b);}
.kp-btn:active{transform:scale(0.94);background:#e0eefc;}
.kp-btn.zero{grid-column:span 2;}
.kp-btn.del{background:#fde8e3;border-color:#f4a48e;color:var(--a);}
.kp-btn.del:hover{background:#fbd0c8;}
.kp-submit{
  width:100%;margin-top:6px;padding:13px;border-radius:10px;border:none;
  background:var(--b);color:white;font-size:15px;font-weight:700;
  font-family:'Noto Sans KR',sans-serif;cursor:pointer;transition:all 0.18s;
}
.kp-submit:hover{background:#1567b0;}
.kp-submit:active{transform:scale(0.97);}

/* íƒ­ í† ê¸€ (ìŒì„± / í‚¤íŒ¨ë“œ) */
.input-tabs{display:flex;gap:0;border:1.5px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:4px;}
.input-tab{flex:1;padding:8px;text-align:center;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.18s;color:var(--ink-mid);background:var(--card);}
.input-tab.on{background:var(--a);color:white;}

/* í”¼ë“œë°± */
.feedback{text-align:center;padding:11px 16px;border-radius:12px;font-size:15px;font-weight:700;display:none;animation:popIn 0.3s ease;width:100%;}
@keyframes popIn{from{transform:scale(0.85);opacity:0}to{transform:scale(1);opacity:1}}
.feedback.correct{display:block;background:#dcf5eb;color:var(--c);border:2px solid var(--c);}
.feedback.wrong  {display:block;background:#fde8e3;color:var(--a);border:2px solid var(--a);}
.feedback.perfect{display:block;background:linear-gradient(135deg,#fef9e7,#fde8e3);color:var(--gold);border:2px solid var(--gold);}

/* ì´ë ¥ */
.history-wrap{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px 16px;box-shadow:var(--shadow);}
.history-hd{font-size:10px;font-weight:700;color:var(--ink-light);margin-bottom:8px;font-family:'DM Mono',monospace;letter-spacing:0.08em;}
.history-list{display:flex;flex-direction:column;gap:4px;max-height:160px;overflow-y:auto;}
.h-item{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:7px;background:var(--bg);border:1px solid var(--border);font-size:11px;font-family:'DM Mono',monospace;}
.h-eq{flex:1;color:var(--ink-mid);}
.h-my{font-weight:700;}
.h-my.c{color:var(--c);}
.h-my.w{color:var(--a);}

/* í† ìŠ¤íŠ¸ */
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(8px);background:#1e1c18;color:#d0c8b8;padding:10px 20px;border-radius:9px;font-size:12px;opacity:0;transition:all 0.3s;z-index:9999;white-space:nowrap;border:1px solid rgba(255,255,255,0.1);}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* ìŒì„± ë¶ˆê°€ ë°°ë„ˆ */
.no-voice-banner{background:#fff8f0;border:1.5px solid var(--gold);border-radius:10px;padding:10px 14px;font-size:12px;color:var(--ink-mid);margin-bottom:14px;display:none;line-height:1.6;}

@media(max-width:500px){
  .eq-h,.eq-gugu{font-size:36px;} .eq-v{font-size:30px;}
  .prob-inner{padding:16px 18px;} .main{padding:16px 10px 60px;}
}
</style>
</head>
<body>
<div class="toast" id="toast"></div>

<!-- í—¤ë” -->
<header class="header">
  <div class="h-logo">
    <div class="h-icon">ìˆ˜í•™</div>
    <div><div class="h-title">êµ¬ëª¬ìˆ˜í•™ ìŒì„± ì±„ì </div><div class="h-sub">ë§í•˜ê±°ë‚˜ í‚¤íŒ¨ë“œë¡œ ì…ë ¥</div></div>
  </div>
  <div class="h-score">ğŸ¯ <span id="h-score">0 / 0</span></div>
</header>

<main class="main">

  <!-- ìŒì„± ë¶ˆê°€ ë°°ë„ˆ -->
  <div class="no-voice-banner" id="no-voice-banner">
    âš ï¸ <b>ìŒì„± ì¸ì‹ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</b><br>
    ì´ íŒŒì¼ì„ GitHub Pagesì— ì˜¬ë¦¬ê±°ë‚˜, PCì— ì €ì¥ í›„ í¬ë¡¬ìœ¼ë¡œ ì—´ì–´ì£¼ì„¸ìš”.<br>
    ì§€ê¸ˆì€ í•˜ë‹¨ í‚¤íŒ¨ë“œë¡œ ë‹µì„ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  </div>

  <!-- ìŠ¤ì½”ì–´ -->
  <div class="scoreboard">
    <div class="sc-item"><div class="sc-val" id="sc-c" style="color:var(--c);">0</div><div class="sc-lbl">ì •ë‹µ</div></div>
    <div class="sc-div"></div>
    <div class="sc-item"><div class="sc-val" id="sc-w" style="color:var(--a);">0</div><div class="sc-lbl">ì˜¤ë‹µ</div></div>
    <div class="sc-div"></div>
    <div class="sc-item"><div class="sc-val" id="sc-s" style="color:var(--gold);">0</div><div class="sc-lbl">ì—°ì†</div></div>
    <div class="sc-div"></div>
    <div class="sc-bar-wrap">
      <div class="sc-bar-lbl">ì •ë‹µë¥  <span id="sc-pct">0%</span></div>
      <div class="sc-bar"><div class="sc-bar-fill" id="sc-bar" style="width:0%"></div></div>
    </div>
  </div>

  <!-- ìœ í˜• íƒ­ -->
  <div class="type-tabs">
    <div class="type-tab on" onclick="setType(this,'add-h')"><div class="type-tab-icon">â•</div><div class="type-tab-name">ê°€ë¡œ ë§ì…ˆ</div></div>
    <div class="type-tab"    onclick="setType(this,'sub-h')"><div class="type-tab-icon">â–</div><div class="type-tab-name">ê°€ë¡œ ëº„ì…ˆ</div></div>
    <div class="type-tab"    onclick="setType(this,'add-v')"><div class="type-tab-icon">ğŸ“</div><div class="type-tab-name">ì„¸ë¡œ ë§ì…ˆ</div></div>
    <div class="type-tab"    onclick="setType(this,'sub-v')"><div class="type-tab-icon">ğŸ“</div><div class="type-tab-name">ì„¸ë¡œ ëº„ì…ˆ</div></div>
    <div class="type-tab"    onclick="setType(this,'gugu')" ><div class="type-tab-icon">âœ–ï¸</div><div class="type-tab-name">êµ¬êµ¬ë‹¨</div></div>
    <div class="type-tab"    onclick="setType(this,'mul-v')"><div class="type-tab-icon">ğŸ”¢</div><div class="type-tab-name">ì„¸ë¡œ ê³±ì…ˆ</div></div>
    <div class="type-tab"    onclick="setType(this,'div-h')"><div class="type-tab-icon">â—</div><div class="type-tab-name">ê°€ë¡œ ë‚˜ëˆ—ì…ˆ</div></div>
    <div class="type-tab"    onclick="setType(this,'div-v')"><div class="type-tab-icon">ğŸ“Š</div><div class="type-tab-name">ì„¸ë¡œ ë‚˜ëˆ—ì…ˆ</div></div>
  </div>

  <!-- ë¬¸ì œ ì¹´ë“œ -->
  <div class="prob-card" id="prob-card">
    <div class="prob-topbar" id="prob-topbar"></div>
    <div class="prob-inner">
      <div class="prob-meta">
        <span class="prob-badge" id="prob-badge">ê°€ë¡œ ë§ì…ˆ</span>
        <button class="new-btn" onclick="newProblem()">ğŸ”„ ìƒˆ ë¬¸ì œ</button>
        <span class="prob-num" id="prob-num">#1</span>
      </div>
      <div class="eq-wrap" id="eq-wrap"></div>

      <!-- ì…ë ¥ ë°©ì‹ íƒ­ -->
      <div class="input-tabs">
        <div class="input-tab on" id="tab-voice"  onclick="switchInputTab('voice')">ğŸ¤ ìŒì„± ì…ë ¥</div>
        <div class="input-tab"    id="tab-keypad" onclick="switchInputTab('keypad')">ğŸ”¢ í‚¤íŒ¨ë“œ ì…ë ¥</div>
      </div>

      <div class="input-area">
        <!-- â”€â”€ ìŒì„± íŒ¨ë„ â”€â”€ -->
        <div id="panel-voice" style="display:flex;flex-direction:column;align-items:center;gap:12px;width:100%;">
          <div class="voice-box ready" id="voice-box">ğŸ¤ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹µì„ ë§í•˜ì„¸ìš”</div>
          <button class="mic-btn" id="mic-btn" onclick="toggleMic()">ğŸ¤</button>
          <div class="mic-lbl" id="mic-lbl">íƒ­í•˜ì—¬ ìŒì„± ì…ë ¥ ì‹œì‘</div>
        </div>

        <!-- â”€â”€ í‚¤íŒ¨ë“œ íŒ¨ë„ â”€â”€ -->
        <div id="panel-keypad" style="display:none;width:100%;display:none;flex-direction:column;align-items:center;">
          <div class="keypad-wrap">
            <div class="keypad-display" id="kp-display">?</div>
            <div class="keypad-grid">
              <button class="kp-btn" onclick="kpInput('1')">1</button>
              <button class="kp-btn" onclick="kpInput('2')">2</button>
              <button class="kp-btn" onclick="kpInput('3')">3</button>
              <button class="kp-btn" onclick="kpInput('4')">4</button>
              <button class="kp-btn" onclick="kpInput('5')">5</button>
              <button class="kp-btn" onclick="kpInput('6')">6</button>
              <button class="kp-btn" onclick="kpInput('7')">7</button>
              <button class="kp-btn" onclick="kpInput('8')">8</button>
              <button class="kp-btn" onclick="kpInput('9')">9</button>
              <button class="kp-btn zero" onclick="kpInput('0')">0</button>
              <button class="kp-btn del" onclick="kpDel()">âŒ«</button>
            </div>
            <button class="kp-submit" onclick="kpSubmit()">âœ“ ì±„ì í•˜ê¸°</button>
          </div>
        </div>

        <div class="feedback" id="feedback"></div>
      </div>
    </div>
  </div>

  <!-- ì´ë ¥ -->
  <div class="history-wrap">
    <div class="history-hd">ANSWER HISTORY</div>
    <div class="history-list" id="history-list">
      <div style="text-align:center;color:var(--ink-light);font-size:11px;padding:10px;font-family:'DM Mono',monospace;">ë¬¸ì œë¥¼ í’€ë©´ ì´ë ¥ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
    </div>
  </div>
</main>

<script>
// â”€â”€â”€ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let curType = 'add-h';
let curProb = null;
let probCnt = 0;
let sc = {c:0, w:0, s:0};
let answered = false;
let isListening = false;
let recog = null;
let voiceOK = false;
let kpVal = '';
let inputMode = 'voice'; // 'voice' | 'keypad'

const TYPE_CFG = {
  'add-h':{label:'ê°€ë¡œ ë§ì…ˆ', color:'#e8401c', grad:'linear-gradient(90deg,#e8401c,#f5a623)'},
  'sub-h':{label:'ê°€ë¡œ ëº„ì…ˆ', color:'#1a7fd4', grad:'linear-gradient(90deg,#1a7fd4,#7ab8eb)'},
  'add-v':{label:'ì„¸ë¡œ ë§ì…ˆ', color:'#1aad6e', grad:'linear-gradient(90deg,#1aad6e,#76d4a8)'},
  'sub-v':{label:'ì„¸ë¡œ ëº„ì…ˆ', color:'#9b59b6', grad:'linear-gradient(90deg,#9b59b6,#c39bd3)'},
  'gugu' :{label:'êµ¬êµ¬ë‹¨',    color:'#f5a623', grad:'linear-gradient(90deg,#f5a623,#f8d070)'},
  'mul-v':{label:'ì„¸ë¡œ ê³±ì…ˆ', color:'#e8401c', grad:'linear-gradient(90deg,#e8401c,#9b59b6)'},
  'div-h':{label:'ê°€ë¡œ ë‚˜ëˆ—ì…ˆ',color:'#1aad6e',grad:'linear-gradient(90deg,#1aad6e,#1a7fd4)'},
  'div-v':{label:'ì„¸ë¡œ ë‚˜ëˆ—ì…ˆ',color:'#1a7fd4',grad:'linear-gradient(90deg,#1a7fd4,#1aad6e)'},
};

// â”€â”€â”€ ìŒì„± ì¸ì‹ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â˜… í•µì‹¬ ë³€ê²½: continuous=true â†’ ë§ˆì´í¬ë¥¼ í•œ ë²ˆë§Œ ì¼œê³  ê³„ì† ìœ ì§€
// ë¬¸ì œê°€ ë°”ë€Œì–´ë„ ê¶Œí•œ ì¬ìš”ì²­ ì—†ì´ ê³„ì† ë“£ëŠ” ìƒíƒœ ìœ ì§€
function initSpeech(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){
    voiceOK = false;
    document.getElementById('no-voice-banner').style.display = 'block';
    document.getElementById('mic-btn').style.opacity = '0.35';
    document.getElementById('mic-btn').style.pointerEvents = 'none';
    setVoiceBox('error','âš ï¸ ìŒì„± ë¶ˆê°€ â€” í‚¤íŒ¨ë“œ íƒ­ì„ ëˆŒëŸ¬ ì…ë ¥í•˜ì„¸ìš”');
    switchInputTab('keypad');
    return;
  }
  voiceOK = true;
  recog = new SR();
  recog.lang = 'ko-KR';
  recog.continuous = true;      // â˜… í•µì‹¬: ê³„ì† ë“£ê¸° ëª¨ë“œ
  recog.interimResults = true;
  recog.maxAlternatives = 5;

  recog.onstart = function(){
    isListening = true;
    setMicUI(true);
    setVoiceBox('listening','ğŸ¤ ë“£ê³  ìˆì–´ìš”... ë‹µì„ ë§í•˜ì„¸ìš”!');
  };

  recog.onresult = function(e){
    // continuous=true ëª¨ë“œì—ì„œëŠ” resultIndexë¶€í„° ì²˜ë¦¬
    let interim = '', final = '';
    for(let i = e.resultIndex; i < e.results.length; i++){
      const t = e.results[i][0].transcript;
      if(e.results[i].isFinal) final += t;
      else interim += t;
    }

    if(interim) setVoiceBox('interim', 'ğŸ’¬ ' + interim + ' ...');

    if(final && !answered){
      const clean = final.trim();
      const num = parseNum(clean);
      console.log('[ìŒì„±]', clean, 'â†’', num);
      if(num !== null){
        setVoiceBox('interim', '"' + clean + '" â†’ ' + num);
        setTimeout(()=>{ if(!answered) judge(num, clean); }, 200);
      } else {
        // ìˆ«ì ì¸ì‹ ì‹¤íŒ¨ â†’ ê³„ì† ë“£ê¸° ìœ ì§€ (ì¤‘ì§€í•˜ì§€ ì•ŠìŒ)
        setVoiceBox('listening', 'âš ï¸ "' + clean + '" â€” ìˆ«ìë¡œ ë‹¤ì‹œ ë§í•´ì£¼ì„¸ìš”');
        showToast('ì˜ˆ: "ì‹­ì˜¤", "15", "ì‚¼ì‹­ìœ¡"');
      }
    }
  };

  recog.onerror = function(e){
    console.warn('[ìŒì„±ì˜¤ë¥˜]', e.error);
    // no-speechëŠ” ì¡°ìš©í•œ ìƒíƒœì¼ ë¿ â†’ continuous ëª¨ë“œì—ì„œ ìë™ ì¬ê°œë¨
    if(e.error === 'no-speech') return;
    // ê·¸ ì™¸ ì˜¤ë¥˜ë§Œ ì‹¤ì œ ì¤‘ë‹¨
    isListening = false;
    setMicUI(false);
    const msg = {
      'not-allowed':'ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.',
      'audio-capture':'ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”.',
      'network':'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.',
    }[e.error] || ('ì˜¤ë¥˜: ' + e.error);
    setVoiceBox('error', 'âŒ ' + msg);
    showToast(msg);
  };

  // â˜… í•µì‹¬: onendì—ì„œ ìë™ ì¬ì‹œì‘
  // continuous=trueì—¬ë„ ë¸Œë¼ìš°ì €ê°€ ê°„í˜¹ ì¢…ë£Œì‹œí‚´ â†’ ì¦‰ì‹œ ì¬ì‹œì‘
  recog.onend = function(){
    if(isListening){
      // ì‚¬ìš©ìê°€ ì§ì ‘ ë„ì§€ ì•Šì•˜ìœ¼ë©´ ìë™ ì¬ì‹œì‘ (ê¶Œí•œ ì¬ìš”ì²­ ì—†ìŒ)
      try{ recog.start(); }catch(e){ console.log('ì¬ì‹œì‘ ì‹¤íŒ¨:', e); }
    } else {
      setMicUI(false);
      setVoiceBox('ready','ğŸ¤ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìŒì„± ì…ë ¥ ì‹œì‘');
    }
  };
}

// ë§ˆì´í¬ ON/OFF í† ê¸€
function toggleMic(){
  if(!voiceOK){ showToast('í¬ë¡¬ ë¸Œë¼ìš°ì €ì—ì„œ ì—´ì–´ì£¼ì„¸ìš”!'); return; }
  if(isListening){
    // ì‚¬ìš©ìê°€ ì§ì ‘ ë”
    isListening = false;
    try{ recog.stop(); }catch(e){}
    setMicUI(false);
    setVoiceBox('ready','ğŸ¤ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìŒì„± ì…ë ¥ ì‹œì‘');
    showToast('ë§ˆì´í¬ êº¼ì§ ğŸ”‡');
  } else {
    // ë§ˆì´í¬ ì¼¬ â†’ ì´í›„ ë¬¸ì œê°€ ë°”ë€Œì–´ë„ ê³„ì† ìœ ì§€
    isListening = true;
    try{ recog.start(); }
    catch(e){
      setTimeout(()=>{ try{ recog.start(); }catch(e2){ console.error(e2); } }, 300);
    }
    showToast('ë§ˆì´í¬ ì¼œì§ ğŸ¤ â€” ì´ì œ ê³„ì† ë§í•˜ì„¸ìš”!');
  }
}

// ë§ˆì´í¬ ë²„íŠ¼ UIë§Œ ì—…ë°ì´íŠ¸ (isListening ìƒíƒœëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
function setMicUI(on){
  const btn = document.getElementById('mic-btn');
  const lbl = document.getElementById('mic-lbl');
  if(on){
    btn.classList.add('on');
    btn.textContent = 'â¹';
    lbl.textContent = 'ë§ˆì´í¬ ON â€” ê³„ì† ë§í•˜ì„¸ìš” (ëˆ„ë¥´ë©´ ë”)';
  } else {
    btn.classList.remove('on');
    btn.textContent = 'ğŸ¤';
    lbl.textContent = 'íƒ­í•˜ì—¬ ìŒì„± ì…ë ¥ ì‹œì‘';
  }
}

function setVoiceBox(cls, txt){
  const el = document.getElementById('voice-box');
  el.className = 'voice-box ' + (cls || 'ready');
  el.textContent = txt;
}

// â”€â”€â”€ í•œêµ­ì–´ ìˆ«ì íŒŒì‹± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseNum(text){
  const t = text.replace(/\s/g,'').replace(/[,\.]/g,'');
  // ìˆœìˆ˜ ìˆ«ì
  if(/^\d+$/.test(t)) return parseInt(t);
  // ìˆ«ì ì¶”ì¶œ
  const m = t.match(/\d+/g);
  if(m) return parseInt(m.join(''));
  // í•œêµ­ì–´ ìˆ«ì ë§¤í•‘
  const M = {
    'ì˜':0,'ì¼':1,'ì´':2,'ì‚¼':3,'ì‚¬':4,'ì˜¤':5,'ìœ¡':6,'ì¹ ':7,'íŒ”':8,'êµ¬':9,
    'í•˜ë‚˜':1,'ë‘˜':2,'ì…‹':3,'ë„·':4,'ë‹¤ì„¯':5,'ì—¬ì„¯':6,'ì¼ê³±':7,'ì—¬ëŸ':8,'ì•„í™‰':9,
    'ì—´':10,'ìŠ¤ë¬¼':20,'ì„œë¥¸':30,'ë§ˆí”':40,'ì‰°':50,'ì˜ˆìˆœ':60,'ì¼í”':70,'ì—¬ë“ ':80,'ì•„í”':90,
    'ì—´í•˜ë‚˜':11,'ì—´ë‘˜':12,'ì—´ì…‹':13,'ì—´ë„·':14,'ì—´ë‹¤ì„¯':15,
    'ì—´ì—¬ì„¯':16,'ì—´ì¼ê³±':17,'ì—´ì—¬ëŸ':18,'ì—´ì•„í™‰':19,
    'ìŠ¤ë¬¼í•˜ë‚˜':21,'ìŠ¤ë¬¼ë‘˜':22,'ìŠ¤ë¬¼ì…‹':23,'ìŠ¤ë¬¼ë„·':24,'ìŠ¤ë¬¼ë‹¤ì„¯':25,
    'ìŠ¤ë¬¼ì—¬ì„¯':26,'ìŠ¤ë¬¼ì¼ê³±':27,'ìŠ¤ë¬¼ì—¬ëŸ':28,'ìŠ¤ë¬¼ì•„í™‰':29,
    'ì„œë¥¸í•˜ë‚˜':31,'ì„œë¥¸ë‘˜':32,'ì„œë¥¸ì…‹':33,'ì„œë¥¸ë„·':34,'ì„œë¥¸ë‹¤ì„¯':35,
    'ë§ˆí”í•˜ë‚˜':41,'ë§ˆí”ë‘˜':42,'ë§ˆí”ì…‹':43,'ë§ˆí”ë„·':44,'ë§ˆí”ë‹¤ì„¯':45,
  };
  if(M[t] !== undefined) return M[t];
  // í•œìì‹ (ì´ì‹­ì˜¤ = 25)
  let res = 0, tmp = t;
  if(tmp.includes('ë°±')){
    const i=tmp.indexOf('ë°±');
    res += (i>0 ? (M[tmp.slice(0,i)]||1) : 1) * 100;
    tmp = tmp.slice(i+1);
  }
  if(tmp.includes('ì‹­')){
    const i=tmp.indexOf('ì‹­');
    res += (i>0 ? (M[tmp.slice(0,i)]||1) : 1) * 10;
    tmp = tmp.slice(i+1);
  }
  if(tmp) res += (M[tmp]||(/^\d+$/.test(tmp)?parseInt(tmp):0));
  return res > 0 ? res : null;
}

// â”€â”€â”€ í‚¤íŒ¨ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function kpInput(d){
  if(answered) return;
  if(kpVal.length >= 4) return;
  kpVal += d;
  const el = document.getElementById('kp-display');
  el.textContent = kpVal;
  el.className = 'keypad-display has-val';
}
function kpDel(){
  kpVal = kpVal.slice(0,-1);
  const el = document.getElementById('kp-display');
  el.textContent = kpVal || '?';
  el.className = 'keypad-display' + (kpVal ? ' has-val' : '');
}
function kpSubmit(){
  if(!kpVal){ showToast('ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”!'); return; }
  if(answered){ showToast('ì´ë¯¸ ì±„ì ëìŠµë‹ˆë‹¤!'); return; }
  judge(parseInt(kpVal), kpVal);
  kpVal = '';
  document.getElementById('kp-display').textContent = '?';
  document.getElementById('kp-display').className = 'keypad-display';
}

// â”€â”€â”€ ì…ë ¥ íƒ­ ì „í™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchInputTab(mode){
  inputMode = mode;
  document.getElementById('tab-voice').classList.toggle('on', mode==='voice');
  document.getElementById('tab-keypad').classList.toggle('on', mode==='keypad');
  document.getElementById('panel-voice').style.display  = mode==='voice'  ? 'flex' : 'none';
  document.getElementById('panel-keypad').style.display = mode==='keypad' ? 'flex' : 'none';
}

// â”€â”€â”€ ì±„ì  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function judge(userAns, displayTxt){
  if(answered) return;
  answered = true;
  // â˜… ë§ˆì´í¬ëŠ” ë„ì§€ ì•ŠìŒ â†’ ìƒˆ ë¬¸ì œì—ì„œë„ ê¶Œí•œ ì¬ìš”ì²­ ì—†ì´ ë°”ë¡œ ì‚¬ìš©

  const ok = (userAns === curProb.ans);
  const blank = document.getElementById('eq-blank');
  if(blank){ blank.textContent = curProb.ans; blank.classList.add(ok?'correct':'wrong'); }

  // ìŒì„± ë°•ìŠ¤ ì—…ë°ì´íŠ¸
  if(inputMode === 'voice'){
    setVoiceBox(ok?'correct':'wrong',
      ok ? `âœ… "${displayTxt}" â€” ì •ë‹µ!` : `âŒ "${displayTxt}" â€” ì •ë‹µì€ ${curProb.ans}`);
  }

  // í”¼ë“œë°±
  const fb = document.getElementById('feedback');
  fb.className = 'feedback';
  if(ok){
    sc.c++; sc.s++;
    const msgs=['âœ… ì •ë‹µ! ì˜í–ˆì–´ìš”!','ğŸ‰ ë§ì•„ìš”!','â­ í›Œë¥­í•´ìš”!','ğŸŒŸ ì™„ë²½!','ğŸ‘ ì •í™•í•´ìš”!'];
    fb.textContent = sc.s >= 3 ? `ğŸ”¥ ${sc.s}ì—°ì† ì •ë‹µ! ëŒ€ë‹¨í•´ìš”!` : msgs[Math.floor(Math.random()*msgs.length)];
    fb.classList.add(sc.s >= 5 ? 'perfect' : 'correct');
    if(sc.s >= 3) showToast(`ğŸ”¥ ${sc.s}ì—°ì† ì •ë‹µ!`);
  } else {
    sc.w++; sc.s=0;
    fb.textContent = `âŒ ì˜¤ë‹µ! ì •ë‹µì€ ${curProb.ans} ì…ë‹ˆë‹¤.`;
    fb.classList.add('wrong');
  }

  addHistory(ok);
  updateScore();
  setTimeout(()=>newProblem(false), 2500);
}

// â”€â”€â”€ ì´ë ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addHistory(ok){
  const list = document.getElementById('history-list');
  if(list.innerHTML.includes('ë¬¸ì œë¥¼ í’€ë©´')) list.innerHTML='';
  const opStr = {'+':'+','âˆ’':'âˆ’','Ã—':'Ã—','Ã·':'Ã·'}[curProb.op]||'Ã·';
  const eq = curProb.t==='dv' ? `${curProb.n1}Ã·${curProb.n2}` : `${curProb.n1}${opStr}${curProb.n2}`;
  const item = document.createElement('div');
  item.className = 'h-item';
  item.innerHTML = `<span class="h-eq">${eq} = ${curProb.ans}</span><span class="h-my ${ok?'c':'w'}">${ok?'âœ…':'âŒ'}</span>`;
  list.insertBefore(item, list.firstChild);
  if(list.children.length > 20) list.removeChild(list.lastChild);
}

// â”€â”€â”€ ìŠ¤ì½”ì–´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateScore(){
  const total = sc.c + sc.w;
  const pct = total > 0 ? Math.round(sc.c/total*100) : 0;
  document.getElementById('sc-c').textContent  = sc.c;
  document.getElementById('sc-w').textContent  = sc.w;
  document.getElementById('sc-s').textContent  = sc.s;
  document.getElementById('sc-pct').textContent = pct+'%';
  document.getElementById('sc-bar').style.width = pct+'%';
  document.getElementById('h-score').textContent = sc.c+' / '+total;
}

// â”€â”€â”€ ë¬¸ì œ ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rnd(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function gen(type){
  let n1,n2,ans;
  switch(type){
    case 'add-h': n1=rnd(1,50);  n2=rnd(1,50);  ans=n1+n2; return {t:'h',n1,n2,op:'+',ans};
    case 'sub-h': n1=rnd(10,99); n2=rnd(1,n1);  ans=n1-n2; return {t:'h',n1,n2,op:'âˆ’',ans};
    case 'add-v': n1=rnd(10,99); n2=rnd(10,99); ans=n1+n2; return {t:'v',n1,n2,op:'+',ans};
    case 'sub-v': n1=rnd(20,99); n2=rnd(10,n1); ans=n1-n2; return {t:'v',n1,n2,op:'âˆ’',ans};
    case 'gugu':  n1=rnd(2,9);   n2=rnd(1,9);   ans=n1*n2; return {t:'g',n1,n2,op:'Ã—',ans};
    case 'mul-v': n1=rnd(11,99); n2=rnd(2,9);   ans=n1*n2; return {t:'v',n1,n2,op:'Ã—',ans};
    case 'div-h': n2=rnd(2,9); ans=rnd(2,9); n1=n2*ans;    return {t:'h',n1,n2,op:'Ã·',ans};
    case 'div-v': n2=rnd(2,9); ans=rnd(2,9); n1=n2*ans;    return {t:'dv',n1,n2,ans};
  }
}

// â”€â”€â”€ ìˆ˜ì‹ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderEq(p){
  const w = document.getElementById('eq-wrap');
  if(p.t==='h'){
    w.innerHTML=`<div class="eq-h"><span>${p.n1}</span><span class="eq-op">${p.op}</span><span>${p.n2}</span><span class="eq-eq">=</span><span class="eq-blank" id="eq-blank">&nbsp;&nbsp;&nbsp;</span></div>`;
  } else if(p.t==='v'){
    w.innerHTML=`<div class="eq-v"><div>${p.n1}</div><div><span class="eq-v-op">${p.op}</span> ${p.n2}</div><div class="eq-v-line"></div><div><span class="eq-blank" id="eq-blank" style="font-size:40px;">&nbsp;&nbsp;&nbsp;&nbsp;</span></div></div>`;
  } else if(p.t==='g'){
    w.innerHTML=`<div class="eq-gugu"><span>${p.n1}</span><span class="eq-op">Ã—</span><span>${p.n2}</span><span class="eq-eq">=</span><span class="eq-blank" id="eq-blank">&nbsp;&nbsp;&nbsp;</span></div>`;
  } else if(p.t==='dv'){
    w.innerHTML=`<div class="eq-dv"><span class="div-divisor">${p.n2}</span><div class="div-bracket"><div class="div-q"><span class="eq-blank" id="eq-blank" style="font-size:32px;min-width:48px;">&nbsp;&nbsp;</span></div><div>${p.n1}</div></div></div>`;
  }
}

// â”€â”€â”€ ìƒˆ ë¬¸ì œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function newProblem(reset=true){
  probCnt++; answered=false; kpVal='';
  curProb = gen(curType);
  renderEq(curProb);
  const cfg = TYPE_CFG[curType];
  document.getElementById('prob-topbar').style.background = cfg.grad;
  document.getElementById('prob-badge').textContent  = cfg.label;
  document.getElementById('prob-badge').style.background = cfg.color+'22';
  document.getElementById('prob-badge').style.color = cfg.color;
  document.getElementById('prob-num').textContent   = '#'+probCnt;
  document.getElementById('feedback').className     = 'feedback';
  document.getElementById('kp-display').textContent = '?';
  document.getElementById('kp-display').className   = 'keypad-display';
  // â˜… ë§ˆì´í¬ê°€ ì¼œì ¸ ìˆìœ¼ë©´ "ë“£ëŠ” ì¤‘" ìƒíƒœë¡œ ë°”ë¡œ ë³µì›
  if(voiceOK && isListening){
    setVoiceBox('listening','ğŸ¤ ë“£ê³  ìˆì–´ìš”... ë‹µì„ ë§í•˜ì„¸ìš”!');
    setMicUI(true);
  } else {
    setVoiceBox('ready','ğŸ¤ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹µì„ ë§í•˜ì„¸ìš”');
  }
  // ì¹´ë“œ ì¬ì• ë‹ˆë©”ì´ì…˜
  const c=document.getElementById('prob-card');
  c.style.animation='none'; void c.offsetWidth; c.style.animation='slideIn 0.3s ease';
}

function setType(el, type){
  curType=type;
  document.querySelectorAll('.type-tab').forEach(t=>t.classList.remove('on'));
  el.classList.add('on');
  newProblem();
  showToast(TYPE_CFG[type].label+' ë¬¸ì œ!');
}

function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  clearTimeout(t._t); t._t=setTimeout(()=>t.classList.remove('show'),2200);
}

// â”€â”€â”€ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initSpeech();
switchInputTab('voice');
newProblem();
</script>
</body>
</html>
